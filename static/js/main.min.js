let config=null
let feedbackPrompts={resubmit_prompt:'è¯·ç«‹å³è°ƒç”¨ interactive_feedback å·¥å…·',prompt_suffix:'\nè¯·ç§¯æè°ƒç”¨ interactive_feedback å·¥å…·'}
async function loadFeedbackPrompts(){try{const response=await fetch('/api/get-feedback-prompts')
if(response.ok){const data=await response.json()
if(data.status==='success'&&data.config){feedbackPrompts={resubmit_prompt:data.config.resubmit_prompt||feedbackPrompts.resubmit_prompt,prompt_suffix:data.config.prompt_suffix||feedbackPrompts.prompt_suffix}
console.log('åé¦ˆæç¤ºè¯­é…ç½®å·²åŠ è½½')}}}catch(error){console.warn('åŠ è½½åé¦ˆæç¤ºè¯­é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:',error)}}
function initMarkedConfig(){if(typeof marked==='undefined'){console.warn('marked.js æœªåŠ è½½ï¼Œå°†ä½¿ç”¨æœåŠ¡ç«¯æ¸²æŸ“çš„ HTML')
return false}
function highlightCode(code,lang){if(typeof Prism!=='undefined'&&lang&&Prism.languages[lang]){try{return Prism.highlight(code,Prism.languages[lang],lang)}catch(e){console.warn('Prism é«˜äº®å¤±è´¥:',e)}}
return code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
const renderer={code({text,lang,escaped}){const language=lang||'plaintext'
const langClass=`language-${language}`
const highlighted=highlightCode(text,language)
return`<pre class="${langClass}"><code class="${langClass}">${highlighted}</code></pre>`}}
marked.use({gfm:true,breaks:true,renderer:renderer})
console.log('marked.js é…ç½®å·²åˆå§‹åŒ–')
return true}
let markedInitialized=false
function renderMarkdownContent(element,content,isMarkdown=false){requestAnimationFrame(()=>{if(!content){element.textContent='åŠ è½½ä¸­...'
return}
if(!markedInitialized){markedInitialized=initMarkedConfig()}
let htmlContent=content
if(isMarkdown&&markedInitialized&&typeof marked!=='undefined'){try{htmlContent=marked.parse(content)
console.log('âœ… ä½¿ç”¨ marked.js æ¸²æŸ“ Markdown')}catch(e){console.warn('marked.js æ¸²æŸ“å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å†…å®¹:',e)}}
const fragment=document.createDocumentFragment()
const tempDiv=document.createElement('div')
tempDiv.innerHTML=htmlContent
while(tempDiv.firstChild){fragment.appendChild(tempDiv.firstChild)}
element.innerHTML=''
element.appendChild(fragment)
if(typeof Prism!=='undefined'){Prism.highlightAllUnder(element)}
processCodeBlocks(element)
processStrikethrough(element)
if(window.loadMathJaxIfNeeded&&typeof window.loadMathJaxIfNeeded==='function'){window.loadMathJaxIfNeeded(element,content)}else if(window.MathJax&&window.MathJax.typesetPromise){window.MathJax.typesetPromise([element]).catch(err=>{console.warn('MathJax æ¸²æŸ“å¤±è´¥:',err)})}})}
function renderMarkdown(element,markdownText){renderMarkdownContent(element,markdownText,true)}
function processCodeBlocks(container){const codeBlocks=container.querySelectorAll('pre')
codeBlocks.forEach(pre=>{if((pre.parentElement&&pre.parentElement.classList.contains('code-block-container'))||(pre.parentElement&&pre.parentElement.classList.contains('codehilite'))){if(pre.parentElement.classList.contains('codehilite')){const existingToolbar=pre.parentElement.querySelector('.code-toolbar')
if(!existingToolbar){const toolbar=document.createElement('div')
toolbar.className='code-toolbar'
let language='text'
const parentClasses=pre.parentElement.className
const langMatch=parentClasses.match(/language-(\w+)/)
if(langMatch){language=langMatch[1]}
if(language!=='text'){const langLabel=document.createElement('span')
langLabel.className='language-label'
langLabel.textContent=language.toUpperCase()
toolbar.appendChild(langLabel)}
const copyButton=DOMSecurity.createCopyButton(pre.textContent||'')
toolbar.appendChild(copyButton)
pre.parentElement.appendChild(toolbar)}}
return}
const codeContainer=document.createElement('div')
codeContainer.className='code-block-container'
pre.parentNode.insertBefore(codeContainer,pre)
codeContainer.appendChild(pre)
const codeElement=pre.querySelector('code')
let language='text'
if(codeElement&&codeElement.className){const langMatch=codeElement.className.match(/language-(\w+)/)
if(langMatch){language=langMatch[1]}}
const toolbar=document.createElement('div')
toolbar.className='code-toolbar'
if(language!=='text'){const langLabel=document.createElement('span')
langLabel.className='language-label'
langLabel.textContent=language.toUpperCase()
toolbar.appendChild(langLabel)}
const copyButton=DOMSecurity.createCopyButton(pre.textContent||'')
toolbar.appendChild(copyButton)
codeContainer.appendChild(toolbar)})}
async function copyCodeToClipboard(preElement,button){try{const codeElement=preElement.querySelector('code')
const textToCopy=codeElement?codeElement.textContent:preElement.textContent
await navigator.clipboard.writeText(textToCopy)
const originalText=button.innerHTML
button.innerHTML='âœ… å·²å¤åˆ¶'
button.classList.add('copied')
setTimeout(()=>{button.innerHTML=originalText
button.classList.remove('copied')},2000)}catch(err){console.error('å¤åˆ¶å¤±è´¥:',err)
const originalText=button.innerHTML
button.innerHTML='âŒ å¤åˆ¶å¤±è´¥'
setTimeout(()=>{button.innerHTML=originalText},2000)}}
function processStrikethrough(container){const walker=document.createTreeWalker(container,NodeFilter.SHOW_TEXT,{acceptNode:function(node){const parent=node.parentElement
if(parent&&(parent.tagName==='CODE'||parent.tagName==='PRE'||parent.tagName==='SCRIPT'||parent.tagName==='STYLE'||parent.closest('pre, code, script, style'))){return NodeFilter.FILTER_REJECT}
return NodeFilter.FILTER_ACCEPT}})
const textNodes=[]
let node
while((node=walker.nextNode())){textNodes.push(node)}
textNodes.forEach(textNode=>{const text=textNode.textContent
const strikethroughRegex=/~~([^~\n]+?)~~/g
if(strikethroughRegex.test(text)){const newHTML=text.replace(strikethroughRegex,'<del>$1</del>')
const tempDiv=document.createElement('div')
tempDiv.innerHTML=newHTML
const fragment=document.createDocumentFragment()
while(tempDiv.firstChild){fragment.appendChild(tempDiv.firstChild)}
textNode.parentNode.replaceChild(fragment,textNode)}})}
function updateTaskIdDisplay(taskId){const taskIdContainer=document.getElementById('task-id-container')
const taskIdText=document.getElementById('task-id-text')
if(taskId&&taskId.trim()){taskIdText.textContent=taskId
taskIdContainer.classList.remove('hidden')}else{taskIdContainer.classList.add('hidden')}}
let countdownTimer=null
let remainingSeconds=0
let currentTasks=[]
let activeTaskId=null
let taskCountdowns={}
let tasksPollingTimer=null
let taskTextareaContents={}
let taskOptionsStates={}
let taskImages={}
function startCountdown(timeoutSeconds){if(countdownTimer){clearInterval(countdownTimer)
countdownTimer=null}
remainingSeconds=timeoutSeconds
updateCountdownDisplay()
countdownTimer=setInterval(()=>{remainingSeconds--
if(remainingSeconds<=0){autoSubmitFeedback()}else{updateCountdownDisplay()}},1000)}
function updateCountdownDisplay(){const countdownContainer=document.getElementById('countdown-container')
const countdownText=document.getElementById('countdown-text')
if(remainingSeconds>0){countdownText.textContent=`${remainingSeconds}ç§’åè‡ªåŠ¨é‡æ–°è¯¢é—®`
countdownContainer.classList.remove('hidden')}else{countdownContainer.classList.add('hidden')}}
function stopCountdown(){if(countdownTimer){clearInterval(countdownTimer)
countdownTimer=null}
const countdownContainer=document.getElementById('countdown-container')
countdownContainer.classList.add('hidden')}
function getSelectedOptions(){const selectedOptions=[]
if(config&&config.predefined_options){config.predefined_options.forEach((option,index)=>{const checkbox=document.getElementById(`option-${index}`)
if(checkbox&&checkbox.checked){selectedOptions.push(option)}})}
return selectedOptions}
async function autoSubmitFeedback(){try{stopCountdown()
const feedbackTextarea=document.getElementById('feedback-text')
const userInput=feedbackTextarea?feedbackTextarea.value.trim():''
if(userInput){try{await navigator.clipboard.writeText(userInput)
console.log('[è‡ªåŠ¨æäº¤] ç”¨æˆ·è¾“å…¥å·²å¤‡ä»½åˆ°å‰ªè´´æ¿')}catch(err){console.warn('[è‡ªåŠ¨æäº¤] æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿:',err)}}
const defaultMessage=feedbackPrompts.resubmit_prompt
const formData=new FormData()
formData.append('feedback_text',defaultMessage)
formData.append('selected_options',JSON.stringify([]))
const response=await fetch('/api/submit',{method:'POST',body:formData})
if(response.ok){console.log('[è‡ªåŠ¨æäº¤] å·²è‡ªåŠ¨æäº¤é»˜è®¤åé¦ˆä»¥ä¿æŒä¼šè¯æ´»è·ƒ')
if(activeTaskId){if(taskTextareaContents[activeTaskId]!==undefined){delete taskTextareaContents[activeTaskId]
console.log(`âœ… [è‡ªåŠ¨æäº¤] å·²æ¸…é™¤ä»»åŠ¡ ${activeTaskId} ä¿å­˜çš„ textarea å†…å®¹`)}
if(taskOptionsStates[activeTaskId]!==undefined){delete taskOptionsStates[activeTaskId]
console.log(`âœ… [è‡ªåŠ¨æäº¤] å·²æ¸…é™¤ä»»åŠ¡ ${activeTaskId} ä¿å­˜çš„é€‰é¡¹å‹¾é€‰çŠ¶æ€`)}
if(taskImages[activeTaskId]!==undefined){delete taskImages[activeTaskId]
console.log(`âœ… [è‡ªåŠ¨æäº¤] å·²æ¸…é™¤ä»»åŠ¡ ${activeTaskId} ä¿å­˜çš„å›¾ç‰‡åˆ—è¡¨`)}}
if(feedbackTextarea){feedbackTextarea.value=''}
document.querySelectorAll('input[type="checkbox"]').forEach(cb=>(cb.checked=false))
clearAllImages()
console.log('[è‡ªåŠ¨æäº¤] é‡æ–°åŠ è½½é…ç½®...')
await loadConfig(false)
if(typeof window.multiTaskModule!=='undefined'&&window.multiTaskModule.refreshTasksList){await window.multiTaskModule.refreshTasksList()
console.log('[è‡ªåŠ¨æäº¤] ä»»åŠ¡åˆ—è¡¨å·²åŒæ­¥æ›´æ–°')}}else{console.error('[è‡ªåŠ¨æäº¤] æäº¤å¤±è´¥ï¼ŒHTTPçŠ¶æ€:',response.status)}}catch(error){console.error('[è‡ªåŠ¨æäº¤] è‡ªåŠ¨æäº¤å¤±è´¥:',error)}}
async function loadConfig(shouldNotify=true){try{const response=await fetch('/api/config')
config=await response.json()
if(!config.has_content){showNoContentPage()
return}
showContentPage()
if(shouldNotify){requestAnimationFrame(()=>{requestAnimationFrame(()=>{const contentContainer=document.getElementById('content-container')
const noContentContainer=document.getElementById('no-content-container')
const isShowingContent=contentContainer&&!contentContainer.classList.contains('hidden')&&noContentContainer&&noContentContainer.classList.contains('hidden')
if(!isShowingContent){console.warn('âš ï¸  é¡µé¢çŠ¶æ€ä¸ä¸€è‡´ï¼Œè·³è¿‡é€šçŸ¥ï¼ˆå†…å®¹é¡µé¢æœªæ˜¾ç¤ºï¼‰')
return}
const taskId=config.task_id||'unknown'
const truncatedId=taskId.substring(Math.max(0,taskId.length-10))
try{notificationManager.sendNotification('AI Intervention Agent',`æ–°ä»»åŠ¡ ${truncatedId}: è¯·æŸ¥çœ‹å¹¶å›å¤`,{tag:`task-${taskId}`,requireInteraction:true,data:{taskId:taskId},onClick:()=>{window.focus()
if(typeof switchToTask==='function'){switchToTask(taskId)}
const textarea=document.getElementById('feedback-text')
if(textarea){textarea.focus()}}}).catch(error=>{console.warn('å‘é€æ–°å†…å®¹é€šçŸ¥å¤±è´¥:',error)})}catch(error){console.warn('é€šçŸ¥åŠŸèƒ½ä¸å¯ç”¨:',error)}})})}
updateTaskIdDisplay(config.task_id)
const descriptionElement=document.getElementById('description')
renderMarkdownContent(descriptionElement,config.prompt,true)
if(config.predefined_options&&config.predefined_options.length>0){const optionsContainer=document.getElementById('options-container')
const separator=document.getElementById('separator')
optionsContainer.innerHTML=''
config.predefined_options.forEach((option,index)=>{const optionDiv=document.createElement('div')
optionDiv.className='option-item'
const checkbox=document.createElement('input')
checkbox.type='checkbox'
checkbox.id=`option-${index}`
checkbox.value=option
const label=document.createElement('label')
label.htmlFor=`option-${index}`
label.textContent=option
optionDiv.appendChild(checkbox)
optionDiv.appendChild(label)
optionsContainer.appendChild(optionDiv)})
optionsContainer.classList.remove('hidden')
optionsContainer.classList.add('visible')
separator.classList.remove('hidden')
separator.classList.add('visible')}
const countdownTime=config.remaining_time??config.auto_resubmit_timeout
if(countdownTime&&countdownTime>0){console.log(`[å€’è®¡æ—¶] å¯åŠ¨è‡ªåŠ¨é‡è°ƒå€’è®¡æ—¶: ${countdownTime}ç§’`)
startCountdown(countdownTime)}}catch(error){console.error('åŠ è½½é…ç½®å¤±è´¥:',error)
showStatus('åŠ è½½é…ç½®å¤±è´¥','error')
throw error}}
function showNoContentPage(){const contentContainer=document.getElementById('content-container')
const noContentContainer=document.getElementById('no-content-container')
contentContainer.classList.add('hidden')
contentContainer.classList.remove('visible')
noContentContainer.classList.remove('hidden')
noContentContainer.classList.add('flex-visible')
document.body.classList.add('no-content-mode')
const descriptionElement=document.getElementById('description')
if(descriptionElement){descriptionElement.textContent=''}
stopCountdown()
if(config){const noContentButtons=document.getElementById('no-content-buttons')
noContentButtons.classList.remove('hidden')
noContentButtons.classList.add('visible')}}
function showContentPage(){const contentContainer=document.getElementById('content-container')
const noContentContainer=document.getElementById('no-content-container')
contentContainer.classList.remove('hidden')
contentContainer.classList.add('visible')
noContentContainer.classList.add('hidden')
noContentContainer.classList.remove('flex-visible')
document.body.classList.remove('no-content-mode')
enableSubmitButton()
if(typeof window.multiTaskModule!=='undefined'&&typeof window.multiTaskModule.startTasksPolling==='function'){window.multiTaskModule.startTasksPolling()
console.log('âœ… ä»»åŠ¡è½®è¯¢å·²é‡æ–°å¯åŠ¨ (showContentPage)')}}
function disableSubmitButton(){const submitBtn=document.getElementById('submit-btn')
const insertBtn=document.getElementById('insert-code-btn')
const feedbackText=document.getElementById('feedback-text')
if(submitBtn){submitBtn.disabled=true
submitBtn.classList.add('btn-disabled')
submitBtn.classList.remove('btn-enabled','btn-primary-enabled')}
if(insertBtn){insertBtn.disabled=true
insertBtn.classList.add('btn-disabled')
insertBtn.classList.remove('btn-enabled','btn-secondary-enabled')}
if(feedbackText){feedbackText.disabled=true
feedbackText.classList.add('textarea-disabled')
feedbackText.classList.remove('textarea-enabled')}}
function enableSubmitButton(){const submitBtn=document.getElementById('submit-btn')
const insertBtn=document.getElementById('insert-code-btn')
const feedbackText=document.getElementById('feedback-text')
if(submitBtn){submitBtn.disabled=false
submitBtn.classList.remove('btn-disabled')
submitBtn.classList.add('btn-enabled','btn-primary-enabled')}
if(insertBtn){insertBtn.disabled=false
insertBtn.classList.remove('btn-disabled')
insertBtn.classList.add('btn-enabled','btn-secondary-enabled')}
if(feedbackText){feedbackText.disabled=false
feedbackText.classList.remove('textarea-disabled')
feedbackText.classList.add('textarea-enabled')}}
function showStatus(message,type){const noContentContainer=document.getElementById('no-content-container')
const isNoContentPage=noContentContainer.classList.contains('flex-visible')
const statusElement=isNoContentPage?document.getElementById('no-content-status-message'):document.getElementById('status-message')
statusElement.textContent=message
statusElement.className=`status-message status-${type}`
statusElement.classList.remove('hidden')
statusElement.classList.add('visible')
if(type==='success'){setTimeout(()=>{statusElement.classList.add('hidden')
statusElement.classList.remove('visible')},3000)}}
async function insertCodeFromClipboard(){try{const text=await navigator.clipboard.readText()
if(text){const textarea=document.getElementById('feedback-text')
const cursorPos=textarea.selectionStart
const currentText=textarea.value
const textBefore=currentText.substring(0,cursorPos)
const textAfter=currentText.substring(cursorPos)
let codeBlock=`\n\`\`\`\n${text}\n\`\`\``
if(cursorPos===0){codeBlock=`\`\`\`\n${text}\n\`\`\``}
textarea.value=textBefore+codeBlock+textAfter
const newCursorPos=textBefore.length+codeBlock.length
textarea.setSelectionRange(newCursorPos,newCursorPos)
textarea.focus()
showStatus('ä»£ç å·²æ’å…¥','success')}else{showStatus('å‰ªè´´æ¿ä¸ºç©º','error')}}catch(error){console.error('è¯»å–å‰ªè´´æ¿å¤±è´¥:',error)
showStatus('æ— æ³•è¯»å–å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´ä»£ç ','error')}}
async function submitFeedback(){stopCountdown()
const feedbackText=document.getElementById('feedback-text').value.trim()
const selectedOptions=[]
if(config&&config.predefined_options){config.predefined_options.forEach((option,index)=>{const checkbox=document.getElementById(`option-${index}`)
if(checkbox&&checkbox.checked){selectedOptions.push(option)}})}
if(!feedbackText&&selectedOptions.length===0&&selectedImages.length===0){showStatus('è¯·è¾“å…¥åé¦ˆå†…å®¹ã€é€‰æ‹©é¢„å®šä¹‰é€‰é¡¹æˆ–ä¸Šä¼ å›¾ç‰‡','error')
return}
try{const submitBtn=document.getElementById('submit-btn')
submitBtn.disabled=true
submitBtn.textContent='æäº¤ä¸­...'
const additionalText='\nè¯·ç§¯æè°ƒç”¨interactive_feedbackå·¥å…·'
const finalFeedbackText=feedbackText?feedbackText+additionalText:additionalText
const formData=new FormData()
formData.append('feedback_text',finalFeedbackText)
formData.append('selected_options',JSON.stringify(selectedOptions))
selectedImages.forEach((img,index)=>{if(img.file){formData.append(`image_${index}`,img.file)}})
const response=await fetch('/api/submit',{method:'POST',body:formData})
const result=await response.json()
if(response.ok){showStatus(result.message,'success')
if(config&&config.task_id){const taskId=config.task_id
notificationManager.cancelNotification(`task-${taskId}`)
console.log(`âœ… å·²å–æ¶ˆä»»åŠ¡ ${taskId} çš„é€šçŸ¥`)}
document.getElementById('feedback-text').value=''
document.querySelectorAll('input[type="checkbox"]').forEach(cb=>(cb.checked=false))
clearAllImages()
if(activeTaskId){if(taskTextareaContents[activeTaskId]!==undefined){delete taskTextareaContents[activeTaskId]
console.log(`âœ… å·²æ¸…é™¤ä»»åŠ¡ ${activeTaskId} ä¿å­˜çš„ textarea å†…å®¹`)}
if(taskOptionsStates[activeTaskId]!==undefined){delete taskOptionsStates[activeTaskId]
console.log(`âœ… å·²æ¸…é™¤ä»»åŠ¡ ${activeTaskId} ä¿å­˜çš„é€‰é¡¹å‹¾é€‰çŠ¶æ€`)}
if(taskImages[activeTaskId]!==undefined){delete taskImages[activeTaskId]
console.log(`âœ… å·²æ¸…é™¤ä»»åŠ¡ ${activeTaskId} ä¿å­˜çš„å›¾ç‰‡åˆ—è¡¨`)}}
console.log('åé¦ˆæäº¤æˆåŠŸï¼Œé‡æ–°åŠ è½½é…ç½®...')
await loadConfig(false)
if(typeof window.multiTaskModule!=='undefined'&&window.multiTaskModule.refreshTasksList){await window.multiTaskModule.refreshTasksList()
console.log('ä»»åŠ¡åˆ—è¡¨å·²åŒæ­¥æ›´æ–°')}}else{showStatus(result.message||'æäº¤å¤±è´¥','error')}}catch(error){console.error('æäº¤å¤±è´¥:',error)
showStatus('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•','error')}finally{const submitBtn=document.getElementById('submit-btn')
submitBtn.disabled=false
submitBtn.textContent='ğŸš€ æäº¤åé¦ˆ'}}
async function closeInterface(){try{showStatus('æ­£åœ¨å…³é—­æœåŠ¡...','info')
stopContentPolling()
const response=await fetch('/api/close',{method:'POST',headers:{'Content-Type':'application/json'}})
const result=await response.json()
if(response.ok){showStatus('æœåŠ¡å·²å…³é—­ï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...','success')}else{showStatus('å…³é—­å¤±è´¥ï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...','error')}}catch(error){console.error('å…³é—­ç•Œé¢å¤±è´¥:',error)
showStatus('å…³é—­ç•Œé¢å¤±è´¥ï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...','error')}
setTimeout(()=>{refreshPageSafely()},2000)}
function refreshPageSafely(){console.log('æ­£åœ¨åˆ·æ–°é¡µé¢...')
try{window.location.reload()}catch(reloadError){console.error('é¡µé¢åˆ·æ–°å¤±è´¥:',reloadError)
try{window.location.href=window.location.origin}catch(redirectError){console.error('é¡µé¢è·³è½¬å¤±è´¥:',redirectError)
try{window.location.href='about:blank'}catch(blankError){console.error('æ‰€æœ‰é¡µé¢æ“ä½œéƒ½å¤±è´¥:',blankError)}}}}
let pollingTimeout=null
let currentPollingInterval=2000
const basePollingInterval=2000
const maxPollingInterval=15000
const rateLimitInterval=5000
let consecutiveErrors=0
let lastErrorType=null
function startContentPolling(){if(pollingTimeout){console.log('è½®è¯¢å·²ç»åœ¨è¿è¡Œï¼Œè·³è¿‡å¯åŠ¨')
return}
console.log('å¼€å§‹å¯åŠ¨å†…å®¹è½®è¯¢...')
scheduleNextPoll()}
function scheduleNextPoll(){pollingTimeout=setTimeout(async()=>{try{const response=await fetch('/api/config')
if(response.status===429){console.warn('é‡åˆ°é€Ÿç‡é™åˆ¶ï¼Œä½¿ç”¨é€‚åº¦é—´éš”')
handlePollingError('rate_limit')
return}
const newConfig=await response.json()
consecutiveErrors=0
lastErrorType=null
currentPollingInterval=basePollingInterval
const currentHasContent=config?config.has_content:false
const newHasContent=newConfig.has_content
console.log('è½®è¯¢æ£€æŸ¥ - å½“å‰çŠ¶æ€:',currentHasContent,'æ–°çŠ¶æ€:',newHasContent)
console.log('å½“å‰æç¤º:',config?config.prompt?.substring(0,30):'null')
console.log('æ–°æç¤º:',newConfig.prompt?.substring(0,30))
if(newHasContent&&!currentHasContent){console.log('âœ… æ£€æµ‹åˆ°æ–°å†…å®¹ï¼Œæ›´æ–°é¡µé¢')
const oldConfig=config
config=newConfig
showContentPage()
updatePageContent(oldConfig)
showStatus('æ”¶åˆ°æ–°çš„åé¦ˆè¯·æ±‚ï¼','success')
requestAnimationFrame(()=>{requestAnimationFrame(()=>{const contentContainer=document.getElementById('content-container')
const noContentContainer=document.getElementById('no-content-container')
const isShowingContent=contentContainer&&!contentContainer.classList.contains('hidden')&&noContentContainer&&noContentContainer.classList.contains('hidden')
if(!isShowingContent){console.warn('âš ï¸  é¡µé¢çŠ¶æ€ä¸ä¸€è‡´ï¼Œè·³è¿‡é€šçŸ¥ï¼ˆå†…å®¹é¡µé¢æœªæ˜¾ç¤ºï¼‰')
return}
const taskId=config.task_id||'unknown'
const truncatedId=taskId.substring(Math.max(0,taskId.length-10))
try{notificationManager.sendNotification('AI Intervention Agent',`æ–°ä»»åŠ¡ ${truncatedId}: è¯·æŸ¥çœ‹å¹¶å›å¤`,{tag:`task-${taskId}`,requireInteraction:true,data:{taskId:taskId},onClick:()=>{window.focus()
if(typeof switchToTask==='function'){switchToTask(taskId)}
const textarea=document.getElementById('feedback-text')
if(textarea){textarea.focus()}}}).catch(error=>{console.warn('å‘é€æ–°å†…å®¹é€šçŸ¥å¤±è´¥:',error)})}catch(error){console.warn('é€šçŸ¥åŠŸèƒ½ä¸å¯ç”¨:',error)}})})}else if(!newHasContent&&currentHasContent){console.log('ğŸ“ å†…å®¹å·²æ¸…ç©ºï¼Œæ˜¾ç¤ºæ— å†…å®¹é¡µé¢')
config=newConfig
showNoContentPage()
disableSubmitButton()}else if(newHasContent&&currentHasContent){const promptChanged=newConfig.prompt!==(config?config.prompt:'')
const optionsChanged=JSON.stringify(newConfig.predefined_options)!==JSON.stringify(config?config.predefined_options:[])
if(promptChanged||optionsChanged){console.log('ğŸ”„ æ£€æµ‹åˆ°å†…å®¹æ›´æ–°ï¼Œåˆ·æ–°é¡µé¢')
const oldConfig=config
config=newConfig
updatePageContent(oldConfig)
showStatus('å†…å®¹å·²æ›´æ–°ï¼','success')}}else{config=newConfig}
scheduleNextPoll()}catch(error){console.error('è½®è¯¢é”™è¯¯:',error)
handlePollingError('network_error')}},currentPollingInterval)
console.log(`å†…å®¹è½®è¯¢å·²å®‰æ’ï¼Œé—´éš”${currentPollingInterval}ms`)}
function handlePollingError(errorType){consecutiveErrors++
lastErrorType=errorType
if(errorType==='rate_limit'){currentPollingInterval=rateLimitInterval
console.log(`é‡åˆ°é€Ÿç‡é™åˆ¶ï¼Œè°ƒæ•´é—´éš”åˆ°${currentPollingInterval}ms`)}else if(errorType==='network_error'&&consecutiveErrors>1){currentPollingInterval=Math.min(basePollingInterval*Math.pow(1.5,consecutiveErrors),maxPollingInterval)
console.log(`ç½‘ç»œé”™è¯¯ï¼Œæ¸©å’Œé€€é¿åˆ°${currentPollingInterval}ms`)}else{console.log(`é¦–æ¬¡é”™è¯¯æˆ–è½»å¾®é”™è¯¯ï¼Œä¿æŒ${currentPollingInterval}msé—´éš”`)}
scheduleNextPoll()}
function stopContentPolling(){if(pollingTimeout){clearTimeout(pollingTimeout)
pollingTimeout=null}
currentPollingInterval=basePollingInterval
consecutiveErrors=0
lastErrorType=null}
function updatePageContent(oldConfig=null){if(!config)return
const feedbackTextarea=document.getElementById('feedback-text')
const currentTextareaValue=feedbackTextarea?feedbackTextarea.value:''
console.log(`ğŸ’¾ ä¿å­˜å½“å‰ textarea å†…å®¹: ${currentTextareaValue.length} ä¸ªå­—ç¬¦`)
updateTaskIdDisplay(config.task_id)
const descriptionElement=document.getElementById('description')
if(descriptionElement){renderMarkdownContent(descriptionElement,config.prompt,true)}
const optionsContainer=document.getElementById('options-container')
if(optionsContainer){const selectedStates=[]
const configForSaving=oldConfig||config
if(configForSaving&&configForSaving.predefined_options){configForSaving.predefined_options.forEach((option,index)=>{const checkbox=document.getElementById(`option-${index}`)
selectedStates[index]=checkbox?checkbox.checked:false})}
DOMSecurity.clearContent(optionsContainer)
if(config.predefined_options&&config.predefined_options.length>0){config.predefined_options.forEach((option,index)=>{const optionDiv=DOMSecurity.createCheckboxOption(`option-${index}`,option,option)
optionsContainer.appendChild(optionDiv)
const checkbox=document.getElementById(`option-${index}`)
if(checkbox&&selectedStates[index]){checkbox.checked=true}})
optionsContainer.classList.remove('hidden')
optionsContainer.classList.add('visible')
document.getElementById('separator').classList.remove('hidden')
document.getElementById('separator').classList.add('visible')}else{optionsContainer.classList.add('hidden')
optionsContainer.classList.remove('visible')
document.getElementById('separator').classList.add('hidden')
document.getElementById('separator').classList.remove('visible')}}
if(feedbackTextarea){feedbackTextarea.value=currentTextareaValue
if(currentTextareaValue.length>0){console.log(`â™»ï¸ å·²æ¢å¤ textarea å†…å®¹: ${currentTextareaValue.length} ä¸ªå­—ç¬¦`)}}
const countdownTime=config.remaining_time??config.auto_resubmit_timeout
if(countdownTime&&countdownTime>0){console.log(`[å€’è®¡æ—¶] å†…å®¹æ›´æ–°ï¼Œé‡æ–°å¯åŠ¨å€’è®¡æ—¶: ${countdownTime}ç§’`)
startCountdown(countdownTime)}else{stopCountdown()}}
let selectedImages=[]
class AudioCacheManager{constructor(){this.cache=new Map()
this.accessTimes=new Map()
this.maxCacheSize=10
this.maxCacheAge=30*60*1000
this.cleanupInterval=5*60*1000
this.cleanupTimer=null
this.startPeriodicCleanup()}
set(name,audioBuffer){if(this.cache.size>=this.maxCacheSize&&!this.cache.has(name)){this.evictLRU()}
this.cache.set(name,audioBuffer)
this.accessTimes.set(name,Date.now())
console.log(`éŸ³é¢‘ç¼“å­˜å·²æ·»åŠ : ${name} (ç¼“å­˜å¤§å°: ${this.cache.size}/${this.maxCacheSize})`)}
get(name){if(this.cache.has(name)){this.accessTimes.set(name,Date.now())
const audioBuffer=this.cache.get(name)
this.cache.delete(name)
this.cache.set(name,audioBuffer)
return audioBuffer}
return null}
has(name){return this.cache.has(name)}
evictLRU(){const firstKey=this.cache.keys().next().value
if(firstKey){this.cache.delete(firstKey)
this.accessTimes.delete(firstKey)
console.log(`LRUæ¸…ç†ï¼šç§»é™¤éŸ³é¢‘ç¼“å­˜ ${firstKey}`)}}
cleanupExpired(){const now=Date.now()
const expiredKeys=[]
for(const[name,accessTime]of this.accessTimes){if(now-accessTime>this.maxCacheAge){expiredKeys.push(name)}}
if(expiredKeys.length>0){expiredKeys.forEach(name=>{this.cache.delete(name)
this.accessTimes.delete(name)})
console.log(`è¿‡æœŸæ¸…ç†ï¼šç§»é™¤ ${expiredKeys.length} ä¸ªéŸ³é¢‘ç¼“å­˜é¡¹`)}}
startPeriodicCleanup(){if(this.cleanupTimer){clearInterval(this.cleanupTimer)}
this.cleanupTimer=setInterval(()=>{this.cleanupExpired()},this.cleanupInterval)}
clear(){this.cache.clear()
this.accessTimes.clear()
if(this.cleanupTimer){clearInterval(this.cleanupTimer)
this.cleanupTimer=null}
console.log('éŸ³é¢‘ç¼“å­˜å·²æ¸…ç©º')}
getStats(){return{size:this.cache.size,maxSize:this.maxCacheSize,items:Array.from(this.cache.keys()),oldestAccess:Math.min(...this.accessTimes.values()),newestAccess:Math.max(...this.accessTimes.values())}}}
class NotificationManager{constructor(){this.isSupported='Notification'in window
this.permission=this.isSupported?Notification.permission:'denied'
this.audioContext=null
this.userHasInteracted=false
this.activeNotifications=new Map()
this.audioCache=new AudioCacheManager()
this.config={enabled:true,webEnabled:true,soundEnabled:true,soundVolume:0.8,soundMute:false,autoRequestPermission:true,timeout:5000,icon:'/icons/icon.svg',mobileOptimized:true,mobileVibrate:true}
this.init()
this.setupUserInteractionDetection()}
setupUserInteractionDetection(){const markAsInteracted=()=>{this.userHasInteracted=true
document.removeEventListener('click',markAsInteracted)
document.removeEventListener('touchstart',markAsInteracted)
document.removeEventListener('keydown',markAsInteracted)}
document.addEventListener('click',markAsInteracted,{once:true})
document.addEventListener('touchstart',markAsInteracted,{once:true})
document.addEventListener('keydown',markAsInteracted,{once:true})}
cancelNotification(tag){if(this.activeNotifications.has(tag)){const notification=this.activeNotifications.get(tag)
try{notification.close()
console.log(`âœ… å·²å–æ¶ˆé€šçŸ¥: ${tag}`)}catch(error){console.warn(`âš ï¸  å–æ¶ˆé€šçŸ¥å¤±è´¥: ${tag}`,error)}
this.activeNotifications.delete(tag)}}
cancelAllNotifications(){const count=this.activeNotifications.size
if(count>0){console.log(`ğŸ§¹ å–æ¶ˆæ‰€æœ‰é€šçŸ¥ (${count} ä¸ª)`)
for(const[tag,notification]of this.activeNotifications){try{notification.close()}catch(error){console.warn(`âš ï¸  å–æ¶ˆé€šçŸ¥å¤±è´¥: ${tag}`,error)}}
this.activeNotifications.clear()}}
async init(){console.log('åˆå§‹åŒ–é€šçŸ¥ç®¡ç†å™¨...')
if(!this.isSupported){console.warn('æµè§ˆå™¨ä¸æ”¯æŒWeb Notification API')
return}
if(this.config.autoRequestPermission&&this.permission==='default'){await this.requestPermission()}
await this.initAudio()
console.log('é€šçŸ¥ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ')}
async requestPermission(){if(!this.isSupported){console.warn('æµè§ˆå™¨ä¸æ”¯æŒWeb Notification API')
return false}
try{if(Notification.requestPermission.length===0){this.permission=await Notification.requestPermission()}else{this.permission=await new Promise(resolve=>{Notification.requestPermission(resolve)})}
console.log(`é€šçŸ¥æƒé™çŠ¶æ€: ${this.permission}`)
return this.permission==='granted'}catch(error){console.error('è¯·æ±‚é€šçŸ¥æƒé™å¤±è´¥:',error)
return false}}
async initAudio(){try{const AudioContextClass=window.AudioContext||window.webkitAudioContext||window.mozAudioContext
if(!AudioContextClass){console.warn('æµè§ˆå™¨ä¸æ”¯æŒWeb Audio API')
return}
this.audioContext=new AudioContextClass()
await this.loadAudioFile('default','/sounds/deng[å™”].mp3')
console.log('éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ')}catch(error){console.warn('éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:',error)
this.config.soundEnabled=false}}
async loadAudioFile(name,url){if(!this.audioContext)return false
if(this.audioCache.has(name)){console.log(`éŸ³é¢‘æ–‡ä»¶å·²åœ¨ç¼“å­˜ä¸­: ${name}`)
return true}
try{const response=await fetch(url)
const arrayBuffer=await response.arrayBuffer()
const audioBuffer=await this.audioContext.decodeAudioData(arrayBuffer)
this.audioCache.set(name,audioBuffer)
console.log(`éŸ³é¢‘æ–‡ä»¶åŠ è½½æˆåŠŸ: ${name}`)
return true}catch(error){console.warn(`éŸ³é¢‘æ–‡ä»¶åŠ è½½å¤±è´¥ ${name}:`,error)
return false}}
async showNotification(title,message,options={}){if(!this.config.enabled||!this.config.webEnabled){console.log('Webé€šçŸ¥å·²ç¦ç”¨')
return null}
if(!this.isSupported){console.warn('æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ')
this.showFallbackNotification(title,message)
return null}
if(this.permission!=='granted'){console.warn('æ²¡æœ‰é€šçŸ¥æƒé™')
if(this.config.autoRequestPermission){await this.requestPermission()
if(this.permission!=='granted'){this.showFallbackNotification(title,message)
return null}}else{this.showFallbackNotification(title,message)
return null}}
try{const notificationOptions={body:message,icon:options.icon||this.config.icon,badge:options.badge||this.config.icon,tag:options.tag||'ai-intervention-agent',requireInteraction:options.requireInteraction||false,silent:options.silent||false,...options}
const tag=notificationOptions.tag
if(this.activeNotifications.has(tag)){const oldNotification=this.activeNotifications.get(tag)
try{oldNotification.close()
console.log(`â™»ï¸  å…³é—­æ—§é€šçŸ¥: ${tag}`)}catch(error){console.warn(`âš ï¸  å…³é—­æ—§é€šçŸ¥å¤±è´¥: ${tag}`,error)}}
const notification=new Notification(title,notificationOptions)
this.activeNotifications.set(tag,notification)
console.log(`â• æ·»åŠ åˆ°æ´»åŠ¨é€šçŸ¥è·Ÿè¸ª: ${tag} (æ€»è®¡: ${this.activeNotifications.size})`)
notification.onclose=()=>{this.activeNotifications.delete(tag)
console.log(`â– ä»æ´»åŠ¨é€šçŸ¥ä¸­ç§»é™¤: ${tag} (å‰©ä½™: ${this.activeNotifications.size})`)}
if(this.config.timeout>0){setTimeout(()=>{notification.close()},this.config.timeout)}
notification.onclick=()=>{window.focus()
notification.close()
if(options.onClick){options.onClick()}}
if(this.config.mobileVibrate&&this.userHasInteracted&&'vibrate'in navigator){try{navigator.vibrate([200,100,200])}catch(error){}}
console.log('é€šçŸ¥å·²æ˜¾ç¤º:',title)
return notification}catch(error){console.error('æ˜¾ç¤ºé€šçŸ¥å¤±è´¥:',error)
return null}}
async playSound(soundName='default',volume=null,retryCount=0){if(!this.config.enabled||!this.config.soundEnabled||this.config.soundMute){console.log('å£°éŸ³é€šçŸ¥å·²ç¦ç”¨')
return false}
if(!this.audioContext){console.warn('éŸ³é¢‘ä¸Šä¸‹æ–‡æœªåˆå§‹åŒ–ï¼Œå°è¯•é™çº§æ–¹æ¡ˆ')
this.recordFallbackEvent('audio',{reason:'no_audio_context',soundName})
return this.playSoundFallback(soundName)}
if(this.audioContext.state==='suspended'){try{await this.audioContext.resume()
console.log('éŸ³é¢‘ä¸Šä¸‹æ–‡å·²æ¢å¤')}catch(error){console.warn('æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡å¤±è´¥:',error)
this.recordFallbackEvent('audio',{reason:'resume_failed',error:error.message,soundName})
return this.playSoundFallback(soundName)}}
const audioBuffer=this.audioCache.get(soundName)
if(!audioBuffer){console.warn(`éŸ³é¢‘æ–‡ä»¶æœªæ‰¾åˆ°: ${soundName}`)
if(soundName!=='default'){console.log('å°è¯•ä½¿ç”¨é»˜è®¤éŸ³é¢‘æ–‡ä»¶')
return this.playSound('default',volume,retryCount)}
this.recordFallbackEvent('audio',{reason:'buffer_not_found',soundName})
return this.playSoundFallback(soundName)}
try{const source=this.audioContext.createBufferSource()
const gainNode=this.audioContext.createGain()
source.buffer=audioBuffer
source.connect(gainNode)
gainNode.connect(this.audioContext.destination)
const finalVolume=volume!==null?volume:this.config.soundVolume
gainNode.gain.value=Math.max(0,Math.min(1,finalVolume))
source.addEventListener('ended',()=>{console.log(`å£°éŸ³æ’­æ”¾å®Œæˆ: ${soundName}`)})
source.addEventListener('error',error=>{console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:',error)
this.recordFallbackEvent('audio',{reason:'playback_error',error:error.message,soundName})})
source.start(0)
console.log(`æ’­æ”¾å£°éŸ³: ${soundName}`)
return true}catch(error){console.error('æ’­æ”¾å£°éŸ³å¤±è´¥:',error)
this.recordFallbackEvent('audio',{reason:'playback_failed',error:error.message,soundName})
if(retryCount<2){console.log(`é‡è¯•æ’­æ”¾å£°éŸ³ (${retryCount + 1}/2): ${soundName}`)
await new Promise(resolve=>setTimeout(resolve,500))
return this.playSound(soundName,volume,retryCount+1)}
return this.playSoundFallback(soundName)}}
playSoundFallback(soundName){console.log(`ä½¿ç”¨éŸ³é¢‘é™çº§æ–¹æ¡ˆ: ${soundName}`)
try{const audio=new Audio(`/sounds/${soundName === 'default' ? 'deng[å™”].mp3' : soundName + '.mp3'}`)
audio.volume=this.config.soundVolume
const playPromise=audio.play()
if(playPromise!==undefined){playPromise.then(()=>{console.log('HTML5 Audioæ’­æ”¾æˆåŠŸ')}).catch(error=>{console.warn('HTML5 Audioæ’­æ”¾å¤±è´¥:',error)
this.vibrateFallback()})}
return true}catch(error){console.warn('HTML5 Audioé™çº§å¤±è´¥:',error)
return this.vibrateFallback()}}
vibrateFallback(){if(this.config.mobileVibrate&&this.userHasInteracted&&'vibrate'in navigator){try{navigator.vibrate([200,100,200])
console.log('ä½¿ç”¨æŒ¯åŠ¨æé†’')
return true}catch(error){}}
console.log('æ‰€æœ‰éŸ³é¢‘é™çº§æ–¹æ¡ˆéƒ½å¤±è´¥äº†')
return false}
async sendNotification(title,message,options={}){const results=[]
const promises=[]
if(this.config.webEnabled){promises.push(this.showNotification(title,message,options).then(notification=>({type:'web',success:notification!==null})))}
if(this.config.soundEnabled){promises.push(this.playSound(options.sound).then(soundSuccess=>({type:'sound',success:soundSuccess})))}
if(promises.length>0){try{const promiseResults=await Promise.all(promises)
results.push(...promiseResults)}catch(error){console.warn('é€šçŸ¥æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:',error)}}
return results}
showFallbackNotification(title,message,options={}){console.log(`é™çº§é€šçŸ¥: ${title} - ${message}`)
if(typeof showStatus==='function'){showStatus(`${title}: ${message}`,'info')}
this.flashTitle(title)
if(!this.isSupported||this.permission==='denied'){this.showInPageNotification(title,message,options)}
console.log(`%cğŸ”” ${title}`,'color: #0084ff; font-weight: bold; font-size: 14px;')
console.log(`%c${message}`,'color: #666; font-size: 12px;')
this.recordFallbackEvent('notification',{title,message,reason:options.reason||'unknown'})}
flashTitle(message){const originalTitle=document.title
let flashCount=0
const maxFlashes=6
const flashInterval=setInterval(()=>{document.title=flashCount%2===0?`ğŸ”” ${message}`:originalTitle
flashCount++
if(flashCount>=maxFlashes){clearInterval(flashInterval)
document.title=originalTitle}},1000)}
updateConfig(newConfig){this.config={...this.config,...newConfig}
console.log('é€šçŸ¥é…ç½®å·²æ›´æ–°:',this.config)}
getStatus(){return{supported:this.isSupported,permission:this.permission,audioContext:this.audioContext?this.audioContext.state:'unavailable',config:this.config}}
showInPageNotification(title,message,options={}){const notification=DOMSecurity.createNotification(title,message)
notification.classList.add('in-page-notification')
const titleEl=notification.querySelector('.in-page-notification-title')
const messageEl=notification.querySelector('.in-page-notification-message')
const closeEl=notification.querySelector('.in-page-notification-close')
document.body.appendChild(notification)
closeEl.addEventListener('click',()=>{notification.classList.add('hide')
setTimeout(()=>{if(notification.parentNode){notification.parentNode.removeChild(notification)}},300)})
setTimeout(()=>{notification.classList.add('show')},10)
setTimeout(()=>{if(notification.parentNode){closeEl.click()}},options.timeout||5000)
return notification}
recordFallbackEvent(type,data){const event={type,data,timestamp:Date.now(),userAgent:navigator.userAgent,url:window.location.href}
try{const storageKey='ai-intervention-fallback-events'
const events=JSON.parse(localStorage.getItem(storageKey)||'[]')
const sevenDaysAgo=Date.now()-7*24*60*60*1000
const validEvents=events.filter(e=>e.timestamp>sevenDaysAgo)
validEvents.push(event)
if(validEvents.length>50){validEvents.splice(0,validEvents.length-50)}
localStorage.setItem(storageKey,JSON.stringify(validEvents))
this.monitorLocalStorageUsage(storageKey)}catch(error){console.warn('æ— æ³•è®°å½•é™çº§äº‹ä»¶:',error)
this.cleanupLocalStorage()}
if(this.config.debug){console.log('é™çº§äº‹ä»¶è®°å½•:',event)}}
monitorLocalStorageUsage(key){try{const data=localStorage.getItem(key)
if(data){const sizeInBytes=new Blob([data]).size
const sizeInKB=(sizeInBytes/1024).toFixed(2)
if(sizeInBytes>100*1024){console.warn(`localStorageäº‹ä»¶è®°å½•è¿‡å¤§: ${sizeInKB}KBï¼Œå»ºè®®æ¸…ç†`)}
if(this.config.debug){console.log(`localStorageäº‹ä»¶è®°å½•å¤§å°: ${sizeInKB}KB`)}}}catch(error){console.warn('æ— æ³•ç›‘æ§localStorageä½¿ç”¨æƒ…å†µ:',error)}}
cleanupLocalStorage(){try{const storageKey='ai-intervention-fallback-events'
const events=JSON.parse(localStorage.getItem(storageKey)||'[]')
const oneDayAgo=Date.now()-24*60*60*1000
const recentEvents=events.filter(e=>e.timestamp>oneDayAgo)
if(recentEvents.length>20){recentEvents.splice(0,recentEvents.length-20)}
localStorage.setItem(storageKey,JSON.stringify(recentEvents))
console.log(`localStorageæ¸…ç†å®Œæˆï¼Œä¿ç•™ ${recentEvents.length} ä¸ªäº‹ä»¶`)}catch(error){console.error('localStorageæ¸…ç†å¤±è´¥:',error)
try{localStorage.removeItem('ai-intervention-fallback-events')
console.log('å·²æ¸…ç©ºlocalStorageäº‹ä»¶è®°å½•')}catch(clearError){console.error('æ— æ³•æ¸…ç©ºlocalStorage:',clearError)}}}}
const notificationManager=new NotificationManager()
class SettingsManager{constructor(){this.storageKey='ai-intervention-agent-settings'
this.defaultSettings={enabled:true,webEnabled:true,autoRequestPermission:true,soundEnabled:true,soundMute:false,soundVolume:80,mobileOptimized:true,mobileVibrate:true,barkEnabled:false,barkUrl:'https://api.day.app/push',barkDeviceKey:'',barkIcon:'',barkAction:'none'}
this.debouncedSyncConfigToBackend=typeof debounce!=='undefined'?debounce(this._syncConfigToBackendImpl.bind(this),500):this._syncConfigToBackendImpl.bind(this)
this.init()}
async init(){this.settings=await this.loadSettings()
this.initEventListeners()}
async loadSettings(){try{const response=await fetch('/api/get-notification-config')
if(response.ok){const result=await response.json()
if(result.status==='success'){const serverConfig=result.config
const settings={enabled:serverConfig.enabled??this.defaultSettings.enabled,webEnabled:serverConfig.web_enabled??this.defaultSettings.webEnabled,autoRequestPermission:serverConfig.auto_request_permission??this.defaultSettings.autoRequestPermission,soundEnabled:serverConfig.sound_enabled??this.defaultSettings.soundEnabled,soundMute:serverConfig.sound_mute??this.defaultSettings.soundMute,soundVolume:serverConfig.sound_volume??this.defaultSettings.soundVolume,mobileOptimized:serverConfig.mobile_optimized??this.defaultSettings.mobileOptimized,mobileVibrate:serverConfig.mobile_vibrate??this.defaultSettings.mobileVibrate,barkEnabled:serverConfig.bark_enabled??this.defaultSettings.barkEnabled,barkUrl:serverConfig.bark_url??this.defaultSettings.barkUrl,barkDeviceKey:serverConfig.bark_device_key??this.defaultSettings.barkDeviceKey,barkIcon:serverConfig.bark_icon??this.defaultSettings.barkIcon,barkAction:serverConfig.bark_action??this.defaultSettings.barkAction}
console.log('ä»æœåŠ¡å™¨åŠ è½½é…ç½®æˆåŠŸ')
return settings}}}catch(error){console.warn('ä»æœåŠ¡å™¨åŠ è½½é…ç½®å¤±è´¥ï¼Œå°è¯•localStorage:',error)}
try{const stored=localStorage.getItem(this.storageKey)
if(stored){const parsed=JSON.parse(stored)
return{...this.defaultSettings,...parsed}}}catch(error){console.warn('åŠ è½½è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®:',error)}
return{...this.defaultSettings}}
saveSettings(){try{localStorage.setItem(this.storageKey,JSON.stringify(this.settings))
console.log('è®¾ç½®å·²ä¿å­˜')}catch(error){console.error('ä¿å­˜è®¾ç½®å¤±è´¥:',error)}}
updateSetting(key,value){this.settings[key]=value
this.saveSettings()
this.applySettings()
console.log(`è®¾ç½®å·²æ›´æ–°: ${key} = ${value}`)}
applySettings(){if(notificationManager){notificationManager.updateConfig({enabled:this.settings.enabled,webEnabled:this.settings.webEnabled,autoRequestPermission:this.settings.autoRequestPermission,soundEnabled:this.settings.soundEnabled,soundMute:this.settings.soundMute,soundVolume:this.settings.soundVolume/100,mobileOptimized:this.settings.mobileOptimized,mobileVibrate:this.settings.mobileVibrate,barkEnabled:this.settings.barkEnabled,barkUrl:this.settings.barkUrl,barkDeviceKey:this.settings.barkDeviceKey,barkIcon:this.settings.barkIcon,barkAction:this.settings.barkAction})}
this.syncConfigToBackend()}
syncConfigToBackend(){this.debouncedSyncConfigToBackend()}
async _syncConfigToBackendImpl(){try{const response=await fetch('/api/update-notification-config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(this.settings)})
const result=await response.json()
if(response.ok&&result.status==='success'){console.log('åç«¯é€šçŸ¥é…ç½®å·²åŒæ­¥')}else{console.warn('åŒæ­¥åç«¯é…ç½®å¤±è´¥:',result.message)}}catch(error){console.error('åŒæ­¥åç«¯é…ç½®å¤±è´¥:',error)}}
resetSettings(){this.settings={...this.defaultSettings}
this.saveSettings()
this.updateUI()
this.applySettings()
console.log('è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼')}
updateUI(){document.getElementById('notification-enabled').checked=this.settings.enabled
document.getElementById('web-notification-enabled').checked=this.settings.webEnabled
document.getElementById('auto-request-permission').checked=this.settings.autoRequestPermission
document.getElementById('sound-notification-enabled').checked=this.settings.soundEnabled
document.getElementById('sound-mute').checked=this.settings.soundMute
document.getElementById('sound-volume').value=this.settings.soundVolume
document.querySelector('.volume-value').textContent=`${this.settings.soundVolume}%`
document.getElementById('mobile-optimized').checked=this.settings.mobileOptimized
document.getElementById('mobile-vibrate').checked=this.settings.mobileVibrate
document.getElementById('bark-notification-enabled').checked=this.settings.barkEnabled
document.getElementById('bark-url').value=this.settings.barkUrl
document.getElementById('bark-device-key').value=this.settings.barkDeviceKey
document.getElementById('bark-icon').value=this.settings.barkIcon
document.getElementById('bark-action').value=this.settings.barkAction}
updateStatus(){const browserSupport=notificationManager.isSupported?'âœ… æ”¯æŒ':'âŒ ä¸æ”¯æŒ'
const permission=notificationManager.permission==='granted'?'âœ… å·²æˆæƒ':notificationManager.permission==='denied'?'âŒ å·²æ‹’ç»':'âš ï¸ æœªè¯·æ±‚'
let audioState='âŒ ä¸å¯ç”¨'
if(notificationManager.audioContext){const state=notificationManager.audioContext.state
switch(state){case'running':audioState='âœ… è¿è¡Œä¸­'
break
case'suspended':audioState='â¸ï¸ å·²æš‚åœ'
break
case'closed':audioState='âŒ å·²å…³é—­'
break
default:audioState=`âš ï¸ ${state}`}}
document.getElementById('browser-support-status').textContent=browserSupport
document.getElementById('notification-permission-status').textContent=permission
document.getElementById('audio-status').textContent=audioState}
initEventListeners(){document.addEventListener('click',e=>{if(e.target.id==='settings-btn'){this.showSettings()}else if(e.target.id==='settings-close-btn'){this.hideSettings()}else if(e.target.id==='test-notification-btn'){this.testNotification()}else if(e.target.id==='test-bark-notification-btn'){this.testBarkNotification()}else if(e.target.id==='reset-settings-btn'){this.resetSettings()}})
document.addEventListener('click',e=>{if(e.target.id==='settings-panel'){this.hideSettings()}})
document.addEventListener('change',e=>{const settingMap={'notification-enabled':'enabled','web-notification-enabled':'webEnabled','auto-request-permission':'autoRequestPermission','sound-notification-enabled':'soundEnabled','sound-mute':'soundMute','mobile-optimized':'mobileOptimized','mobile-vibrate':'mobileVibrate','bark-notification-enabled':'barkEnabled'}
if(settingMap[e.target.id]){this.updateSetting(settingMap[e.target.id],e.target.checked)}else if(e.target.id==='sound-volume'){this.updateSetting('soundVolume',parseInt(e.target.value))
document.querySelector('.volume-value').textContent=`${e.target.value}%`}else if(e.target.id==='bark-url'){this.updateSetting('barkUrl',e.target.value)}else if(e.target.id==='bark-device-key'){this.updateSetting('barkDeviceKey',e.target.value)}else if(e.target.id==='bark-icon'){this.updateSetting('barkIcon',e.target.value)}else if(e.target.id==='bark-action'){this.updateSetting('barkAction',e.target.value)}})}
showSettings(){this.updateUI()
this.updateStatus()
this.syncConfigToBackend()
const panel=document.getElementById('settings-panel')
panel.classList.add('show')
panel.classList.remove('hidden')}
hideSettings(){const panel=document.getElementById('settings-panel')
panel.classList.remove('show')
panel.classList.add('hidden')}
async testNotification(){try{await notificationManager.sendNotification('è®¾ç½®æµ‹è¯•','è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯å½“å‰è®¾ç½®æ˜¯å¦æ­£å¸¸å·¥ä½œ',{tag:'settings-test',requireInteraction:false})
showStatus('æµ‹è¯•é€šçŸ¥å·²å‘é€','success')}catch(error){console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:',error)
showStatus('æµ‹è¯•é€šçŸ¥å¤±è´¥: '+error.message,'error')}}
async testBarkNotification(){try{if(!this.settings.barkEnabled){showStatus('è¯·å…ˆå¯ç”¨ Bark é€šçŸ¥','warning')
return}
if(!this.settings.barkUrl||!this.settings.barkDeviceKey){showStatus('è¯·å…ˆé…ç½® Bark URL å’Œ Device Key','warning')
return}
showStatus('æ­£åœ¨å‘é€ Bark æµ‹è¯•é€šçŸ¥...','info')
const response=await fetch('/api/test-bark',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bark_url:this.settings.barkUrl,bark_device_key:this.settings.barkDeviceKey,bark_icon:this.settings.barkIcon,bark_action:this.settings.barkAction})})
const result=await response.json()
if(response.ok&&result.status==='success'){showStatus(result.message,'success')
console.log('Bark é€šçŸ¥å‘é€æˆåŠŸ:',result)}else{showStatus(result.message||'Bark é€šçŸ¥å‘é€å¤±è´¥','error')
console.error('Bark é€šçŸ¥å‘é€å¤±è´¥:',result)}}catch(error){console.error('Bark æµ‹è¯•é€šçŸ¥å¤±è´¥:',error)
showStatus('Bark æµ‹è¯•é€šçŸ¥å¤±è´¥: '+error.message,'error')}}}
const settingsManager=new SettingsManager()
function debounce(func,wait){let timeout
return function executedFunction(...args){const later=()=>{clearTimeout(timeout)
func(...args)}
clearTimeout(timeout)
timeout=setTimeout(later,wait)}}
function throttle(func,limit){let inThrottle
return function(...args){if(!inThrottle){func.apply(this,args)
inThrottle=true
setTimeout(()=>(inThrottle=false),limit)}}}
function rafUpdate(callback){if(window.requestAnimationFrame){requestAnimationFrame(callback)}else{setTimeout(callback,16)}}
const SUPPORTED_IMAGE_TYPES=['image/jpeg','image/jpg','image/png','image/gif','image/webp','image/bmp','image/svg+xml']
const MIN_IMAGE_SIZE=100
const MAX_IMAGE_SIZE=10*1024*1024
const MAX_IMAGE_COUNT=10
const MAX_IMAGE_DIMENSION=1920
const COMPRESS_QUALITY=0.8
function validateImageFile(file){const errors=[]
if(!file||!file.type){errors.push('æ— æ•ˆçš„æ–‡ä»¶å¯¹è±¡')
return errors}
if(!SUPPORTED_IMAGE_TYPES.includes(file.type)){errors.push(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${file.type}`)}
if(file.size<MIN_IMAGE_SIZE){errors.push(`æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½æ˜¯ç©ºæ–‡ä»¶æˆ–æŸåæ–‡ä»¶: ${file.size}å­—èŠ‚ < ${MIN_IMAGE_SIZE}å­—èŠ‚`)}
if(file.size>MAX_IMAGE_SIZE){errors.push(`æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶: ${(file.size / 1024 / 1024).toFixed(2)}MB > 10MB`)}
if(file.name&&file.name.length>255){errors.push('æ–‡ä»¶åè¿‡é•¿')}
const suspiciousExtensions=['.exe','.bat','.cmd','.scr','.com','.pif','.vbs','.js','.jar']
if(suspiciousExtensions.some(ext=>file.name.toLowerCase().endsWith(ext))){errors.push('æ£€æµ‹åˆ°å¯ç–‘æ–‡ä»¶ç±»å‹')}
return errors}
function sanitizeFileName(fileName){return fileName.replace(/[<>:"/\\|?*]/g,'').replace(/\s+/g,'_').trim().substring(0,100)}
let objectURLs=new Set()
let urlToFileMap=new WeakMap()
let urlCreationTime=new Map()
let urlCleanupTimer=null
function createObjectURL(file){try{const url=URL.createObjectURL(file)
objectURLs.add(url)
urlToFileMap.set(file,url)
urlCreationTime.set(url,Date.now())
setTimeout(()=>{if(objectURLs.has(url)){console.warn(`è‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„URLå¯¹è±¡: ${url}`)
revokeObjectURL(url)}},30*60*1000)
return url}catch(error){console.error('åˆ›å»ºObject URLå¤±è´¥:',error)
return null}}
function revokeObjectURL(url){if(!url)return
try{if(objectURLs.has(url)){URL.revokeObjectURL(url)
objectURLs.delete(url)
urlCreationTime.delete(url)
console.debug(`å·²æ¸…ç†URLå¯¹è±¡: ${url}`)}}catch(error){console.error('æ¸…ç†URLå¯¹è±¡å¤±è´¥:',error)}}
function cleanupAllObjectURLs(){console.log(`å¼€å§‹æ¸…ç† ${objectURLs.size} ä¸ªURLå¯¹è±¡`)
const startTime=performance.now()
objectURLs.forEach(url=>{try{URL.revokeObjectURL(url)}catch(error){console.error(`æ¸…ç†URLå¤±è´¥: ${url}`,error)}})
objectURLs.clear()
urlCreationTime.clear()
if(urlCleanupTimer){clearInterval(urlCleanupTimer)
urlCleanupTimer=null}
const endTime=performance.now()
console.log(`URLå¯¹è±¡æ¸…ç†å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`)}
function startPeriodicCleanup(){if(urlCleanupTimer){clearInterval(urlCleanupTimer)}
urlCleanupTimer=setInterval(()=>{const now=Date.now()
const expiredUrls=[]
urlCreationTime.forEach((creationTime,url)=>{if(now-creationTime>20*60*1000){expiredUrls.push(url)}})
if(expiredUrls.length>0){console.log(`å®šæœŸæ¸…ç† ${expiredUrls.length} ä¸ªè¿‡æœŸURLå¯¹è±¡`)
expiredUrls.forEach(url=>revokeObjectURL(url))}},5*60*1000)}
function compressImage(file){return new Promise(resolve=>{if(file.type==='image/svg+xml'||file.type==='image/gif'){resolve(file)
return}
const isLargeFile=file.size>5*1024*1024
const canvas=document.createElement('canvas')
const ctx=canvas.getContext('2d',{alpha:file.type==='image/png',willReadFrequently:false})
const img=new Image()
const objectURL=createObjectURL(file)
img.onload=()=>{let{width,height}=img
const originalArea=width*height
let maxDimension=MAX_IMAGE_DIMENSION
if(isLargeFile||originalArea>4000000){maxDimension=Math.min(MAX_IMAGE_DIMENSION,1200)}
if(width>maxDimension||height>maxDimension){const ratio=Math.min(maxDimension/width,maxDimension/height)
width=Math.floor(width*ratio)
height=Math.floor(height*ratio)}
canvas.width=width
canvas.height=height
ctx.imageSmoothingEnabled=true
ctx.imageSmoothingQuality='high'
rafUpdate(()=>{ctx.drawImage(img,0,0,width,height)
let quality=COMPRESS_QUALITY
if(isLargeFile){quality=Math.max(0.6,COMPRESS_QUALITY-0.2)}
canvas.toBlob(blob=>{revokeObjectURL(objectURL)
if(blob&&blob.size<file.size){const compressedFile=new File([blob],file.name,{type:file.type,lastModified:file.lastModified})
console.log(`å›¾ç‰‡å‹ç¼©: ${file.name} ${(file.size / 1024).toFixed(2)}KB â†’ ${(
                  blob.size / 1024
                ).toFixed(2)}KB (å‹ç¼©ç‡: ${((1 - blob.size / file.size) * 100).toFixed(1)}%)`)
resolve(compressedFile)}else{resolve(file)}},file.type==='image/png'?'image/png':'image/jpeg',quality)})}
img.onerror=()=>{revokeObjectURL(objectURL)
resolve(file)}
img.src=objectURL})}
async function addImageToList(file){if(selectedImages.length>=MAX_IMAGE_COUNT){showStatus(`æœ€å¤šåªèƒ½ä¸Šä¼  ${MAX_IMAGE_COUNT} å¼ å›¾ç‰‡`,'error')
return false}
const errors=validateImageFile(file)
if(errors.length>0){showStatus(errors.join('; '),'error')
return false}
const isDuplicate=selectedImages.some(img=>img.name===file.name&&img.size===file.size&&img.lastModified===file.lastModified)
if(isDuplicate){showStatus('è¯¥å›¾ç‰‡å·²ç»æ·»åŠ è¿‡äº†','error')
return false}
const imageId=Date.now()+Math.random()
const timestamp=Date.now()
try{const imageItem={id:imageId,file:file,name:file.name,size:file.size,base64:null,timestamp:timestamp,lastModified:file.lastModified}
selectedImages.push(imageItem)
renderImagePreview(imageItem,true)
updateImageCounter()
const processedFile=await compressImage(file)
imageItem.file=processedFile
imageItem.size=processedFile.size
const previewUrl=createObjectURL(processedFile)
if(previewUrl){imageItem.previewUrl=previewUrl}else{throw new Error('åˆ›å»ºé¢„è§ˆURLå¤±è´¥')}
renderImagePreview(imageItem,false)
console.log('å›¾ç‰‡æ·»åŠ æˆåŠŸ:',file.name,`(${(imageItem.size / 1024).toFixed(2)}KB)`)
return true}catch(error){console.error('å›¾ç‰‡å¤„ç†å¤±è´¥:',error)
showStatus('å›¾ç‰‡å¤„ç†å¤±è´¥: '+error.message,'error')
selectedImages=selectedImages.filter(img=>img.id!==imageId)
updateImageCounter()
return false}}
let domUpdateQueue=[]
let domUpdateScheduled=false
function scheduleDOMUpdate(callback){domUpdateQueue.push(callback)
if(!domUpdateScheduled){domUpdateScheduled=true
rafUpdate(()=>{const fragment=document.createDocumentFragment()
domUpdateQueue.forEach(callback=>callback(fragment))
domUpdateQueue=[]
domUpdateScheduled=false})}}
function renderImagePreview(imageItem,isLoading=false){rafUpdate(()=>{const previewContainer=document.getElementById('image-previews')
let previewElement=document.getElementById(`preview-${imageItem.id}`)
if(!previewElement){previewElement=document.createElement('div')
previewElement.id=`preview-${imageItem.id}`
previewElement.className='image-preview-item'
previewContainer.appendChild(previewElement)}
const newPreviewElement=DOMSecurity.createImagePreview(imageItem,isLoading)
DOMSecurity.replaceContent(previewElement,newPreviewElement.firstChild||newPreviewElement)
if(!isLoading&&imageItem.previewUrl){const img=new Image()
img.onload=()=>{rafUpdate(()=>{const updatedPreviewElement=DOMSecurity.createImagePreview(imageItem,false)
DOMSecurity.replaceContent(previewElement,updatedPreviewElement.firstChild||updatedPreviewElement)})}
img.src=imageItem.previewUrl}})}
function sanitizeText(text){const div=document.createElement('div')
div.textContent=text
return div.innerHTML}
function removeImage(imageId){const imageToRemove=selectedImages.find(img=>img.id==imageId)
if(imageToRemove&&imageToRemove.previewUrl&&imageToRemove.previewUrl.startsWith('blob:')){revokeObjectURL(imageToRemove.previewUrl)}
selectedImages=selectedImages.filter(img=>img.id!=imageId)
const previewElement=document.getElementById(`preview-${imageId}`)
if(previewElement){previewElement.remove()}
updateImageCounter()
updateImagePreviewVisibility()}
function clearAllImages(){selectedImages.forEach(img=>{if(img.previewUrl&&img.previewUrl.startsWith('blob:')){revokeObjectURL(img.previewUrl)}})
selectedImages=[]
const previewContainer=document.getElementById('image-previews')
DOMSecurity.clearContent(previewContainer)
updateImageCounter()
updateImagePreviewVisibility()
if(window.gc&&typeof window.gc==='function'){setTimeout(()=>window.gc(),1000)}
console.log('æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤ï¼Œå†…å­˜å·²é‡Šæ”¾')}
function cleanupOnUnload(){cleanupAllObjectURLs()
clearAllImages()}
window.addEventListener('beforeunload',cleanupOnUnload)
window.addEventListener('pagehide',cleanupOnUnload)
function updateImageCounter(){const countElement=document.getElementById('image-count')
if(countElement){countElement.textContent=selectedImages.length}}
function updateImagePreviewVisibility(){const container=document.getElementById('image-preview-container')
if(selectedImages.length>0){container.classList.remove('hidden')
container.classList.add('visible')}else{container.classList.add('hidden')
container.classList.remove('visible')}}
async function handleFileUpload(files){const fileArray=Array.from(files)
const totalCount=selectedImages.length+fileArray.length
if(totalCount>MAX_IMAGE_COUNT){showStatus(`æœ€å¤šåªèƒ½ä¸Šä¼  ${MAX_IMAGE_COUNT} å¼ å›¾ç‰‡ï¼ˆå½“å‰ ${selectedImages.length} å¼ ï¼Œå°è¯•æ·»åŠ  ${fileArray.length} å¼ ï¼‰`,'error')
return}
const maxConcurrent=3
let processed=0
let successful=0
if(fileArray.length>1){showStatus(`æ­£åœ¨å¤„ç† ${fileArray.length} ä¸ªæ–‡ä»¶...`,'info')}
for(let i=0;i<fileArray.length;i+=maxConcurrent){const batch=fileArray.slice(i,i+maxConcurrent)
const batchPromises=batch.map(async file=>{try{const success=await addImageToList(file)
if(success)successful++
processed++
if(fileArray.length>1){showStatus(`å¤„ç†è¿›åº¦: ${processed}/${fileArray.length}`,'info')}
return success}catch(error){console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:',file.name,error)
processed++
return false}})
await Promise.all(batchPromises)
if(i+maxConcurrent<fileArray.length){await new Promise(resolve=>setTimeout(resolve,50))}}
updateImagePreviewVisibility()
if(fileArray.length>1){showStatus(`å®Œæˆå¤„ç†: ${successful}/${fileArray.length} ä¸ªæ–‡ä»¶æˆåŠŸ`,successful>0?'success':'error')}else if(fileArray.length===1){showStatus(successful>0?'æ–‡ä»¶å¤„ç†æˆåŠŸ':'æ–‡ä»¶å¤„ç†å¤±è´¥',successful>0?'success':'error')}}
function initializeDragAndDrop(){const textarea=document.getElementById('feedback-text')
const dragOverlay=document.getElementById('drag-overlay')
let dragCounter=0
let dragTimer=null;['dragenter','dragover','dragleave','drop'].forEach(eventName=>{document.addEventListener(eventName,preventDefaults,{passive:false})})
function preventDefaults(e){e.preventDefault()
e.stopPropagation()}
const throttledDragEnter=throttle(e=>{dragCounter++
if(e.dataTransfer.types.includes('Files')){rafUpdate(()=>{dragOverlay.classList.remove('hidden')
dragOverlay.classList.add('flex-visible')
textarea.classList.add('textarea-drag-over')})}},100)
const throttledDragLeave=throttle(e=>{dragCounter--
if(dragCounter<=0){dragCounter=0
clearTimeout(dragTimer)
dragTimer=setTimeout(()=>{rafUpdate(()=>{dragOverlay.classList.add('hidden')
dragOverlay.classList.remove('flex-visible')
textarea.classList.remove('textarea-drag-over')})},100)}},50)
const throttledDragOver=throttle(e=>{if(e.dataTransfer.types.includes('Files')){e.dataTransfer.dropEffect='copy'}},50)
document.addEventListener('dragenter',throttledDragEnter)
document.addEventListener('dragleave',throttledDragLeave)
document.addEventListener('dragover',throttledDragOver)
document.addEventListener('drop',function(e){dragCounter=0
clearTimeout(dragTimer)
rafUpdate(()=>{dragOverlay.classList.add('hidden')
dragOverlay.classList.remove('flex-visible')
textarea.classList.remove('textarea-drag-over')})
if(e.dataTransfer.files.length>0){const totalFiles=selectedImages.length+e.dataTransfer.files.length
if(totalFiles>MAX_IMAGE_COUNT){showStatus(`æœ€å¤šåªèƒ½ä¸Šä¼  ${MAX_IMAGE_COUNT} å¼ å›¾ç‰‡`,'error')
return}
handleFileUpload(e.dataTransfer.files)}})}
function initializePasteFunction(){document.addEventListener('paste',async function(e){const clipboardData=e.clipboardData
if(!clipboardData)return
const items=Array.from(clipboardData.items)
const imageItems=items.filter(item=>item.type.startsWith('image/'))
if(imageItems.length>0){e.preventDefault()
const totalCount=selectedImages.length+imageItems.length
if(totalCount>MAX_IMAGE_COUNT){showStatus(`æœ€å¤šåªèƒ½ä¸Šä¼  ${MAX_IMAGE_COUNT} å¼ å›¾ç‰‡ï¼ˆå½“å‰ ${selectedImages.length} å¼ ï¼Œå°è¯•æ·»åŠ  ${imageItems.length} å¼ ï¼‰`,'error')
return}
let successCount=0
for(const item of imageItems){const file=item.getAsFile()
if(file){const success=await addImageToList(file)
if(success)successCount++}}
updateImagePreviewVisibility()
if(successCount>0){showStatus(successCount===imageItems.length?`ä»å‰ªè´´æ¿æ·»åŠ äº† ${successCount} å¼ å›¾ç‰‡`:`ä»å‰ªè´´æ¿æ·»åŠ äº† ${successCount}/${imageItems.length} å¼ å›¾ç‰‡`,successCount===imageItems.length?'success':'warning')}else{showStatus('å›¾ç‰‡æ·»åŠ å¤±è´¥','error')}}})}
function initializeFileSelection(){const fileInput=document.getElementById('file-upload-input')
const uploadBtn=document.getElementById('upload-image-btn')
uploadBtn.addEventListener('click',()=>{fileInput.click()})
fileInput.addEventListener('change',e=>{if(e.target.files.length>0){handleFileUpload(e.target.files)
e.target.value=''}})}
function openImageModal(base64,name,size){const modal=document.getElementById('image-modal')
const modalImage=document.getElementById('modal-image')
const modalInfo=document.getElementById('modal-info')
modalImage.src=base64
modalImage.alt=name
modalInfo.textContent=`${name} (${(size / 1024).toFixed(2)}KB)`
modal.classList.add('show')
document.addEventListener('keydown',handleModalKeydown)
modal.addEventListener('click',function(e){if(e.target===modal){closeImageModal()}})}
function closeImageModal(){const modal=document.getElementById('image-modal')
modal.classList.remove('show')
document.removeEventListener('keydown',handleModalKeydown)}
function handleModalKeydown(event){if(event.key==='Escape'){closeImageModal()}}
function isMobileDevice(){return(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||(navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&/MacIntel/.test(navigator.platform)))}
function detectPlatform(){const platform=navigator.platform.toLowerCase()
const userAgent=navigator.userAgent.toLowerCase()
if(platform.includes('mac')||userAgent.includes('mac')){return'mac'}else if(platform.includes('win')||userAgent.includes('win')){return'windows'}else if(platform.includes('linux')||userAgent.includes('linux')){return'linux'}
return'windows'}
function getShortcutText(platform){const shortcuts={mac:['ğŸš€ âŒ˜+Enter  æäº¤åé¦ˆ','ğŸ’» âŒ¥+C      æ’å…¥ä»£ç ','ğŸ“‹ âŒ˜+V      ç²˜è´´å›¾ç‰‡','ğŸ“· âŒ˜+U      ä¸Šä¼ å›¾ç‰‡','ğŸ—‘ï¸ Delete   æ¸…é™¤å›¾ç‰‡'],windows:['ğŸš€ Ctrl+Enter æäº¤åé¦ˆ','ğŸ’» Alt+C      æ’å…¥ä»£ç ','ğŸ“‹ Ctrl+V     ç²˜è´´å›¾ç‰‡','ğŸ“· Ctrl+U     ä¸Šä¼ å›¾ç‰‡','ğŸ—‘ï¸ Delete     æ¸…é™¤å›¾ç‰‡'],linux:['ğŸš€ Ctrl+Enter æäº¤åé¦ˆ','ğŸ’» Alt+C      æ’å…¥ä»£ç ','ğŸ“‹ Ctrl+V     ç²˜è´´å›¾ç‰‡','ğŸ“· Ctrl+U     ä¸Šä¼ å›¾ç‰‡','ğŸ—‘ï¸ Delete     æ¸…é™¤å›¾ç‰‡']}
const lines=shortcuts[platform]||shortcuts.windows
return lines.join('\n')}
function initializeShortcutTooltip(){if(!isMobileDevice()){const platform=detectPlatform()
updateShortcutDisplay(platform)
console.log(`æ£€æµ‹åˆ°æ¡Œé¢å¹³å°: ${platform}ï¼Œå·²è®¾ç½®å¯¹åº”å¿«æ·é”®`)}else{console.log('æ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡ï¼Œå·²éšè—å¿«æ·é”®éƒ¨åˆ†')}}
function updateShortcutDisplay(platform){const isMac=platform==='mac'
const ctrlOrCmd=isMac?'Cmd':'Ctrl'
const altOrOption=isMac?'Option':'Alt'
const shortcuts={'shortcut-submit':`${ctrlOrCmd}+Enter`,'shortcut-code':`${altOrOption}+C`,'shortcut-paste':`${ctrlOrCmd}+V`,'shortcut-upload':`${ctrlOrCmd}+U`,'shortcut-delete':'Delete'}
Object.entries(shortcuts).forEach(([id,shortcut])=>{const element=document.getElementById(id)
if(element){element.textContent=shortcut}})}
function checkBrowserCompatibility(){const features={fileAPI:!!(window.File&&window.FileReader&&window.FileList&&window.Blob),dragDrop:'ondragstart'in document.createElement('div'),canvas:!!document.createElement('canvas').getContext,webWorker:!!window.Worker,requestAnimationFrame:!!(window.requestAnimationFrame||window.webkitRequestAnimationFrame),objectURL:!!(window.URL&&window.URL.createObjectURL),clipboard:!!(navigator.clipboard&&navigator.clipboard.read)}
console.log('æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹:',features)
if(!features.fileAPI){showStatus('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶APIï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨','warning')
return false}
if(!features.canvas){showStatus('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒCanvasï¼Œå›¾ç‰‡å‹ç¼©åŠŸèƒ½å°†è¢«ç¦ç”¨','warning')}
return true}
function setupFeatureFallbacks(){if(!window.requestAnimationFrame){window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){return setTimeout(callback,16)}}
if(!navigator.clipboard){console.warn('å‰ªè´´æ¿APIä¸å¯ç”¨ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ')}
if(!Object.assign){Object.assign=function(target,...sources){sources.forEach(source=>{if(source){Object.keys(source).forEach(key=>{target[key]=source[key]})}})
return target}}}
function initializeImageFeatures(){if(!checkBrowserCompatibility()){console.error('æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥å¤±è´¥')
return}
setupFeatureFallbacks()
try{initializeDragAndDrop()
initializePasteFunction()
initializeFileSelection()
const clearBtn=document.getElementById('clear-all-images-btn')
if(clearBtn){clearBtn.addEventListener('click',clearAllImages)}
console.log('å›¾ç‰‡åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ')}catch(error){console.error('å›¾ç‰‡åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥:',error)
showStatus('å›¾ç‰‡åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•','error')}}
document.addEventListener('DOMContentLoaded',()=>{if(typeof window.multiTaskModule!=='undefined'&&typeof window.multiTaskModule.initMultiTaskSupport==='function'){window.multiTaskModule.initMultiTaskSupport()
console.log('âœ… å¤šä»»åŠ¡æ”¯æŒå·²åˆå§‹åŒ–')}else{console.warn('âš ï¸ å¤šä»»åŠ¡æ¨¡å—æœªåŠ è½½ï¼Œå¯èƒ½æ˜¯multi_task.jsåŠ è½½å¤±è´¥')}
loadFeedbackPrompts()
loadConfig().then(()=>{console.log('âœ… é…ç½®åŠ è½½å®Œæˆï¼Œå¯åŠ¨å†…å®¹è½®è¯¢æ£€æŸ¥...')
console.log('å½“å‰é…ç½®:',{has_content:config.has_content,persistent:config.persistent,prompt_length:config.prompt?config.prompt.length:0})
startContentPolling()}).catch(error=>{console.error('âŒ é…ç½®åŠ è½½å¤±è´¥:',error)
setTimeout(()=>{console.log('ğŸ”„ é…ç½®åŠ è½½å¤±è´¥ï¼Œå»¶è¿Ÿå¯åŠ¨è½®è¯¢...')
startContentPolling()},3000)})
initializeImageFeatures()
startPeriodicCleanup()
initializeShortcutTooltip()
notificationManager.init().then(()=>{console.log('é€šçŸ¥ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ')
settingsManager.applySettings()
setTimeout(()=>{settingsManager.updateStatus()},100)}).catch(error=>{console.warn('é€šçŸ¥ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:',error)})
document.getElementById('insert-code-btn').addEventListener('click',insertCodeFromClipboard)
document.getElementById('submit-btn').addEventListener('click',submitFeedback)
document.getElementById('close-btn').addEventListener('click',closeInterface)
document.addEventListener('keydown',event=>{const isMac=detectPlatform()==='mac'
const ctrlOrCmd=isMac?event.metaKey:event.ctrlKey
const altOrOption=isMac?event.altKey:event.altKey
if(ctrlOrCmd&&event.key==='Enter'){event.preventDefault()
submitFeedback()}else if(altOrOption&&event.key==='c'){event.preventDefault()
insertCodeFromClipboard()}else if(ctrlOrCmd&&event.key==='v'){console.log(`å¿«æ·é”®: ${isMac ? 'Cmd' : 'Ctrl'}+V ç²˜è´´`)}else if(ctrlOrCmd&&event.key==='u'){event.preventDefault()
document.getElementById('upload-image-btn').click()
console.log(`å¿«æ·é”®: ${isMac ? 'Cmd' : 'Ctrl'}+U ä¸Šä¼ å›¾ç‰‡`)}else if(event.key==='Delete'&&selectedImages.length>0){event.preventDefault()
clearAllImages()
console.log('å¿«æ·é”®: Delete æ¸…é™¤æ‰€æœ‰å›¾ç‰‡')}else if(ctrlOrCmd&&event.shiftKey&&event.key==='N'){event.preventDefault()
testNotification()
console.log(`å¿«æ·é”®: ${isMac ? 'Cmd' : 'Ctrl'}+Shift+N æµ‹è¯•é€šçŸ¥`)}})
function enableAudioOnFirstInteraction(){if(notificationManager.audioContext&&notificationManager.audioContext.state==='suspended'){notificationManager.audioContext.resume().then(()=>{console.log('éŸ³é¢‘ä¸Šä¸‹æ–‡å·²å¯ç”¨')}).catch(error=>{console.warn('å¯ç”¨éŸ³é¢‘ä¸Šä¸‹æ–‡å¤±è´¥:',error)})}}
document.addEventListener('click',enableAudioOnFirstInteraction,{once:true})
document.addEventListener('keydown',enableAudioOnFirstInteraction,{once:true})
document.addEventListener('touchstart',enableAudioOnFirstInteraction,{once:true})
async function testNotification(){try{await notificationManager.sendNotification('é€šçŸ¥æµ‹è¯•','è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯é€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ',{tag:'test-notification',requireInteraction:false})
showStatus('æµ‹è¯•é€šçŸ¥å·²å‘é€','success')}catch(error){console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:',error)
showStatus('æµ‹è¯•é€šçŸ¥å¤±è´¥','error')}}})