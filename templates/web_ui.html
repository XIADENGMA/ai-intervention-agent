<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>AI Intervention Agent</title>
    <link rel="icon" type="image/svg+xml" href="/icons/icon.svg" sizes="any" />
    <link rel="mask-icon" href="/icons/icon.svg" color="#8B5CF6" />
    <link rel="apple-touch-icon" href="/icons/icon.svg" />

    <!-- MathJax 数学公式支持 -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [
            ['$', '$'],
            ['\\(', '\\)']
          ],
          displayMath: [
            ['$$', '$$'],
            ['\\[', '\\]']
          ],
          processEscapes: true,
          processEnvironments: true,
          packages: { '[+]': ['ams', 'newcommand', 'configmacros'] },
          tags: 'ams'
        },
        options: {
          skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        },
        startup: {
          ready: () => {
            console.log('MathJax 已加载完成')
            MathJax.startup.defaultReady()
          }
        }
      }
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    ></script>

    <style>
      /* 自定义字体声明 */
      @font-face {
        font-family: 'SFProText';
        src: url('/fonts/SFProText-Regular.woff2') format('woff2');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      @font-face {
        font-family: 'MonoLisaNerdFont';
        src: url('/fonts/MonoLisaNerdFont-Regular.woff2') format('woff2');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'SFProText', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text',
          'Helvetica Neue', 'Microsoft YaHei', 'PingFang SC', Arial, sans-serif;
        background: #1a1a1f;
        /* 移除复杂背景渐变以提升性能 */
        color: #f5f5f7;
        min-height: 100vh;
        padding: 1rem 0;
        line-height: 1.47059;
        font-weight: 400;
        letter-spacing: -0.022em;
        overflow-x: hidden;
        box-sizing: border-box;
        /* 移除背景动画以提升性能 */
      }

      /* 无内容状态下的特殊样式 */
      body.no-content-mode {
        height: 100vh;
        overflow: hidden;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding: 3rem 0;
        box-sizing: border-box;
      }

      /* 移除背景动画定义以提升性能 */

      .container {
        max-width: 720px;
        margin: 0 auto;
        background: rgba(45, 45, 60, 0.9);
        /* 移除毛玻璃效果以提升性能 */
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 32px;
        padding: 0;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        position: relative;
        /* 移除过渡动画以提升性能 */
      }

      /* 无内容模式下的容器样式 */
      body.no-content-mode .container {
        margin: 0;
        width: 100%;
        max-width: 720px;
        max-height: calc(100vh - 6rem);
        overflow: hidden;
        flex-shrink: 0;
      }

      /* 移除容器悬停效果以提升性能 */

      .container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      }

      .header {
        background: rgba(30, 30, 40, 0.8);
        /* 移除毛玻璃效果 */
        padding: 1rem 1.75rem;
        border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
        position: relative;
      }

      .header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 1.75rem;
        right: 1.75rem;
        height: 0.5px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      }

      h1 {
        color: #f5f5f7;
        margin: 0;
        font-size: 1.375rem;
        font-weight: 600;
        letter-spacing: -0.01em;
        display: flex;
        align-items: center;
        gap: 0.625rem;
      }

      .header-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .content {
        padding: 1.75rem;
      }

      .feedback-group {
        background: transparent;
        border: none;
        padding: 0;
        margin: 0;
      }

      .description {
        font-size: 1rem;
        margin-bottom: 1.5rem;
        padding: 1.5rem 1.75rem;
        background: linear-gradient(
          135deg,
          rgba(0, 122, 255, 0.08) 0%,
          rgba(88, 86, 214, 0.06) 50%,
          rgba(175, 82, 222, 0.05) 100%
        );
        border: 1px solid rgba(0, 122, 255, 0.25);
        border-radius: 24px;
        color: #f5f5f7;
        line-height: 1.6;
        letter-spacing: -0.022em;
        position: relative;
        /* 移除毛玻璃效果 */
        box-shadow: 0 4px 8px rgba(0, 122, 255, 0.1);
      }

      .description::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        border-radius: 24px 24px 0 0;
      }

      .options-container {
        margin-bottom: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1rem; /* 增加选项间距 */
      }

      .option-item {
        display: flex;
        align-items: center;
        padding: 1.25rem 1.5rem;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.06) 0%,
          rgba(255, 255, 255, 0.03) 50%,
          rgba(255, 255, 255, 0.05) 100%
        );
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 20px;
        /* 移除过渡动画 */
        cursor: pointer;
        position: relative;
        /* 移除毛玻璃效果 */
        margin-bottom: 0.75rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      }

      .option-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
        border-radius: 20px 20px 0 0;
      }

      .option-item:hover {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0.06) 50%,
          rgba(255, 255, 255, 0.08) 100%
        );
        border-color: rgba(0, 122, 255, 0.4);
        /* 移除transform效果 */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
      }

      .option-item input[type='checkbox'] {
        margin-right: 1rem; /* 增加复选框与文字的间距 */
        width: 18px; /* 增大复选框尺寸 */
        height: 18px;
        accent-color: #007aff;
        cursor: pointer;
      }

      .option-item label {
        font-size: 1rem; /* 增大字体 */
        cursor: pointer;
        color: #f5f5f7;
        flex: 1;
        font-weight: 400;
        letter-spacing: -0.022em;
        line-height: 1.5; /* 增加行高 */
      }

      .separator {
        height: 0.5px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        margin: 1.25rem 0;
      }

      .feedback-textarea {
        width: 100%;
        min-height: 180px;
        padding: 1.5rem 1.75rem;
        font-size: 1rem;
        font-family: 'MonoLisaNerdFont', 'SF Mono', ui-monospace, SFMono-Regular, Monaco, Consolas,
          'Liberation Mono', 'Courier New', monospace;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.06) 0%,
          rgba(255, 255, 255, 0.03) 50%,
          rgba(255, 255, 255, 0.05) 100%
        );
        color: #f5f5f7;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 24px;
        resize: vertical;
        margin-bottom: 1rem;
        /* 移除过渡动画 */
        line-height: 1.6;
        letter-spacing: -0.022em;
        /* 移除毛玻璃效果 */
        position: relative;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .feedback-textarea:focus {
        outline: none;
        border-color: rgba(0, 122, 255, 0.5);
        box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.3);
        background: rgba(255, 255, 255, 0.08);
        /* 移除transform效果 */
      }

      .feedback-textarea::placeholder {
        color: rgba(245, 245, 247, 0.6);
        font-weight: 400;
      }

      .button-container {
        display: flex;
        gap: 0.625rem;
        justify-content: flex-end;
        margin-top: 1.25rem;
      }

      .btn {
        padding: 1rem 1.75rem;
        font-size: 0.9375rem;
        font-weight: 600;
        font-family: inherit;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        /* 移除过渡动画 */
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 130px;
        justify-content: center;
        letter-spacing: -0.022em;
        position: relative;
        /* 移除毛玻璃效果 */
        overflow: hidden;
      }

      .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        border-radius: 20px 20px 0 0;
      }

      .btn::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
        border-radius: 20px;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .btn:hover::after {
        opacity: 1;
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: #f5f5f7;
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.25);
        /* 移除transform效果 */
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .btn-primary {
        background: #007aff;
        color: white;
        border: 1px solid rgba(0, 122, 255, 0.3);
        box-shadow: 0 4px 8px rgba(0, 122, 255, 0.2);
      }

      .btn-primary:hover {
        background: #0056cc;
        /* 移除transform效果 */
        box-shadow: 0 6px 12px rgba(0, 122, 255, 0.3);
      }

      .btn:disabled {
        background: rgba(255, 255, 255, 0.03);
        color: rgba(245, 245, 247, 0.3);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        border-color: rgba(255, 255, 255, 0.05);
      }

      .status-message {
        margin-top: 1rem;
        padding: 0.875rem 1.125rem;
        border-radius: 12px;
        text-align: center;
        display: none;
        font-size: 0.9375rem;
        font-weight: 500;
        letter-spacing: -0.022em;
        /* 移除毛玻璃效果 */
        position: relative;
      }

      .status-message::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 0.5px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        border-radius: 12px 12px 0 0;
      }

      .status-success {
        background: rgba(52, 199, 89, 0.08);
        color: #34c759;
        border: 0.5px solid rgba(52, 199, 89, 0.2);
      }

      .status-error {
        background: rgba(255, 69, 58, 0.08);
        color: #ff453a;
        border: 0.5px solid rgba(255, 69, 58, 0.2);
      }

      .shortcut-hint {
        font-size: 0.8125rem;
        color: rgba(245, 245, 247, 0.6);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.375rem;
        font-weight: 400;
        letter-spacing: -0.022em;
      }

      .shortcut-hint::before {
        content: '⌨️';
        font-size: 0.8125rem;
        opacity: 0.8;
      }

      /* 高性能Markdown渲染样式 */
      .markdown-content {
        line-height: 1.5;
        color: #f5f5f7;
        /* 优化渲染性能 */
        contain: layout style;
        will-change: auto;
        transform: translateZ(0); /* 启用硬件加速 */
      }

      .markdown-content h1,
      .markdown-content h2,
      .markdown-content h3,
      .markdown-content h4,
      .markdown-content h5,
      .markdown-content h6 {
        color: #f5f5f7;
        font-weight: 600;
        margin: 1rem 0 0.5rem 0;
      }

      .markdown-content h1 {
        font-size: 1.5rem;
      }
      .markdown-content h2 {
        font-size: 1.25rem;
      }
      .markdown-content h3 {
        font-size: 1.125rem;
      }
      .markdown-content h4 {
        font-size: 1rem;
      }

      .markdown-content p {
        margin: 0.75rem 0;
        color: #f5f5f7;
      }

      /* 简洁稳健的列表样式 - 使用标准CSS */
      .markdown-content ul,
      .markdown-content ol {
        margin: 0.75rem 0;
        padding-left: 1.5rem;
        color: #f5f5f7;
        line-height: 1.6;
      }

      .markdown-content ul {
        list-style-type: disc;
        list-style-position: outside;
      }

      .markdown-content ol {
        list-style-type: decimal;
        list-style-position: outside;
      }

      .markdown-content li {
        margin: 0.375rem 0;
        color: #f5f5f7;
        line-height: 1.6;
      }

      /* 自定义列表标记颜色 */
      .markdown-content ul li::marker {
        color: #f5f5f7;
        font-size: 1.1em;
      }

      .markdown-content ol li::marker {
        color: #f5f5f7;
        font-weight: 600;
      }

      /* 嵌套列表样式 */
      .markdown-content ul ul {
        list-style-type: circle;
        margin: 0.25rem 0;
        padding-left: 1.25rem;
      }

      .markdown-content ul ul ul {
        list-style-type: square;
      }

      .markdown-content ol ol {
        list-style-type: lower-alpha;
        margin: 0.25rem 0;
        padding-left: 1.25rem;
      }

      .markdown-content ol ol ol {
        list-style-type: lower-roman;
      }

      /* 列表项内容样式 */
      .markdown-content li p {
        margin: 0.25rem 0;
      }

      .markdown-content li > *:first-child {
        margin-top: 0;
      }

      .markdown-content li > *:last-child {
        margin-bottom: 0;
      }

      .markdown-content blockquote {
        margin: 1rem 0;
        padding: 0.75rem 1rem;
        background: rgba(0, 122, 255, 0.08);
        border-left: 3px solid #007aff;
        color: #f5f5f7;
      }

      /* 内联代码样式 */
      .markdown-content code {
        background: rgba(255, 255, 255, 0.12);
        color: #ff453a;
        padding: 0.125rem 0.375rem;
        font-family: 'MonoLisaNerdFont', monospace;
        font-size: 0.875rem;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      /* 代码块容器样式 - 现代化设计 */
      .code-block-container {
        position: relative;
        margin: 1.5rem 0;
        border-radius: 20px;
        background: linear-gradient(
          135deg,
          rgba(15, 15, 25, 0.95) 0%,
          rgba(25, 25, 40, 0.9) 50%,
          rgba(20, 20, 35, 0.95) 100%
        );
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4), 0 4px 8px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        overflow: hidden;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }

      .code-block-container:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.5), 0 6px 12px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.15);
        border-color: rgba(0, 122, 255, 0.3);
      }

      /* 移除代码块装饰线以简化样式 */

      /* 代码块样式 - 优化版 */
      .markdown-content pre {
        background: transparent;
        border: none;
        padding: 1.5rem 1.75rem;
        margin: 0;
        overflow-x: auto;
        border-radius: 20px;
        font-size: 0.9rem;
        line-height: 1.6;
        position: relative;
      }

      .markdown-content pre code {
        background: none;
        color: #f5f5f7;
        padding: 0;
        font-family: 'MonoLisaNerdFont', 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono',
          'Consolas', monospace;
        font-size: inherit;
        font-weight: 400;
        letter-spacing: 0.025em;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        text-decoration: none !important;
      }

      /* 强制覆盖代码高亮背景 */
      .markdown-content .highlight,
      .markdown-content div[style*='background'] {
        background: transparent !important;
      }

      /* 移除代码块内所有文本装饰 */
      .markdown-content pre *,
      .markdown-content code *,
      .markdown-content pre,
      .markdown-content code {
        text-decoration: none !important;
        text-decoration-line: none !important;
        text-decoration-style: none !important;
        text-decoration-color: transparent !important;
        text-decoration-thickness: 0 !important;
        text-underline-offset: 0 !important;
        border-bottom: none !important;
        border-top: none !important;
        outline: none !important;
        box-shadow: none !important;
      }

      /* 强制移除所有代码相关元素的下划线 */
      .code-block-container *,
      .code-block-container,
      pre *,
      pre,
      code *,
      code,
      .highlight *,
      .highlight {
        text-decoration: none !important;
        text-decoration-line: none !important;
        text-decoration-style: none !important;
        text-decoration-color: transparent !important;
        text-decoration-thickness: 0 !important;
        text-underline-offset: 0 !important;
        border-bottom: none !important;
        border-top: none !important;
      }

      /* 完全隐藏代码块滚动条但保持滚动功能 */
      .markdown-content pre::-webkit-scrollbar {
        display: none !important;
        width: 0 !important;
        height: 0 !important;
      }

      .code-block-container pre::-webkit-scrollbar {
        display: none !important;
        width: 0 !important;
        height: 0 !important;
      }

      /* 对于Firefox浏览器隐藏滚动条 */
      .markdown-content pre {
        scrollbar-width: none !important;
        -ms-overflow-style: none !important;
      }

      .code-block-container pre {
        scrollbar-width: none !important;
        -ms-overflow-style: none !important;
      }

      /* 代码工具栏样式 - 现代化设计 */
      .code-toolbar {
        position: absolute;
        top: 16px;
        right: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 10;
        opacity: 0.8;
        transition: opacity 0.3s ease;
      }

      .code-block-container:hover .code-toolbar {
        opacity: 1;
      }

      /* 语言标识样式 - 精美设计 */
      .language-label {
        background: linear-gradient(135deg, rgba(0, 122, 255, 0.25), rgba(88, 86, 214, 0.2));
        border: 1px solid rgba(0, 122, 255, 0.4);
        border-radius: 8px;
        padding: 5px 10px;
        font-size: 0.7rem;
        color: #4fc3f7;
        font-weight: 700;
        font-family: inherit;
        backdrop-filter: blur(15px);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
        transition: all 0.3s ease;
      }

      .language-label:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        border-color: rgba(0, 122, 255, 0.6);
      }

      /* 复制按钮样式 - 精美设计 */
      .copy-button {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.08));
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 10px;
        padding: 7px 12px;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.9);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-family: inherit;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 5px;
        backdrop-filter: blur(15px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        position: relative;
        overflow: hidden;
      }

      .copy-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s ease;
      }

      .copy-button:hover::before {
        left: 100%;
      }

      .copy-button:hover {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.12));
        border-color: rgba(255, 255, 255, 0.4);
        color: #fff;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
      }

      .copy-button:active {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .copy-button.copied {
        background: linear-gradient(135deg, rgba(52, 199, 89, 0.25), rgba(52, 199, 89, 0.15));
        border-color: rgba(52, 199, 89, 0.5);
        color: #4caf50;
        box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
      }

      .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        background: rgba(255, 255, 255, 0.03);
      }

      .markdown-content th,
      .markdown-content td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: #f5f5f7;
      }

      .markdown-content th {
        background: rgba(0, 122, 255, 0.1);
        font-weight: 600;
      }

      .markdown-content a {
        color: #007aff;
        text-decoration: none;
      }

      .markdown-content a:hover {
        text-decoration: underline;
      }

      /* 删除线样式 */
      .markdown-content del,
      .markdown-content s,
      .markdown-content .strikethrough {
        text-decoration: line-through;
        color: rgba(245, 245, 247, 0.6);
        text-decoration-color: rgba(245, 245, 247, 0.6);
        text-decoration-thickness: 2px;
      }

      .markdown-content hr {
        border: none;
        height: 1px;
        background: rgba(255, 255, 255, 0.2);
        margin: 1.5rem 0;
      }

      /* 加载动画 */
      @keyframes loading {
        0% {
          transform: translateX(-100%);
        }
        50% {
          transform: translateX(0%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      /* 移除所有动画定义以提升性能 */

      /* 移除浮动动画以提升性能 */

      /* 移动端适配 */
      @media (max-width: 768px) {
        body {
          padding: 0;
          font-size: 16px; /* 防止iOS缩放 */
          min-height: 100vh;
          min-height: 100dvh; /* 使用动态视口高度 */
          max-height: 100vh;
          max-height: 100dvh;
          overflow-y: auto;
        }

        body.no-content-mode {
          padding: 0;
          height: 100vh;
          height: 100dvh; /* 使用动态视口高度 */
          overflow: hidden;
        }

        .container {
          max-width: 100%;
          margin: 0;
          border-radius: 0;
          box-shadow: none;
          border: none;
          background: transparent;
          min-height: 100vh;
          min-height: 100dvh;
          display: flex;
          flex-direction: column;
        }

        body.no-content-mode .container {
          margin: 0;
          height: 100vh;
          height: 100dvh;
          max-height: 100vh;
          max-height: 100dvh;
          background: transparent;
          overflow: hidden;
        }

        .header {
          padding: 0.75rem 1.25rem;
          /* 添加iOS安全区域支持，确保标题不被状态栏遮挡 */
          padding-top: max(0.75rem, env(safe-area-inset-top));
          background: transparent;
          border-bottom: none;
          flex-shrink: 0;
        }

        h1 {
          font-size: 1.25rem;
        }

        .content {
          padding: 1rem 1.25rem;
          background: transparent;
          flex: 1;
          overflow-y: auto;
          display: flex;
          flex-direction: column;
        }

        .feedback-group {
          display: flex;
          flex-direction: column;
          height: 100%;
        }

        .description {
          padding: 1rem 1.25rem;
          border-radius: 20px;
          font-size: 0.95rem;
          margin-bottom: 1rem;
          flex-shrink: 0;
        }

        .option-item {
          padding: 1rem 1.25rem;
          border-radius: 16px;
          margin-bottom: 0.5rem;
        }

        .option-item input[type='checkbox'] {
          width: 20px;
          height: 20px;
          margin-right: 0.75rem;
        }

        .option-item label {
          font-size: 0.95rem;
          line-height: 1.4;
        }

        .feedback-textarea {
          min-height: 100px;
          max-height: 30vh;
          padding: 1rem 1.25rem;
          border-radius: 20px;
          font-size: 16px; /* 防止iOS缩放 */
          line-height: 1.5;
          flex-shrink: 0;
        }

        .button-container {
          flex-direction: column;
          gap: 0.75rem;
          margin-top: 1rem;
          flex-shrink: 0;
        }

        .btn {
          padding: 0.875rem 1.5rem;
          font-size: 0.9rem;
          border-radius: 16px;
          min-width: auto;
          width: 100%;
        }

        .shortcut-hint {
          font-size: 0.8rem;
          margin-bottom: 0.75rem;
          text-align: center;
        }

        .status-message {
          margin-top: 0.75rem;
          padding: 0.75rem 1rem;
          border-radius: 10px;
          font-size: 0.9rem;
        }

        /* 无有效内容页面移动端适配 */
        #no-content-container {
          padding: 2rem 1.25rem !important;
          min-height: 300px !important;
        }

        #no-content-container h2 {
          font-size: 1.5rem !important;
          margin-bottom: 0.75rem !important;
        }

        #no-content-container p {
          font-size: 0.95rem !important;
          margin-bottom: 1.5rem !important;
        }

        #no-content-container .button-container {
          margin-top: 1.5rem !important;
        }

        /* 进度条适配 */
        #no-content-container > div:nth-child(4) {
          width: 200px !important;
        }

        /* Markdown内容移动端适配 */
        .markdown-content {
          font-size: 0.95rem;
        }

        .markdown-content h1 {
          font-size: 1.3rem;
        }

        .markdown-content h2 {
          font-size: 1.15rem;
        }

        .markdown-content h3 {
          font-size: 1.05rem;
        }

        .code-block-container {
          border-radius: 16px;
          margin: 1rem 0;
          transform: none !important; /* 禁用移动端悬停效果 */
        }

        .code-block-container:hover {
          transform: none !important;
        }

        .markdown-content pre {
          padding: 1rem 1.25rem;
          font-size: 0.85rem;
          overflow-x: auto;
          border-radius: 16px;
        }

        .markdown-content code {
          font-size: 0.8rem;
          padding: 0.1rem 0.3rem;
          border-radius: 4px;
        }

        .code-toolbar {
          top: 10px;
          right: 10px;
          gap: 8px;
          opacity: 1; /* 移动端始终显示 */
        }

        .language-label {
          padding: 4px 8px;
          font-size: 0.65rem;
          border-radius: 6px;
        }

        .copy-button {
          padding: 5px 10px;
          font-size: 0.7rem;
          border-radius: 8px;
        }

        /* 移动端也完全隐藏滚动条 */
        .markdown-content pre::-webkit-scrollbar,
        .code-block-container pre::-webkit-scrollbar {
          display: none !important;
          width: 0 !important;
          height: 0 !important;
        }

        .markdown-content pre,
        .code-block-container pre {
          scrollbar-width: none !important;
          -ms-overflow-style: none !important;
        }

        .markdown-content table {
          font-size: 0.85rem;
        }

        .markdown-content th,
        .markdown-content td {
          padding: 0.5rem;
        }

        /* 移动端列表样式优化 */
        .markdown-content ul,
        .markdown-content ol {
          padding-left: 1.5rem;
          margin: 0.5rem 0;
        }

        .markdown-content ul li,
        .markdown-content ol li {
          margin: 0.375rem 0;
          padding-left: 1rem;
          font-size: 0.95rem;
        }

        .markdown-content ul li::before {
          font-size: 1.1em;
        }

        .markdown-content ul ul,
        .markdown-content ol ol,
        .markdown-content ul ol,
        .markdown-content ol ul {
          padding-left: 1rem;
        }
      }

      /* 小屏幕手机适配 */
      @media (max-width: 480px) {
        body {
          padding: 0;
          min-height: 100vh;
          min-height: 100dvh; /* 使用动态视口高度 */
          max-height: 100vh;
          max-height: 100dvh;
          overflow-y: auto;
        }

        body.no-content-mode {
          padding: 0;
          height: 100vh;
          height: 100dvh; /* 使用动态视口高度 */
          overflow: hidden;
        }

        .container {
          margin: 0;
          border-radius: 0;
          box-shadow: none;
          border: none;
          background: transparent;
          min-height: 100vh;
          min-height: 100dvh;
          display: flex;
          flex-direction: column;
        }

        body.no-content-mode .container {
          margin: 0;
          height: 100vh;
          height: 100dvh;
          max-height: 100vh;
          max-height: 100dvh;
          background: transparent;
          overflow: hidden;
        }

        .header {
          padding: 0.75rem 1rem;
          /* 添加iOS安全区域支持，确保标题不被状态栏遮挡 */
          padding-top: max(0.75rem, env(safe-area-inset-top));
          background: transparent;
          border-bottom: none;
          flex-shrink: 0;
        }

        h1 {
          font-size: 1.125rem;
        }

        .content {
          padding: 0.75rem 1rem;
          background: transparent;
          flex: 1;
          overflow-y: auto;
          display: flex;
          flex-direction: column;
        }

        .feedback-group {
          display: flex;
          flex-direction: column;
          height: 100%;
        }

        .description {
          padding: 1rem 1.25rem;
          font-size: 0.9rem;
        }

        .feedback-textarea {
          min-height: 80px;
          max-height: 25vh;
          padding: 0.875rem 1rem;
          font-size: 16px;
          flex-shrink: 0;
        }

        .btn {
          padding: 0.75rem 1.25rem;
          font-size: 0.85rem;
        }

        #no-content-container {
          padding: 1.5rem 1rem !important;
          min-height: 250px !important;
        }

        #no-content-container h2 {
          font-size: 1.25rem !important;
        }

        #no-content-container p {
          font-size: 0.9rem !important;
        }

        /* 进度条适配 */
        #no-content-container > div:nth-child(4) {
          width: 160px !important;
          height: 4px !important;
        }

        /* 小屏幕列表样式优化 */
        .markdown-content ul,
        .markdown-content ol {
          padding-left: 1.25rem;
          margin: 0.375rem 0;
        }

        .markdown-content ul li,
        .markdown-content ol li {
          margin: 0.3rem 0;
          padding-left: 0;
          font-size: 0.9rem;
        }

        .markdown-content ul li::before {
          font-size: 1em;
        }

        .markdown-content ul ul,
        .markdown-content ol ol,
        .markdown-content ul ol,
        .markdown-content ol ul {
          padding-left: 1.25rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>
          <div class="header-icon">
            <svg width="32" height="32" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="masterBg" x1="50%" y1="0%" x2="50%" y2="100%">
                  <stop offset="0%" style="stop-color: #e8ecf5" />
                  <stop offset="100%" style="stop-color: #dee4f1" />
                </linearGradient>
                <radialGradient id="aiFluidCore" cx="50%" cy="50%" r="70%" fx="52%" fy="48%">
                  <stop offset="0%" style="stop-color: #a855f7; stop-opacity: 1" />
                  <stop offset="30%" style="stop-color: #8b5cf6; stop-opacity: 0.95" />
                  <stop offset="60%" style="stop-color: #6366f1; stop-opacity: 0.9" />
                  <stop offset="100%" style="stop-color: #312e81; stop-opacity: 0.85" />
                </radialGradient>
                <linearGradient id="interventionControl" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color: #fde047" />
                  <stop offset="30%" style="stop-color: #facc15" />
                  <stop offset="70%" style="stop-color: #eab308" />
                  <stop offset="100%" style="stop-color: #ca8a04" />
                </linearGradient>
              </defs>
              <g>
                <rect
                  x="10"
                  y="10"
                  width="100"
                  height="100"
                  rx="22.5"
                  ry="22.5"
                  fill="url(#masterBg)"
                />
              </g>
              <g transform="translate(60,60) scale(0.95)">
                <g>
                  <path
                    id="aiShape"
                    d="M 0 -35
                           Q 30 -35, 30 0
                           Q 30 35, 0 35
                           Q -30 35, -30 0
                           Q -30 -35, 0 -35 Z
                           M 0 -25
                           Q 20 -25, 20 0
                           Q 20 25, 0 25
                           Q -20 25, -20 0
                           Q -20 -25, 0 -25 Z"
                    fill-rule="evenodd"
                    fill="url(#aiFluidCore)"
                    transform="rotate(15)"
                  />
                </g>
                <g transform="translate(0, -1)">
                  <path
                    d="M -15 -22
                           L -7 -22
                           C -5.5 -22, -4.5 -21, -4.5 -19.5
                           L -4.5 19.5
                           C -4.5 21, -5.5 22, -7 22
                           L -15 22
                           C -16.5 22, -17.5 21, -17.5 19.5
                           L -17.5 -19.5
                           C -17.5 -21, -16.5 -22, -15 -22 Z"
                    fill="url(#interventionControl)"
                  />
                  <path
                    d="M 4.5 -22
                           L 12.5 -22
                           C 14 -22, 15 -21, 15 -19.5
                           L 15 19.5
                           C 15 21, 14 22, 12.5 22
                           L 4.5 22
                           C 3 22, 2 21, 2 19.5
                           L 2 -19.5
                           C 2 -21, 3 -22, 4.5 -22 Z"
                    fill="url(#interventionControl)"
                  />
                </g>
              </g>
            </svg>
          </div>
          AI Intervention Agent
        </h1>
      </div>

      <!-- 无有效内容页面 -->
      <div
        id="no-content-container"
        style="
          display: none;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 3rem 1.75rem;
          text-align: center;
          min-height: 400px;
        "
      >
        <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.8">⏳</div>
        <h2 style="color: #f5f5f7; font-size: 2rem; margin-bottom: 0.5rem; font-weight: 600">
          无有效内容
        </h2>
        <p style="color: #8e8e93; font-size: 1rem; margin-bottom: 2rem">等待新的反馈请求...</p>
        <div
          style="
            width: 240px;
            height: 6px;
            background: linear-gradient(
              135deg,
              rgba(255, 255, 255, 0.1),
              rgba(255, 255, 255, 0.05)
            );
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) inset;
          "
        >
          <div
            style="
              width: 100%;
              height: 100%;
              background: #007aff;
              animation: loading 1.5s linear infinite;
              border-radius: 8px;
            "
          ></div>
        </div>
        <div
          class="button-container"
          id="no-content-buttons"
          style="display: none; margin-top: 2rem"
        >
          <button class="btn btn-secondary" id="close-btn">❌ 关闭服务</button>
        </div>
        <!-- 无内容页面的状态消息显示区域 -->
        <div
          class="status-message"
          id="no-content-status-message"
          style="display: none; margin-top: 1rem"
        ></div>
      </div>

      <!-- 正常内容页面 -->
      <div id="content-container" class="content">
        <div class="feedback-group">
          <div class="description markdown-content" id="description">加载中...</div>

          <div class="options-container" id="options-container" style="display: none">
            <!-- 预定义选项将在这里动态加载 -->
          </div>

          <div class="separator" id="separator" style="display: none"></div>

          <textarea
            class="feedback-textarea"
            id="feedback-text"
            placeholder="请在此输入您的反馈内容..."
          ></textarea>

          <div class="shortcut-hint">按 Ctrl+Enter 快速提交反馈</div>

          <div class="button-container">
            <button class="btn btn-secondary" id="insert-code-btn">📋 插入代码</button>
            <button class="btn btn-primary" id="submit-btn">🚀 发送请求</button>
          </div>

          <div class="status-message" id="status-message"></div>
        </div>
      </div>
    </div>

    <script>
      let config = null

      // 高性能markdown渲染函数
      function renderMarkdownContent(element, htmlContent) {
        // 使用requestAnimationFrame优化渲染时机
        requestAnimationFrame(() => {
          if (htmlContent) {
            // 批量DOM操作优化
            const fragment = document.createDocumentFragment()
            const tempDiv = document.createElement('div')
            tempDiv.innerHTML = htmlContent

            // 移动所有子节点到fragment
            while (tempDiv.firstChild) {
              fragment.appendChild(tempDiv.firstChild)
            }

            // 一次性更新DOM
            element.innerHTML = ''
            element.appendChild(fragment)

            // 处理代码块，添加复制按钮
            processCodeBlocks(element)

            // 处理删除线语法
            processStrikethrough(element)

            // 重新渲染 MathJax 公式
            if (window.MathJax && window.MathJax.typesetPromise) {
              window.MathJax.typesetPromise([element]).catch(err => {
                console.warn('MathJax 渲染失败:', err)
              })
            }
          } else {
            element.textContent = '加载中...'
          }
        })
      }

      // 处理代码块，添加复制按钮和语言标识
      function processCodeBlocks(container) {
        const codeBlocks = container.querySelectorAll('pre')

        codeBlocks.forEach(pre => {
          // 检查是否已经被处理过
          if (pre.parentElement && pre.parentElement.classList.contains('code-block-container')) {
            return
          }

          // 创建代码块容器
          const codeContainer = document.createElement('div')
          codeContainer.className = 'code-block-container'

          // 将 pre 元素包装在容器中
          pre.parentNode.insertBefore(codeContainer, pre)
          codeContainer.appendChild(pre)

          // 检测语言类型
          const codeElement = pre.querySelector('code')
          let language = 'text'
          if (codeElement && codeElement.className) {
            const langMatch = codeElement.className.match(/language-(\w+)/)
            if (langMatch) {
              language = langMatch[1]
            }
          }

          // 创建工具栏
          const toolbar = document.createElement('div')
          toolbar.className = 'code-toolbar'

          // 添加语言标识
          if (language !== 'text') {
            const langLabel = document.createElement('span')
            langLabel.className = 'language-label'
            langLabel.textContent = language.toUpperCase()
            toolbar.appendChild(langLabel)
          }

          // 创建复制按钮
          const copyButton = document.createElement('button')
          copyButton.className = 'copy-button'
          copyButton.innerHTML = '📋 复制'
          copyButton.setAttribute('aria-label', '复制代码')

          // 添加复制功能
          copyButton.addEventListener('click', () => {
            copyCodeToClipboard(pre, copyButton)
          })

          toolbar.appendChild(copyButton)

          // 将工具栏添加到容器中
          codeContainer.appendChild(toolbar)
        })
      }

      // 复制代码到剪贴板
      async function copyCodeToClipboard(preElement, button) {
        try {
          const codeElement = preElement.querySelector('code')
          const textToCopy = codeElement ? codeElement.textContent : preElement.textContent

          await navigator.clipboard.writeText(textToCopy)

          // 更新按钮状态
          const originalText = button.innerHTML
          button.innerHTML = '✅ 已复制'
          button.classList.add('copied')

          // 2秒后恢复原状
          setTimeout(() => {
            button.innerHTML = originalText
            button.classList.remove('copied')
          }, 2000)
        } catch (err) {
          console.error('复制失败:', err)

          // 显示错误状态
          const originalText = button.innerHTML
          button.innerHTML = '❌ 复制失败'

          setTimeout(() => {
            button.innerHTML = originalText
          }, 2000)
        }
      }

      // 处理删除线语法 ~~text~~
      function processStrikethrough(container) {
        // 获取所有文本节点，但排除代码块
        const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, {
          acceptNode: function (node) {
            // 排除代码块、pre、script 等标签内的文本
            const parent = node.parentElement
            if (
              parent &&
              (parent.tagName === 'CODE' ||
                parent.tagName === 'PRE' ||
                parent.tagName === 'SCRIPT' ||
                parent.tagName === 'STYLE' ||
                parent.closest('pre, code, script, style'))
            ) {
              return NodeFilter.FILTER_REJECT
            }
            return NodeFilter.FILTER_ACCEPT
          }
        })

        const textNodes = []
        let node
        while ((node = walker.nextNode())) {
          textNodes.push(node)
        }

        // 处理每个文本节点
        textNodes.forEach(textNode => {
          const text = textNode.textContent
          // 匹配 ~~删除线~~ 语法，但不匹配代码块中的
          const strikethroughRegex = /~~([^~\n]+?)~~/g

          if (strikethroughRegex.test(text)) {
            const newHTML = text.replace(strikethroughRegex, '<del>$1</del>')

            // 创建临时容器来解析 HTML
            const tempDiv = document.createElement('div')
            tempDiv.innerHTML = newHTML

            // 替换文本节点
            const fragment = document.createDocumentFragment()
            while (tempDiv.firstChild) {
              fragment.appendChild(tempDiv.firstChild)
            }

            textNode.parentNode.replaceChild(fragment, textNode)
          }
        })
      }

      // 加载配置
      async function loadConfig() {
        try {
          const response = await fetch('/api/config')
          config = await response.json()

          // 检查是否有有效内容
          if (!config.has_content) {
            showNoContentPage()
            // 不再显示动态状态消息，只保留HTML中的固定文本
            return
          }

          // 显示正常内容页面
          showContentPage()

          // 更新描述 - 使用高性能渲染函数
          const descriptionElement = document.getElementById('description')
          renderMarkdownContent(descriptionElement, config.prompt_html || config.prompt)

          // 加载预定义选项
          if (config.predefined_options && config.predefined_options.length > 0) {
            const optionsContainer = document.getElementById('options-container')
            const separator = document.getElementById('separator')

            config.predefined_options.forEach((option, index) => {
              const optionDiv = document.createElement('div')
              optionDiv.className = 'option-item'

              const checkbox = document.createElement('input')
              checkbox.type = 'checkbox'
              checkbox.id = `option-${index}`
              checkbox.value = option

              const label = document.createElement('label')
              label.htmlFor = `option-${index}`
              label.textContent = option

              optionDiv.appendChild(checkbox)
              optionDiv.appendChild(label)
              optionsContainer.appendChild(optionDiv)
            })

            optionsContainer.style.display = 'block'
            separator.style.display = 'block'
          }
        } catch (error) {
          console.error('加载配置失败:', error)
          showStatus('加载配置失败', 'error')
          throw error // 重新抛出错误，让调用者知道加载失败
        }
      }

      // 显示无内容页面
      function showNoContentPage() {
        document.getElementById('content-container').style.display = 'none'
        document.getElementById('no-content-container').style.display = 'flex'

        // 添加无内容模式的CSS类，启用特殊布局
        document.body.classList.add('no-content-mode')

        // 显示关闭按钮，让用户可以关闭服务
        if (config) {
          document.getElementById('no-content-buttons').style.display = 'block'
        }
      }

      // 显示内容页面
      function showContentPage() {
        document.getElementById('content-container').style.display = 'block'
        document.getElementById('no-content-container').style.display = 'none'

        // 移除无内容模式的CSS类，恢复正常布局
        document.body.classList.remove('no-content-mode')

        enableSubmitButton()
      }

      // 禁用提交按钮
      function disableSubmitButton() {
        const submitBtn = document.getElementById('submit-btn')
        const insertBtn = document.getElementById('insert-code-btn')
        const feedbackText = document.getElementById('feedback-text')

        if (submitBtn) {
          submitBtn.disabled = true
          submitBtn.style.backgroundColor = '#3a3a3c'
          submitBtn.style.color = '#8e8e93'
          submitBtn.style.cursor = 'not-allowed'
        }
        if (insertBtn) {
          insertBtn.disabled = true
          insertBtn.style.backgroundColor = '#3a3a3c'
          insertBtn.style.color = '#8e8e93'
          insertBtn.style.cursor = 'not-allowed'
        }
        if (feedbackText) {
          feedbackText.disabled = true
          feedbackText.style.backgroundColor = '#2c2c2e'
          feedbackText.style.color = '#8e8e93'
          feedbackText.style.cursor = 'not-allowed'
        }
      }

      // 启用提交按钮
      function enableSubmitButton() {
        const submitBtn = document.getElementById('submit-btn')
        const insertBtn = document.getElementById('insert-code-btn')
        const feedbackText = document.getElementById('feedback-text')

        if (submitBtn) {
          submitBtn.disabled = false
          submitBtn.style.backgroundColor = '#0a84ff'
          submitBtn.style.color = '#ffffff'
          submitBtn.style.cursor = 'pointer'
        }
        if (insertBtn) {
          insertBtn.disabled = false
          insertBtn.style.backgroundColor = '#48484a'
          insertBtn.style.color = '#ffffff'
          insertBtn.style.cursor = 'pointer'
        }
        if (feedbackText) {
          feedbackText.disabled = false
          feedbackText.style.backgroundColor = 'rgba(255, 255, 255, 0.03)'
          feedbackText.style.color = '#f5f5f7'
          feedbackText.style.cursor = 'text'
        }
      }

      // 显示状态消息
      function showStatus(message, type) {
        // 检查当前是否在无内容页面
        const isNoContentPage =
          document.getElementById('no-content-container').style.display === 'flex'
        const statusElement = isNoContentPage
          ? document.getElementById('no-content-status-message')
          : document.getElementById('status-message')

        statusElement.textContent = message
        statusElement.className = `status-message status-${type}`
        statusElement.style.display = 'block'

        if (type === 'success') {
          setTimeout(() => {
            statusElement.style.display = 'none'
          }, 3000)
        }
      }

      // 插入代码功能 - 与GUI版本逻辑完全一致
      async function insertCodeFromClipboard() {
        try {
          const text = await navigator.clipboard.readText()
          if (text) {
            const textarea = document.getElementById('feedback-text')
            const cursorPos = textarea.selectionStart
            const currentText = textarea.value
            const textBefore = currentText.substring(0, cursorPos)
            const textAfter = currentText.substring(cursorPos)

            // 构建要插入的代码块，在```前面总是添加换行
            let codeBlock = `\n\`\`\`\n${text}\n\`\`\``

            // 如果是在文本开头插入，则不需要前面的换行
            if (cursorPos === 0) {
              codeBlock = `\`\`\`\n${text}\n\`\`\``
            }

            // 插入代码块
            textarea.value = textBefore + codeBlock + textAfter

            // 将光标移动到代码块末尾（与GUI版本一致）
            const newCursorPos = textBefore.length + codeBlock.length
            textarea.setSelectionRange(newCursorPos, newCursorPos)
            textarea.focus()

            showStatus('代码已插入', 'success')
          } else {
            showStatus('剪贴板为空', 'error')
          }
        } catch (error) {
          console.error('读取剪贴板失败:', error)
          showStatus('无法读取剪贴板，请手动粘贴代码', 'error')
        }
      }

      // 提交反馈
      async function submitFeedback() {
        const feedbackText = document.getElementById('feedback-text').value.trim()
        const selectedOptions = []

        // 获取选中的预定义选项
        if (config && config.predefined_options) {
          config.predefined_options.forEach((option, index) => {
            const checkbox = document.getElementById(`option-${index}`)
            if (checkbox && checkbox.checked) {
              selectedOptions.push(option)
            }
          })
        }

        if (!feedbackText && selectedOptions.length === 0) {
          // 如果没有任何输入，显示错误信息
          showStatus('请输入反馈内容或选择预定义选项', 'error')
          return
        }

        try {
          const submitBtn = document.getElementById('submit-btn')
          submitBtn.disabled = true
          submitBtn.textContent = '提交中...'

          const response = await fetch('/api/submit', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              feedback_text: feedbackText,
              selected_options: selectedOptions
            })
          })

          const result = await response.json()

          if (response.ok) {
            showStatus(result.message, 'success')
            // 清空表单
            document.getElementById('feedback-text').value = ''
            // 取消选中所有复选框
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => (cb.checked = false))

            // 立即更新本地状态，然后隐藏反馈内容
            if (config) {
              config.has_content = false
              console.log('反馈提交后，本地状态已更新为无内容')
            }
            showNoContentPage()
            // 不再显示动态状态消息，只保留HTML中的固定文本
          } else {
            showStatus(result.message || '提交失败', 'error')
          }
        } catch (error) {
          console.error('提交失败:', error)
          showStatus('网络错误，请重试', 'error')
        } finally {
          const submitBtn = document.getElementById('submit-btn')
          submitBtn.disabled = false
          submitBtn.textContent = '🚀 提交反馈'
        }
      }

      // 关闭界面 - 简化版本，统一刷新逻辑
      async function closeInterface() {
        try {
          showStatus('正在关闭服务...', 'info')

          // 停止轮询
          stopContentPolling()

          const response = await fetch('/api/close', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          })

          const result = await response.json()
          if (response.ok) {
            showStatus('服务已关闭，正在刷新页面...', 'success')
          } else {
            showStatus('关闭失败，正在刷新页面...', 'error')
          }
        } catch (error) {
          console.error('关闭界面失败:', error)
          showStatus('关闭界面失败，正在刷新页面...', 'error')
        }

        // 无论成功还是失败，都在2秒后刷新页面
        setTimeout(() => {
          refreshPageSafely()
        }, 2000)
      }

      // 安全刷新页面函数
      function refreshPageSafely() {
        console.log('正在刷新页面...')
        try {
          window.location.reload()
        } catch (reloadError) {
          console.error('页面刷新失败:', reloadError)
          // 如果刷新失败，尝试跳转到根路径
          try {
            window.location.href = window.location.origin
          } catch (redirectError) {
            console.error('页面跳转失败:', redirectError)
            // 最后的备选方案：跳转到空白页
            try {
              window.location.href = 'about:blank'
            } catch (blankError) {
              console.error('所有页面操作都失败:', blankError)
            }
          }
        }
      }

      // 注意：原来的复杂关闭逻辑已被简化为统一的刷新逻辑

      // 内容轮询检查
      let pollingInterval = null
      function startContentPolling() {
        if (pollingInterval) {
          console.log('轮询已经在运行，跳过启动')
          return // 避免重复启动
        }

        console.log('开始启动内容轮询...')
        pollingInterval = setInterval(async () => {
          try {
            const response = await fetch('/api/config')
            const newConfig = await response.json()

            const currentHasContent = config ? config.has_content : false
            const newHasContent = newConfig.has_content

            console.log('轮询检查 - 当前状态:', currentHasContent, '新状态:', newHasContent)
            console.log('当前提示:', config ? config.prompt?.substring(0, 30) : 'null')
            console.log('新提示:', newConfig.prompt?.substring(0, 30))

            // 状态变化检测
            if (newHasContent && !currentHasContent) {
              // 从无内容状态变为有内容状态
              console.log('✅ 检测到新内容，更新页面')
              config = newConfig
              showContentPage()
              updatePageContent()
              showStatus('收到新的反馈请求！', 'success')
            } else if (!newHasContent && currentHasContent) {
              // 从有内容状态变为无内容状态
              console.log('📝 内容已清空，显示无内容页面')
              config = newConfig
              showNoContentPage()
              disableSubmitButton()
            } else if (newHasContent && currentHasContent) {
              // 都有内容，检查内容是否更新
              const promptChanged = newConfig.prompt !== (config ? config.prompt : '')
              const optionsChanged =
                JSON.stringify(newConfig.predefined_options) !==
                JSON.stringify(config ? config.predefined_options : [])

              if (promptChanged || optionsChanged) {
                console.log('🔄 检测到内容更新，刷新页面')
                config = newConfig
                updatePageContent()
                showStatus('内容已更新！', 'success')
              }
            } else {
              // 都没有内容，更新配置但不改变显示
              config = newConfig
            }
          } catch (error) {
            console.error('轮询错误:', error)
          }
        }, 2000) // 每2秒检查一次
        console.log('内容轮询已启动，间隔2秒')
      }

      function stopContentPolling() {
        if (pollingInterval) {
          clearInterval(pollingInterval)
          pollingInterval = null
        }
      }

      // 更新页面内容
      function updatePageContent() {
        if (!config) return

        // 更新提示内容 - 使用高性能渲染函数
        const descriptionElement = document.getElementById('description')
        if (descriptionElement) {
          renderMarkdownContent(descriptionElement, config.prompt_html || config.prompt)
        }

        // 更新预定义选项
        const optionsContainer = document.getElementById('options-container')
        if (optionsContainer) {
          optionsContainer.innerHTML = ''

          if (config.predefined_options && config.predefined_options.length > 0) {
            config.predefined_options.forEach((option, index) => {
              const optionDiv = document.createElement('div')
              optionDiv.className = 'option-item'
              optionDiv.innerHTML = `
                            <input type="checkbox" id="option-${index}" value="${option}">
                            <label for="option-${index}">${option}</label>
                        `
              optionsContainer.appendChild(optionDiv)
            })
            optionsContainer.style.display = 'block'
            document.getElementById('separator').style.display = 'block'
          } else {
            optionsContainer.style.display = 'none'
            document.getElementById('separator').style.display = 'none'
          }
        }
      }

      // 事件监听器
      document.addEventListener('DOMContentLoaded', () => {
        loadConfig()
          .then(() => {
            // 在配置加载完成后启动轮询
            console.log('✅ 配置加载完成，启动内容轮询检查...')
            console.log('当前配置:', {
              has_content: config.has_content,
              persistent: config.persistent,
              prompt_length: config.prompt ? config.prompt.length : 0
            })
            startContentPolling()
          })
          .catch(error => {
            console.error('❌ 配置加载失败:', error)
            // 即使配置加载失败，也尝试启动轮询（可能是网络问题）
            setTimeout(() => {
              console.log('🔄 配置加载失败，延迟启动轮询...')
              startContentPolling()
            }, 3000)
          })

        // 按钮事件
        document
          .getElementById('insert-code-btn')
          .addEventListener('click', insertCodeFromClipboard)
        document.getElementById('submit-btn').addEventListener('click', submitFeedback)
        document.getElementById('close-btn').addEventListener('click', closeInterface)

        // 键盘快捷键
        document.addEventListener('keydown', event => {
          if (event.ctrlKey && event.key === 'Enter') {
            event.preventDefault()
            submitFeedback()
          } else if (event.altKey && event.key === 'c') {
            event.preventDefault()
            insertCodeFromClipboard()
          } else if (event.altKey && event.key === 's') {
            event.preventDefault()
            submitFeedback()
          }
        })
      })
    </script>
  </body>
</html>
