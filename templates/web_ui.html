<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>AI Intervention Agent</title>
    <link rel="icon" type="image/svg+xml" href="/icons/icon.svg" sizes="any" />
    <link rel="mask-icon" href="/icons/icon.svg" color="#8B5CF6" />
    <link rel="apple-touch-icon" href="/icons/icon.svg" />

    <!-- èµ„æºé¢„åŠ è½½ä¼˜åŒ–ï¼šå‡å°‘é¦–å±æ¸²æŸ“é˜»å¡ -->
    <link rel="preload" href="/fonts/SFProText-Regular.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/MonoLisaNerdFont-Regular.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/static/css/prism.css" as="style" />

    <!-- MathJax æ•°å­¦å…¬å¼æ”¯æŒ - æŒ‰éœ€åŠ è½½ä¼˜åŒ–ï¼ˆ1.17MB â†’ éœ€è¦æ—¶æ‰åŠ è½½ï¼‰ -->
    <script nonce="{{ csp_nonce }}">
      // MathJax é…ç½®ï¼ˆé¢„è®¾ï¼Œå®é™…è„šæœ¬æŒ‰éœ€åŠ è½½ï¼‰
      window.MathJax = {
        tex: {
          inlineMath: [
            ['$', '$'],
            ['\\(', '\\)']
          ],
          displayMath: [
            ['$$', '$$'],
            ['\\[', '\\]']
          ],
          processEscapes: true,
          processEnvironments: true,
          packages: { '[+]': ['ams', 'newcommand', 'configmacros'] },
          tags: 'ams'
        },
        options: {
          skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
          ignoreHtmlClass: 'tex2jax_ignore',
          processHtmlClass: 'tex2jax_process'
        },
        startup: {
          ready: () => {
            console.log('MathJax å·²åŠ è½½å®Œæˆ')
            MathJax.startup.defaultReady()
            // åŠ è½½å®Œæˆåæ¸²æŸ“æ‰€æœ‰å…¬å¼
            if (window._mathJaxPendingElements) {
              window._mathJaxPendingElements.forEach(el => {
                MathJax.typesetPromise([el]).catch(err => console.warn('MathJax æ¸²æŸ“å¤±è´¥:', err))
              })
              window._mathJaxPendingElements = []
            }
          }
        }
      }

      // MathJax æ‡’åŠ è½½çŠ¶æ€
      window._mathJaxLoading = false
      window._mathJaxLoaded = false
      window._mathJaxPendingElements = []

      // æ£€æµ‹å†…å®¹æ˜¯å¦åŒ…å«æ•°å­¦å…¬å¼
      window.hasMathContent = function(text) {
        if (!text) return false
        // æ£€æµ‹ LaTeX æ•°å­¦å…¬å¼è¯­æ³•
        const mathPatterns = [
          /\$[^$]+\$/,           // $...$
          /\$\$[^$]+\$\$/,       // $$...$$
          /\\\([^)]+\\\)/,       // \(...\)
          /\\\[[^\]]+\\\]/       // \[...\]
        ]
        return mathPatterns.some(pattern => pattern.test(text))
      }

      // æŒ‰éœ€åŠ è½½ MathJax
      window.loadMathJaxIfNeeded = function(element, text) {
        // æ£€æµ‹æ˜¯å¦æœ‰æ•°å­¦å†…å®¹
        if (!window.hasMathContent(text)) {
          return // æ— æ•°å­¦å…¬å¼ï¼Œä¸åŠ è½½
        }

        // å·²åŠ è½½å®Œæˆï¼Œç›´æ¥æ¸²æŸ“
        if (window._mathJaxLoaded && window.MathJax && window.MathJax.typesetPromise) {
          MathJax.typesetPromise([element]).catch(err => console.warn('MathJax æ¸²æŸ“å¤±è´¥:', err))
          return
        }

        // è®°å½•å¾…æ¸²æŸ“å…ƒç´ 
        window._mathJaxPendingElements.push(element)

        // æ­£åœ¨åŠ è½½ä¸­ï¼Œç­‰å¾…å®Œæˆ
        if (window._mathJaxLoading) {
          return
        }

        // å¼€å§‹åŠ è½½
        window._mathJaxLoading = true
        console.log('ğŸ“ æ£€æµ‹åˆ°æ•°å­¦å…¬å¼ï¼Œå¼€å§‹åŠ è½½ MathJax (1.17MB)...')

        const script = document.createElement('script')
        script.id = 'MathJax-script'
        script.async = true
        script.src = '/static/js/tex-mml-chtml.js'
        script.onload = function() {
          window._mathJaxLoaded = true
          console.log('âœ… MathJax åŠ è½½å®Œæˆ')
        }
        script.onerror = function() {
          console.error('âŒ MathJax åŠ è½½å¤±è´¥')
          window._mathJaxLoading = false
        }
        document.head.appendChild(script)
      }
    </script>

    <!-- Prism.js ä»£ç é«˜äº® CSS -->
    <link rel="stylesheet" href="/static/css/prism.css" />

    <!-- marked.js Markdown æ¸²æŸ“ (defer: æŒ‰é¡ºåºå¼‚æ­¥åŠ è½½) -->
    <script defer src="/static/js/marked.js" nonce="{{ csp_nonce }}"></script>

    <!-- Prism.js ä»£ç é«˜äº® JS (defer: æŒ‰é¡ºåºå¼‚æ­¥åŠ è½½) -->
    <script defer src="/static/js/prism.js" nonce="{{ csp_nonce }}"></script>

    <style>
      /* è‡ªå®šä¹‰å­—ä½“å£°æ˜ */
      @font-face {
        font-family: 'SFProText';
        src: url('/fonts/SFProText-Regular.woff2') format('woff2');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      @font-face {
        font-family: 'MonoLisaNerdFont';
        src: url('/fonts/MonoLisaNerdFont-Regular.woff2') format('woff2');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'SFProText', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text',
          'Helvetica Neue', 'Microsoft YaHei', 'PingFang SC', Arial, sans-serif;
        background: #1a1a1f;
        /* ç§»é™¤å¤æ‚èƒŒæ™¯æ¸å˜ä»¥æå‡æ€§èƒ½ */
        color: #f5f5f7;
        min-height: 100vh;
        padding: 1rem 0;
        line-height: 1.47059;
        font-weight: 400;
        letter-spacing: -0.022em;
        overflow-x: hidden;
        box-sizing: border-box;
        /* ç§»é™¤èƒŒæ™¯åŠ¨ç”»ä»¥æå‡æ€§èƒ½ */
      }

      /* æ— å†…å®¹çŠ¶æ€ä¸‹çš„ç‰¹æ®Šæ ·å¼ */
      body.no-content-mode {
        height: 100vh;
        overflow: hidden;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding: 3rem 0;
        box-sizing: border-box;
      }

      /* ç§»é™¤èƒŒæ™¯åŠ¨ç”»å®šä¹‰ä»¥æå‡æ€§èƒ½ */

      .container {
        max-width: 720px;
        margin: 0 auto;
        background: rgba(45, 45, 60, 0.9);
        /* ç§»é™¤æ¯›ç»ç’ƒæ•ˆæœä»¥æå‡æ€§èƒ½ */
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 32px;
        padding: 0;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        position: relative;
        /* ç§»é™¤è¿‡æ¸¡åŠ¨ç”»ä»¥æå‡æ€§èƒ½ */
      }

      /* æ— å†…å®¹æ¨¡å¼ä¸‹çš„å®¹å™¨æ ·å¼ */
      body.no-content-mode .container {
        margin: 0;
        width: 100%;
        max-width: 720px;
        max-height: calc(100vh - 6rem);
        overflow: hidden;
        flex-shrink: 0;
      }

      /* ç§»é™¤å®¹å™¨æ‚¬åœæ•ˆæœä»¥æå‡æ€§èƒ½ */

      .container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      }

      .header {
        background: rgba(30, 30, 40, 0.8);
        /* ç§»é™¤æ¯›ç»ç’ƒæ•ˆæœ */
        padding: 1rem 1.75rem;
        border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 1.75rem;
        right: 1.75rem;
        height: 0.5px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      }

      h1 {
        color: #f5f5f7;
        margin: 0;
        font-size: 1.375rem;
        font-weight: 600;
        letter-spacing: -0.01em;
        display: flex;
        align-items: center;
        gap: 0.625rem;
      }

      .header-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* è®¾ç½®æŒ‰é’®æ ·å¼ - ç®€åŒ–ç‰ˆ */
      .settings-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        color: #f5f5f7;
        padding: 0.5rem;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        backdrop-filter: blur(8px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .settings-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .settings-btn:active {
        transform: translateY(0);
        background: rgba(255, 255, 255, 0.08);
      }

      .settings-btn:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.3);
      }

      /* è®¾ç½®é¢æ¿æ ·å¼ - ç®€åŒ–ç‰ˆ */
      .settings-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        backdrop-filter: blur(8px);
        animation: fadeIn 0.2s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .settings-content {
        background: linear-gradient(145deg, rgba(30, 30, 40, 0.98), rgba(25, 25, 35, 0.95));
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 20px;
        max-width: 800px;
        width: 100%;
        max-height: 85vh;
        overflow: hidden;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        backdrop-filter: blur(20px);
        position: relative;
      }

      .settings-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      }

      .settings-content::-webkit-scrollbar {
        width: 6px;
      }

      .settings-content::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
      }

      .settings-content::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
        border-radius: 3px;
      }

      .settings-content::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
      }

      .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 2.5rem 2.5rem 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
        position: relative;
      }

      .settings-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
      }

      .settings-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 2.5rem;
        right: 2.5rem;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(0, 122, 255, 0.3), transparent);
      }

      .settings-header h3 {
        margin: 0;
        color: #ffffff;
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: -0.02em;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .settings-close-btn {
        background: linear-gradient(135deg, rgba(255, 69, 58, 0.12), rgba(255, 69, 58, 0.08));
        border: 1.5px solid rgba(255, 69, 58, 0.25);
        border-radius: 50%;
        color: #ff453a;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: 0 2px 12px rgba(255, 69, 58, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      .settings-close-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 14px;
        height: 2px;
        background: currentColor;
        transform: translate(-50%, -50%) rotate(45deg);
        border-radius: 1px;
        transition: all 0.2s ease;
      }

      .settings-close-btn::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 14px;
        height: 2px;
        background: currentColor;
        transform: translate(-50%, -50%) rotate(-45deg);
        border-radius: 1px;
        transition: all 0.2s ease;
      }

      .settings-close-btn:hover {
        background: linear-gradient(135deg, rgba(255, 69, 58, 0.2), rgba(255, 69, 58, 0.15));
        border-color: rgba(255, 69, 58, 0.4);
        transform: scale(1.08);
        box-shadow: 0 4px 20px rgba(255, 69, 58, 0.25), 0 2px 8px rgba(0, 0, 0, 0.15);
        color: #ff2d20;
      }

      .settings-close-btn:hover::before,
      .settings-close-btn:hover::after {
        width: 16px;
        height: 2.5px;
      }

      .settings-close-btn:active {
        transform: scale(0.92);
        box-shadow: 0 1px 6px rgba(255, 69, 58, 0.3), inset 0 1px 2px rgba(0, 0, 0, 0.1);
        background: linear-gradient(135deg, rgba(255, 69, 58, 0.25), rgba(255, 69, 58, 0.2));
      }

      .settings-body {
        padding: 2rem;
        max-height: calc(85vh - 140px);
        overflow-y: auto;
        background: linear-gradient(180deg, transparent, rgba(255, 255, 255, 0.005));
      }

      .settings-main-title {
        color: #ffffff;
        font-size: 1.3rem;
        font-weight: 700;
        margin: 0 0 1.5rem 0;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        letter-spacing: -0.01em;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .setting-group {
        margin-bottom: 2rem;
        background: rgba(45, 45, 60, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 24px;
        padding: 1.5rem;
        position: relative;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .setting-group::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      }

      .setting-group:last-child {
        margin-bottom: 0;
      }

      .setting-group::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
        border-radius: 16px 16px 0 0;
      }

      .setting-group-title {
        color: #f5f5f7;
        font-size: 1.2rem;
        font-weight: 700;
        margin: 0 0 1.5rem 0;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        background: linear-gradient(135deg, #f5f5f7, rgba(0, 122, 255, 0.8));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        position: relative;
        letter-spacing: -0.01em;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .setting-group-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 40%;
        height: 2px;
        background: linear-gradient(90deg, #007aff, rgba(0, 122, 255, 0.4), transparent);
        border-radius: 1px;
      }

      .setting-subgroup {
        margin: 1.5rem 0;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 12px;
        position: relative;
      }

      .setting-subgroup-title {
        color: rgba(245, 245, 247, 0.95);
        font-size: 1rem;
        font-weight: 600;
        margin: 0 0 1rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        letter-spacing: -0.01em;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .setting-item {
        margin-bottom: 1rem;
        padding: 0.5rem 0;
        background: transparent;
        border: none;
        border-radius: 0;
        transition: none;
        position: relative;
      }

      .setting-item:last-child {
        margin-bottom: 0;
      }

      .setting-label {
        display: flex;
        align-items: center;
        gap: 1rem;
        cursor: pointer;
        margin-bottom: 0;
        padding: 0.25rem;
        border-radius: 8px;
        transition: all 0.2s ease;
      }

      .setting-label input[type='checkbox'] {
        width: 20px;
        height: 20px;
        accent-color: #007aff;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s ease;
        position: relative;
      }

      .setting-label input[type='checkbox']:checked {
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(0, 122, 255, 0.3);
      }

      .setting-title {
        color: #f5f5f7;
        font-size: 1rem;
        font-weight: 600;
        flex: 1;
        transition: color 0.2s ease;
        letter-spacing: -0.01em;
      }

      .setting-label:hover .setting-title {
        color: rgba(245, 245, 247, 0.9);
      }

      .setting-description {
        color: rgba(245, 245, 247, 0.65);
        font-size: 0.9rem;
        line-height: 1.5;
        margin-left: 3rem;
        font-style: italic;
        transition: color 0.2s ease;
      }

      .setting-item:hover .setting-description {
        color: rgba(245, 245, 247, 0.75);
      }

      /* éŸ³é‡æ»‘å—æ ·å¼ - ç¾åŒ–ç‰ˆ */
      .volume-slider {
        flex: 1;
        margin: 0 1rem;
        height: 6px;
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        border-radius: 3px;
        outline: none;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      .volume-slider::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        background: linear-gradient(135deg, #007aff, #0056cc);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3), 0 0 0 2px rgba(255, 255, 255, 0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .volume-slider::-webkit-slider-thumb:hover {
        transform: scale(1.2);
        box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4), 0 0 0 3px rgba(255, 255, 255, 0.2),
          0 0 20px rgba(0, 122, 255, 0.2);
      }

      .volume-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: linear-gradient(135deg, #007aff, #0056cc);
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .volume-value {
        color: #007aff;
        font-size: 1rem;
        font-weight: 700;
        min-width: 50px;
        text-align: right;
        background: linear-gradient(135deg, #007aff, rgba(0, 122, 255, 0.8));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 0 10px rgba(0, 122, 255, 0.3);
      }

      /* è®¾ç½®è¾“å…¥æ¡†æ ·å¼ */
      .setting-input {
        width: 100%;
        padding: 0.75rem 1rem;
        margin-top: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: #f5f5f7;
        font-size: 0.95rem;
        font-family: inherit;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .setting-input:focus {
        outline: none;
        border-color: #007aff;
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
      }

      .setting-input::placeholder {
        color: rgba(245, 245, 247, 0.5);
      }

      /* è®¾ç½®é€‰æ‹©æ¡†æ ·å¼ */
      .setting-select {
        width: 100%;
        padding: 0.75rem 1rem;
        margin-top: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: #f5f5f7;
        font-size: 0.95rem;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f7' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 16px;
        padding-right: 3rem;
      }

      .setting-select:focus {
        outline: none;
        border-color: #007aff;
        background-color: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
      }

      .setting-select option {
        background: #1a1a1f;
        color: #f5f5f7;
        padding: 0.5rem;
      }

      /* è®¾ç½®æ ‡ç­¾å¸ƒå±€è°ƒæ•´ */
      .setting-label.has-input {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .setting-label.has-input .setting-title {
        margin-bottom: 0.25rem;
      }

      /* æŒ‰é’®æ ·å¼ - ç®€åŒ–ç‰ˆ */
      .btn {
        background: rgba(0, 122, 255, 0.8);
        border: 1px solid rgba(0, 122, 255, 0.3);
        border-radius: 10px;
        color: #ffffff;
        padding: 0.75rem 1.5rem;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
      }

      .btn:hover {
        background: rgba(0, 122, 255, 0.9);
        border-color: rgba(0, 122, 255, 0.5);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
      }

      .btn:active {
        transform: translateY(0);
        background: rgba(0, 122, 255, 0.7);
      }

      .btn-secondary {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.08));
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #f5f5f7;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
      }

      .btn-secondary:hover {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.1));
        border-color: rgba(255, 255, 255, 0.25);
        color: #ffffff;
      }

      /* çŠ¶æ€ä¿¡æ¯æ ·å¼ - ç¾åŒ–ç‰ˆ */
      .status-info {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 16px;
        padding: 1.75rem;
        position: relative;
        backdrop-filter: blur(15px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.08);
      }

      .status-info::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        border-radius: 16px 16px 0 0;
      }

      .status-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        transition: all 0.2s ease;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.005));
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .status-row:last-child {
        margin-bottom: 0;
      }

      .status-row span:first-child {
        color: rgba(245, 245, 247, 0.85);
        font-size: 0.95rem;
        font-weight: 600;
        letter-spacing: -0.01em;
      }

      .status-row span:last-child {
        color: #f5f5f7;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 0.4rem 0.75rem;
        border-radius: 8px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
      }

      .content {
        padding: 1.75rem;
      }

      .feedback-group {
        background: transparent;
        border: none;
        padding: 0;
        margin: 0;
      }

      .description {
        font-size: 1rem;
        margin-bottom: 1.5rem;
        padding: 1.5rem 1.75rem;
        background: linear-gradient(
          135deg,
          rgba(0, 122, 255, 0.08) 0%,
          rgba(88, 86, 214, 0.06) 50%,
          rgba(175, 82, 222, 0.05) 100%
        );
        border: 1px solid rgba(0, 122, 255, 0.25);
        border-radius: 24px;
        color: #f5f5f7;
        line-height: 1.6;
        letter-spacing: -0.022em;
        position: relative;
        /* ç§»é™¤æ¯›ç»ç’ƒæ•ˆæœ */
        box-shadow: 0 4px 8px rgba(0, 122, 255, 0.1);
      }

      .description::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        border-radius: 24px 24px 0 0;
      }

      .options-container {
        margin-bottom: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1rem; /* å¢åŠ é€‰é¡¹é—´è· */
      }

      .option-item {
        display: flex;
        align-items: center;
        padding: 1.25rem 1.5rem;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.06) 0%,
          rgba(255, 255, 255, 0.03) 50%,
          rgba(255, 255, 255, 0.05) 100%
        );
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 20px;
        transition: all 0.15s ease;
        cursor: pointer;
        position: relative;
        margin-bottom: 0.75rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        user-select: none;
      }

      .option-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
        border-radius: 20px 20px 0 0;
      }

      .option-item:hover {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0.06) 50%,
          rgba(255, 255, 255, 0.08) 100%
        );
        border-color: rgba(0, 122, 255, 0.4);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
      }

      .option-item:active {
        transform: translateY(0);
        transition: all 0.05s ease;
      }

      .option-item input[type='checkbox'] {
        margin-right: 1rem;
        width: 20px;
        height: 20px;
        accent-color: #007aff;
        cursor: pointer;
        flex-shrink: 0;
        position: relative;
      }

      .option-item input[type='checkbox']::before {
        content: '';
        position: absolute;
        top: -10px;
        left: -10px;
        right: -10px;
        bottom: -10px;
        cursor: pointer;
      }

      .option-item label {
        font-size: 1rem;
        cursor: pointer;
        color: #f5f5f7;
        flex: 1;
        font-weight: 400;
        letter-spacing: -0.022em;
        line-height: 1.5;
        padding: 0.5rem 0;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      .separator {
        height: 0.5px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        margin: 1.25rem 0;
      }

      .textarea-container {
        position: relative;
        margin-bottom: 1rem;
      }

      .feedback-textarea {
        width: 100%;
        min-height: 180px;
        padding: 1.5rem 1.75rem;
        font-size: 1rem;
        font-family: 'MonoLisaNerdFont', 'SF Mono', ui-monospace, SFMono-Regular, Monaco, Consolas,
          'Liberation Mono', 'Courier New', monospace;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.06) 0%,
          rgba(255, 255, 255, 0.03) 50%,
          rgba(255, 255, 255, 0.05) 100%
        );
        color: #f5f5f7;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 24px;
        resize: vertical;
        margin-bottom: 1rem;
        /* ç§»é™¤è¿‡æ¸¡åŠ¨ç”» */
        line-height: 1.6;
        letter-spacing: -0.022em;
        /* ç§»é™¤æ¯›ç»ç’ƒæ•ˆæœ */
        position: relative;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .feedback-textarea:focus {
        outline: none;
        border-color: rgba(0, 122, 255, 0.5);
        box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.3);
        background: rgba(255, 255, 255, 0.08);
        /* ç§»é™¤transformæ•ˆæœ */
      }

      .feedback-textarea::placeholder {
        color: rgba(245, 245, 247, 0.6);
        font-weight: 400;
      }

      .button-container {
        display: flex;
        gap: 0.625rem;
        justify-content: flex-end;
        margin-top: 1.25rem;
      }

      .btn {
        padding: 1rem 1.75rem;
        font-size: 0.9375rem;
        font-weight: 600;
        font-family: inherit;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        /* ç§»é™¤è¿‡æ¸¡åŠ¨ç”» */
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 130px;
        justify-content: center;
        letter-spacing: -0.022em;
        position: relative;
        /* ç§»é™¤æ¯›ç»ç’ƒæ•ˆæœ */
        overflow: hidden;
      }

      .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        border-radius: 20px 20px 0 0;
      }

      .btn::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
        border-radius: 20px;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .btn:hover::after {
        opacity: 1;
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: #f5f5f7;
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.25);
        /* ç§»é™¤transformæ•ˆæœ */
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .btn-primary {
        background: #007aff;
        color: white;
        border: 1px solid rgba(0, 122, 255, 0.3);
        box-shadow: 0 4px 8px rgba(0, 122, 255, 0.2);
      }

      .btn-primary:hover {
        background: #0056cc;
        /* ç§»é™¤transformæ•ˆæœ */
        box-shadow: 0 6px 12px rgba(0, 122, 255, 0.3);
      }

      .btn:disabled {
        background: rgba(255, 255, 255, 0.03);
        color: rgba(245, 245, 247, 0.3);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        border-color: rgba(255, 255, 255, 0.05);
      }

      .status-message {
        margin-top: 1rem;
        padding: 0.875rem 1.125rem;
        border-radius: 12px;
        text-align: center;
        display: none;
        font-size: 0.9375rem;
        font-weight: 500;
        letter-spacing: -0.022em;
        /* ç§»é™¤æ¯›ç»ç’ƒæ•ˆæœ */
        position: relative;
      }

      .status-message::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 0.5px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        border-radius: 12px 12px 0 0;
      }

      .status-success {
        background: rgba(52, 199, 89, 0.08);
        color: #34c759;
        border: 0.5px solid rgba(52, 199, 89, 0.2);
      }

      .status-error {
        background: rgba(255, 69, 58, 0.08);
        color: #ff453a;
        border: 0.5px solid rgba(255, 69, 58, 0.2);
      }

      .shortcut-hint {
        position: relative;
        bottom: auto;
        left: auto;
        display: flex; /* é»˜è®¤æ˜¾ç¤º */
        align-items: center;
        gap: 0.25rem;
        font-size: 0.625rem;
        color: rgba(245, 245, 247, 0.7);
        font-weight: 400;
        letter-spacing: -0.022em;
        cursor: help;
        padding: 0.3rem 0.5rem;
        border-radius: 6px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        user-select: none;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 10;
        opacity: 0.8;
        width: fit-content;
      }

      .shortcut-hint:hover {
        color: rgba(245, 245, 247, 1);
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
        opacity: 1;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        transform: translateY(-1px);
      }

      .shortcut-hint .keyboard-icon {
        font-size: 0.75rem;
        opacity: 0.6;
      }

      .shortcut-tooltip {
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 8px;
        background: linear-gradient(
          135deg,
          rgba(30, 41, 59, 0.95) 0%,
          rgba(15, 23, 42, 0.98) 50%,
          rgba(8, 15, 35, 0.96) 100%
        );
        color: rgba(248, 250, 252, 0.95);
        padding: 12px 16px;
        border-radius: 10px;
        font-size: 11px;
        line-height: 1.4;
        white-space: pre;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none;
        z-index: 1000;
        width: fit-content;
        text-align: left;
        border: 1px solid rgba(148, 163, 184, 0.3);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 4px 15px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        font-weight: 500;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New',
          monospace;
        backdrop-filter: blur(16px) saturate(1.2);
        -webkit-backdrop-filter: blur(16px) saturate(1.2);
      }

      .shortcut-hint:hover .shortcut-tooltip {
        opacity: 1;
        visibility: visible;
      }

      .shortcut-hint::before {
        content: '';
        position: absolute;
        top: 100%;
        left: 16px;
        margin-top: 2px;
        border: 6px solid transparent;
        border-bottom-color: rgb(17, 24, 39);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none;
        z-index: 1001;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
      }

      .shortcut-hint:hover::before {
        opacity: 1;
        visibility: visible;
      }

      /* å›¾ç‰‡é¢„è§ˆåŒºåŸŸæ ·å¼ */
      .image-preview-container {
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.06) 0%,
          rgba(255, 255, 255, 0.03) 50%,
          rgba(255, 255, 255, 0.05) 100%
        );
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 20px;
        position: relative;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .image-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .image-count-text {
        font-size: 0.875rem;
        color: rgba(245, 245, 247, 0.8);
        font-weight: 500;
      }

      .clear-all-images-btn {
        background: rgba(255, 69, 58, 0.1);
        color: #ff453a;
        border: 1px solid rgba(255, 69, 58, 0.2);
        border-radius: 12px;
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .clear-all-images-btn:hover {
        background: rgba(255, 69, 58, 0.15);
        border-color: rgba(255, 69, 58, 0.3);
      }

      .image-previews {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 1rem;
        max-height: 300px;
        overflow-y: auto;
      }

      .image-preview-item {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        /* ç§»é™¤cursor: pointerå’ŒhoveråŠ¨æ•ˆ */
      }

      .image-preview-thumbnail {
        width: 100%;
        height: 80px;
        object-fit: cover;
        display: block;
        /* ä¿ç•™cursor: pointerç”¨äºç‚¹å‡»æ”¾å¤§åŠŸèƒ½ */
        cursor: pointer;
      }

      .image-preview-info {
        padding: 0.5rem;
        background: rgba(0, 0, 0, 0.3);
        color: #f5f5f7;
        font-size: 0.75rem;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .image-preview-remove {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(255, 69, 58, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        font-size: 12px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.8;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        transform: scale(1);
      }

      .image-preview-remove:hover {
        opacity: 1;
        background: rgba(255, 69, 58, 1);
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(255, 69, 58, 0.4);
      }

      /* ç§»é™¤å›¾ç‰‡ç¼©ç•¥å›¾çš„hoveråŠ¨æ•ˆ */

      /* å›¾ç‰‡æ”¾å¤§é¢„è§ˆæ¨¡æ€æ¡† */
      .image-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(5px);
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .image-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
      }

      .image-modal-content {
        position: relative;
        max-width: 90%;
        max-height: 90%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .image-modal img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      }

      .image-modal-close {
        position: absolute;
        top: -40px;
        right: -40px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 24px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .image-modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .image-modal-info {
        position: absolute;
        bottom: -50px;
        left: 0;
        right: 0;
        text-align: center;
        color: white;
        background: rgba(0, 0, 0, 0.5);
        padding: 8px;
        border-radius: 4px;
        font-size: 14px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* ç§»åŠ¨è®¾å¤‡ä¼˜åŒ– */
      @media (max-width: 768px) {
        .image-preview-container {
          margin: 1rem 0;
        }

        .image-previews {
          gap: 0.75rem;
          grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        }

        .image-preview-item {
          min-height: 80px;
        }

        .image-preview-thumbnail {
          max-height: 60px;
        }

        .image-preview-remove {
          width: 22px;
          height: 22px;
          font-size: 12px;
          top: 2px;
          right: 2px;
        }

        .image-modal-close {
          top: 10px;
          right: 10px;
          width: 40px;
          height: 40px;
          font-size: 20px;
        }

        .image-modal-info {
          bottom: 10px;
          left: 10px;
          right: 10px;
          font-size: 12px;
        }

        /* è§¦æ‘¸å‹å¥½çš„æŒ‰é’®å¤§å° */
        .btn {
          min-height: 44px;
          padding: 0.75rem 1rem;
        }

        /* æ‹–æ‹½æç¤ºä¼˜åŒ– */
        .drag-overlay-content {
          padding: 1.5rem;
          max-width: 300px;
        }

        .drag-icon {
          font-size: 3rem;
        }

        .drag-text {
          font-size: 1.25rem;
        }
      }

      /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– - å·²ç§»é™¤æ‰€æœ‰hoveråŠ¨æ•ˆï¼Œæ— éœ€ç‰¹æ®Šå¤„ç† */

      /* æ‹–æ‹½è¦†ç›–å±‚æ ·å¼ */
      .drag-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
      }

      .drag-overlay-content {
        text-align: center;
        color: #f5f5f7;
        padding: 2rem;
        border: 2px dashed rgba(0, 122, 255, 0.5);
        border-radius: 20px;
        background: rgba(0, 122, 255, 0.1);
        max-width: 400px;
      }

      .drag-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.8;
      }

      .drag-text {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .drag-subtext {
        font-size: 1rem;
        opacity: 0.7;
      }

      /* æ‹–æ‹½åŒºåŸŸé«˜äº®æ•ˆæœ */
      .textarea-drag-over {
        border-color: rgba(0, 122, 255, 0.6) !important;
        background: rgba(0, 122, 255, 0.05) !important;
        box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.3) !important;
      }

      /* åŠ è½½çŠ¶æ€æ ·å¼ */
      .image-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 80px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        color: rgba(245, 245, 247, 0.6);
        font-size: 0.875rem;
      }

      .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid #007aff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* é”™è¯¯çŠ¶æ€æ ·å¼ */
      .image-error {
        background: rgba(255, 69, 58, 0.1);
        border-color: rgba(255, 69, 58, 0.3);
        color: #ff453a;
      }

      .error-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }

      /* é«˜æ€§èƒ½Markdownæ¸²æŸ“æ ·å¼ */
      .markdown-content {
        line-height: 1.5;
        color: #f5f5f7;
        /* ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½ */
        contain: layout style;
        will-change: auto;
        transform: translateZ(0); /* å¯ç”¨ç¡¬ä»¶åŠ é€Ÿ */
      }

      .markdown-content h1,
      .markdown-content h2,
      .markdown-content h3,
      .markdown-content h4,
      .markdown-content h5,
      .markdown-content h6 {
        color: #f5f5f7;
        font-weight: 600;
        margin: 1rem 0 0.5rem 0;
      }

      .markdown-content h1 {
        font-size: 1.5rem;
      }
      .markdown-content h2 {
        font-size: 1.25rem;
      }
      .markdown-content h3 {
        font-size: 1.125rem;
      }
      .markdown-content h4 {
        font-size: 1rem;
      }

      .markdown-content p {
        margin: 0.75rem 0;
        color: #f5f5f7;
      }

      /* ç®€æ´ç¨³å¥çš„åˆ—è¡¨æ ·å¼ - ä½¿ç”¨æ ‡å‡†CSS */
      .markdown-content ul,
      .markdown-content ol {
        margin: 0.75rem 0;
        padding-left: 1.5rem;
        color: #f5f5f7;
        line-height: 1.6;
      }

      .markdown-content ul {
        list-style-type: disc;
        list-style-position: outside;
      }

      .markdown-content ol {
        list-style-type: decimal;
        list-style-position: outside;
      }

      .markdown-content li {
        margin: 0.375rem 0;
        color: #f5f5f7;
        line-height: 1.6;
      }

      /* è‡ªå®šä¹‰åˆ—è¡¨æ ‡è®°é¢œè‰² */
      .markdown-content ul li::marker {
        color: #f5f5f7;
        font-size: 1.1em;
      }

      .markdown-content ol li::marker {
        color: #f5f5f7;
        font-weight: 600;
      }

      /* åµŒå¥—åˆ—è¡¨æ ·å¼ */
      .markdown-content ul ul {
        list-style-type: circle;
        margin: 0.25rem 0;
        padding-left: 1.25rem;
      }

      .markdown-content ul ul ul {
        list-style-type: square;
      }

      .markdown-content ol ol {
        list-style-type: lower-alpha;
        margin: 0.25rem 0;
        padding-left: 1.25rem;
      }

      .markdown-content ol ol ol {
        list-style-type: lower-roman;
      }

      /* åˆ—è¡¨é¡¹å†…å®¹æ ·å¼ */
      .markdown-content li p {
        margin: 0.25rem 0;
      }

      .markdown-content li > *:first-child {
        margin-top: 0;
      }

      .markdown-content li > *:last-child {
        margin-bottom: 0;
      }

      .markdown-content blockquote {
        margin: 1rem 0;
        padding: 0.75rem 1rem;
        background: rgba(0, 122, 255, 0.08);
        border-left: 3px solid #007aff;
        color: #f5f5f7;
      }

      /* å†…è”ä»£ç æ ·å¼ */
      .markdown-content code {
        background: rgba(255, 255, 255, 0.12);
        color: #ff453a;
        padding: 0.125rem 0.375rem;
        font-family: 'MonoLisaNerdFont', monospace;
        font-size: 0.875rem;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      /* ä»£ç å—å®¹å™¨æ ·å¼ - ç°ä»£åŒ–è®¾è®¡ */
      .code-block-container {
        position: relative;
        margin: 1.5rem 0;
        border-radius: 20px;
        background: linear-gradient(
          135deg,
          rgba(15, 15, 25, 0.95) 0%,
          rgba(25, 25, 40, 0.9) 50%,
          rgba(20, 20, 35, 0.95) 100%
        );
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4), 0 4px 8px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        overflow: hidden;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }

      .code-block-container:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.5), 0 6px 12px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.15);
        border-color: rgba(0, 122, 255, 0.3);
      }

      /* ç§»é™¤ä»£ç å—è£…é¥°çº¿ä»¥ç®€åŒ–æ ·å¼ */

      /* ä»£ç å—æ ·å¼ - ä¼˜åŒ–ç‰ˆ */
      .markdown-content pre {
        background: transparent;
        border: none;
        padding: 1.5rem 1.75rem;
        margin: 0;
        overflow-x: auto;
        border-radius: 20px;
        font-size: 0.9rem;
        line-height: 1.6;
        position: relative;
      }

      .markdown-content pre code {
        background: none;
        color: #f5f5f7;
        padding: 0;
        font-family: 'MonoLisaNerdFont', 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono',
          'Consolas', monospace;
        font-size: inherit;
        font-weight: 400;
        letter-spacing: 0.025em;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        text-decoration: none !important;
      }

      /* å¼ºåˆ¶è¦†ç›–ä»£ç é«˜äº®èƒŒæ™¯ */
      .markdown-content .highlight,
      .markdown-content div[style*='background'] {
        background: transparent !important;
      }

      /* ç§»é™¤ä»£ç å—å†…æ‰€æœ‰æ–‡æœ¬è£…é¥° */
      .markdown-content pre *,
      .markdown-content code *,
      .markdown-content pre,
      .markdown-content code {
        text-decoration: none !important;
        text-decoration-line: none !important;
        text-decoration-style: none !important;
        text-decoration-color: transparent !important;
        text-decoration-thickness: 0 !important;
        text-underline-offset: 0 !important;
        border-bottom: none !important;
        border-top: none !important;
        outline: none !important;
        box-shadow: none !important;
      }

      /* å¼ºåˆ¶ç§»é™¤æ‰€æœ‰ä»£ç ç›¸å…³å…ƒç´ çš„ä¸‹åˆ’çº¿ */
      .code-block-container *,
      .code-block-container,
      pre *,
      pre,
      code *,
      code,
      .highlight *,
      .highlight {
        text-decoration: none !important;
        text-decoration-line: none !important;
        text-decoration-style: none !important;
        text-decoration-color: transparent !important;
        text-decoration-thickness: 0 !important;
        text-underline-offset: 0 !important;
        border-bottom: none !important;
        border-top: none !important;
      }

      /* å®Œå…¨éšè—ä»£ç å—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
      .markdown-content pre::-webkit-scrollbar {
        display: none !important;
        width: 0 !important;
        height: 0 !important;
      }

      .code-block-container pre::-webkit-scrollbar {
        display: none !important;
        width: 0 !important;
        height: 0 !important;
      }

      /* å¯¹äºFirefoxæµè§ˆå™¨éšè—æ»šåŠ¨æ¡ */
      .markdown-content pre {
        scrollbar-width: none !important;
        -ms-overflow-style: none !important;
      }

      .code-block-container pre {
        scrollbar-width: none !important;
        -ms-overflow-style: none !important;
      }

      /* ä»£ç å·¥å…·æ æ ·å¼ - ç°ä»£åŒ–è®¾è®¡ */
      .code-toolbar {
        position: absolute;
        top: 16px;
        right: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 10;
        opacity: 0.8;
        transition: opacity 0.3s ease;
      }

      .code-block-container:hover .code-toolbar {
        opacity: 1;
      }

      /* è¯­è¨€æ ‡è¯†æ ·å¼ - ç²¾ç¾è®¾è®¡ */
      .language-label {
        background: linear-gradient(135deg, rgba(0, 122, 255, 0.25), rgba(88, 86, 214, 0.2));
        border: 1px solid rgba(0, 122, 255, 0.4);
        border-radius: 8px;
        padding: 5px 10px;
        font-size: 0.7rem;
        color: #4fc3f7;
        font-weight: 700;
        font-family: inherit;
        backdrop-filter: blur(15px);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
        transition: all 0.3s ease;
      }

      .language-label:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        border-color: rgba(0, 122, 255, 0.6);
      }

      /* å¤åˆ¶æŒ‰é’®æ ·å¼ - ç²¾ç¾è®¾è®¡ */
      .copy-button {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.08));
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 10px;
        padding: 7px 12px;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.9);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-family: inherit;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 5px;
        backdrop-filter: blur(15px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        position: relative;
        overflow: hidden;
      }

      .copy-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s ease;
      }

      .copy-button:hover::before {
        left: 100%;
      }

      .copy-button:hover {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.12));
        border-color: rgba(255, 255, 255, 0.4);
        color: #fff;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
      }

      .copy-button:active {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .copy-button.copied {
        background: linear-gradient(135deg, rgba(52, 199, 89, 0.25), rgba(52, 199, 89, 0.15));
        border-color: rgba(52, 199, 89, 0.5);
        color: #4caf50;
        box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
      }

      .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        background: rgba(255, 255, 255, 0.03);
      }

      .markdown-content th,
      .markdown-content td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: #f5f5f7;
      }

      .markdown-content th {
        background: rgba(0, 122, 255, 0.1);
        font-weight: 600;
      }

      .markdown-content a {
        color: #007aff;
        text-decoration: none;
      }

      .markdown-content a:hover {
        text-decoration: underline;
      }

      /* åˆ é™¤çº¿æ ·å¼ */
      .markdown-content del,
      .markdown-content s,
      .markdown-content .strikethrough {
        text-decoration: line-through;
        color: rgba(245, 245, 247, 0.6);
        text-decoration-color: rgba(245, 245, 247, 0.6);
        text-decoration-thickness: 2px;
      }

      .markdown-content hr {
        border: none;
        height: 1px;
        background: rgba(255, 255, 255, 0.2);
        margin: 1.5rem 0;
      }

      /* åŠ è½½åŠ¨ç”» */
      @keyframes loading {
        0% {
          transform: translateX(-100%);
        }
        50% {
          transform: translateX(0%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      /* ç§»é™¤æ‰€æœ‰åŠ¨ç”»å®šä¹‰ä»¥æå‡æ€§èƒ½ */

      /* ç§»é™¤æµ®åŠ¨åŠ¨ç”»ä»¥æå‡æ€§èƒ½ */

      /* ç§»åŠ¨ç«¯é€‚é… */
      @media (max-width: 768px) {
        /* ç§»åŠ¨ç«¯éšè—å¿«æ·é”®æç¤º */
        .shortcut-hint {
          display: none !important;
        }

        /* ç§»åŠ¨ç«¯éšè—å¿«æ·é”®éƒ¨åˆ† */
        .shortcuts-section {
          display: none !important;
        }

        body {
          padding: 0;
          font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
          min-height: 100vh;
          min-height: 100dvh; /* ä½¿ç”¨åŠ¨æ€è§†å£é«˜åº¦ */
          max-height: 100vh;
          max-height: 100dvh;
          overflow-y: auto;
        }

        body.no-content-mode {
          padding: 0;
          height: 100vh;
          height: 100dvh; /* ä½¿ç”¨åŠ¨æ€è§†å£é«˜åº¦ */
          overflow: hidden;
        }

        .container {
          max-width: 100%;
          margin: 0;
          border-radius: 0;
          box-shadow: none;
          border: none;
          background: transparent;
          min-height: 100vh;
          min-height: 100dvh;
          display: flex;
          flex-direction: column;
        }

        body.no-content-mode .container {
          margin: 0;
          height: 100vh;
          height: 100dvh;
          max-height: 100vh;
          max-height: 100dvh;
          background: transparent;
          overflow: hidden;
        }

        .header {
          padding: 0.75rem 1.25rem;
          /* æ·»åŠ iOSå®‰å…¨åŒºåŸŸæ”¯æŒï¼Œç¡®ä¿æ ‡é¢˜ä¸è¢«çŠ¶æ€æ é®æŒ¡ */
          padding-top: max(0.75rem, env(safe-area-inset-top));
          background: transparent;
          border-bottom: none;
          flex-shrink: 0;
        }

        h1 {
          font-size: 1.25rem;
        }

        .content {
          padding: 1rem 1.25rem;
          background: transparent;
          flex: 1;
          overflow-y: auto;
          display: flex;
          flex-direction: column;
        }

        .feedback-group {
          display: flex;
          flex-direction: column;
          height: 100%;
        }

        .description {
          padding: 1rem 1.25rem;
          border-radius: 20px;
          font-size: 0.95rem;
          margin-bottom: 1rem;
          flex-shrink: 0;
        }

        .option-item {
          padding: 1rem 1.25rem;
          border-radius: 16px;
          margin-bottom: 0.5rem;
        }

        .option-item input[type='checkbox'] {
          width: 20px;
          height: 20px;
          margin-right: 0.75rem;
        }

        .option-item label {
          font-size: 0.95rem;
          line-height: 1.4;
        }

        .feedback-textarea {
          min-height: 100px;
          max-height: 30vh;
          padding: 1rem 1.25rem;
          border-radius: 20px;
          font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
          line-height: 1.5;
          flex-shrink: 0;
        }

        .button-container {
          flex-direction: column;
          gap: 0.75rem;
          margin-top: 1rem;
          flex-shrink: 0;
        }

        .btn {
          padding: 0.875rem 1.5rem;
          font-size: 0.9rem;
          border-radius: 16px;
          min-width: auto;
          width: 100%;
        }

        .shortcut-hint:hover,
        .shortcut-hint:active {
          color: rgba(245, 245, 247, 1);
          background: rgba(255, 255, 255, 0.08);
          border-color: rgba(255, 255, 255, 0.15);
          opacity: 1;
          box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
          transform: translateY(-1px);
        }

        .shortcut-tooltip {
          top: 100%;
          left: 0;
          margin-top: 6px;
          width: fit-content;
          font-size: 0.6rem;
          padding: 6px 10px;
          border-radius: 5px;
          line-height: 1.3;
        }

        .keyboard-icon {
          font-size: 0.45rem;
          opacity: 0.3;
        }

        .status-message {
          margin-top: 0.75rem;
          padding: 0.75rem 1rem;
          border-radius: 10px;
          font-size: 0.9rem;
        }

        /* æ— æœ‰æ•ˆå†…å®¹é¡µé¢ç§»åŠ¨ç«¯é€‚é… */
        #no-content-container {
          padding: 2rem 1.25rem !important;
          min-height: 300px !important;
        }

        #no-content-container h2 {
          font-size: 1.5rem !important;
          margin-bottom: 0.75rem !important;
        }

        #no-content-container p {
          font-size: 0.95rem !important;
          margin-bottom: 1.5rem !important;
        }

        #no-content-container .button-container {
          margin-top: 1.5rem !important;
        }

        /* è¿›åº¦æ¡é€‚é… */
        #no-content-container > div:nth-child(4) {
          width: 200px !important;
        }

        /* Markdownå†…å®¹ç§»åŠ¨ç«¯é€‚é… */
        .markdown-content {
          font-size: 0.95rem;
        }

        .markdown-content h1 {
          font-size: 1.3rem;
        }

        .markdown-content h2 {
          font-size: 1.15rem;
        }

        .markdown-content h3 {
          font-size: 1.05rem;
        }

        .code-block-container {
          border-radius: 16px;
          margin: 1rem 0;
          transform: none !important; /* ç¦ç”¨ç§»åŠ¨ç«¯æ‚¬åœæ•ˆæœ */
        }

        .code-block-container:hover {
          transform: none !important;
        }

        .markdown-content pre {
          padding: 1rem 1.25rem;
          font-size: 0.85rem;
          overflow-x: auto;
          border-radius: 16px;
        }

        .markdown-content code {
          font-size: 0.8rem;
          padding: 0.1rem 0.3rem;
          border-radius: 4px;
        }

        .code-toolbar {
          top: 10px;
          right: 10px;
          gap: 8px;
          opacity: 1; /* ç§»åŠ¨ç«¯å§‹ç»ˆæ˜¾ç¤º */
        }

        .language-label {
          padding: 4px 8px;
          font-size: 0.65rem;
          border-radius: 6px;
        }

        .copy-button {
          padding: 5px 10px;
          font-size: 0.7rem;
          border-radius: 8px;
        }

        /* ç§»åŠ¨ç«¯ä¹Ÿå®Œå…¨éšè—æ»šåŠ¨æ¡ */
        .markdown-content pre::-webkit-scrollbar,
        .code-block-container pre::-webkit-scrollbar {
          display: none !important;
          width: 0 !important;
          height: 0 !important;
        }

        .markdown-content pre,
        .code-block-container pre {
          scrollbar-width: none !important;
          -ms-overflow-style: none !important;
        }

        .markdown-content table {
          font-size: 0.85rem;
        }

        .markdown-content th,
        .markdown-content td {
          padding: 0.5rem;
        }

        /* ç§»åŠ¨ç«¯åˆ—è¡¨æ ·å¼ä¼˜åŒ– */
        .markdown-content ul,
        .markdown-content ol {
          padding-left: 1.5rem;
          margin: 0.5rem 0;
        }

        .markdown-content ul li,
        .markdown-content ol li {
          margin: 0.375rem 0;
          padding-left: 1rem;
          font-size: 0.95rem;
        }

        .markdown-content ul li::before {
          font-size: 1.1em;
        }

        .markdown-content ul ul,
        .markdown-content ol ol,
        .markdown-content ul ol,
        .markdown-content ol ul {
          padding-left: 1rem;
        }

        /* è®¾ç½®é¢æ¿ä¸­ç­‰å±å¹•ä¼˜åŒ– */
        .settings-content {
          max-width: 90%;
          width: 90%;
        }

        .settings-header {
          padding: 1.25rem 1.25rem 1rem;
        }

        .settings-body {
          padding: 1.25rem;
        }

        .setting-label {
          min-height: 40px;
        }

        .setting-label input[type='checkbox'] {
          width: 18px;
          height: 18px;
        }

        .btn {
          min-height: 40px;
          padding: 0.625rem 1rem;
        }

        .settings-close-btn {
          min-width: 40px;
          min-height: 40px;
        }
      }

      /* å°å±å¹•æ‰‹æœºé€‚é… */
      @media (max-width: 480px) {
        body {
          padding: 0;
          min-height: 100vh;
          min-height: 100dvh; /* ä½¿ç”¨åŠ¨æ€è§†å£é«˜åº¦ */
          max-height: 100vh;
          max-height: 100dvh;
          overflow-y: auto;
        }

        body.no-content-mode {
          padding: 0;
          height: 100vh;
          height: 100dvh; /* ä½¿ç”¨åŠ¨æ€è§†å£é«˜åº¦ */
          overflow: hidden;
        }

        .container {
          margin: 0;
          border-radius: 0;
          box-shadow: none;
          border: none;
          background: transparent;
          min-height: 100vh;
          min-height: 100dvh;
          display: flex;
          flex-direction: column;
        }

        body.no-content-mode .container {
          margin: 0;
          height: 100vh;
          height: 100dvh;
          max-height: 100vh;
          max-height: 100dvh;
          background: transparent;
          overflow: hidden;
        }

        .header {
          padding: 0.75rem 1rem;
          /* æ·»åŠ iOSå®‰å…¨åŒºåŸŸæ”¯æŒï¼Œç¡®ä¿æ ‡é¢˜ä¸è¢«çŠ¶æ€æ é®æŒ¡ */
          padding-top: max(0.75rem, env(safe-area-inset-top));
          background: transparent;
          border-bottom: none;
          flex-shrink: 0;
        }

        h1 {
          font-size: 1.125rem;
        }

        .content {
          padding: 0.75rem 1rem;
          background: transparent;
          flex: 1;
          overflow-y: auto;
          display: flex;
          flex-direction: column;
        }

        .feedback-group {
          display: flex;
          flex-direction: column;
          height: 100%;
        }

        .description {
          padding: 1rem 1.25rem;
          font-size: 0.9rem;
        }

        .feedback-textarea {
          min-height: 80px;
          max-height: 25vh;
          padding: 0.875rem 1rem;
          font-size: 16px;
          flex-shrink: 0;
        }

        .btn {
          padding: 0.75rem 1.25rem;
          font-size: 0.85rem;
        }

        #no-content-container {
          padding: 1.5rem 1rem !important;
          min-height: 250px !important;
        }

        #no-content-container h2 {
          font-size: 1.25rem !important;
        }

        #no-content-container p {
          font-size: 0.9rem !important;
        }

        /* è¿›åº¦æ¡é€‚é… */
        #no-content-container > div:nth-child(4) {
          width: 160px !important;
          height: 4px !important;
        }

        /* å°å±å¹•åˆ—è¡¨æ ·å¼ä¼˜åŒ– */
        .markdown-content ul,
        .markdown-content ol {
          padding-left: 1.25rem;
          margin: 0.375rem 0;
        }

        .markdown-content ul li,
        .markdown-content ol li {
          margin: 0.3rem 0;
          padding-left: 0;
          font-size: 0.9rem;
        }

        .markdown-content ul li::before {
          font-size: 1em;
        }

        .markdown-content ul ul,
        .markdown-content ol ol,
        .markdown-content ul ol,
        .markdown-content ol ul {
          padding-left: 1.25rem;
        }

        /* è®¾ç½®é¢æ¿ç§»åŠ¨ç«¯ä¼˜åŒ– */
        .settings-panel {
          padding: 0;
          align-items: stretch;
          justify-content: stretch;
        }

        .settings-content {
          max-width: 100%;
          width: 100%;
          height: 100vh;
          height: 100dvh;
          max-height: 100vh;
          max-height: 100dvh;
          margin: 0;
          border-radius: 0;
          border: none;
          background: rgba(30, 30, 40, 0.98);
          display: flex;
          flex-direction: column;
        }

        .settings-header {
          padding: 1rem 1rem 0.75rem;
          position: sticky;
          top: 0;
          background: rgba(30, 30, 40, 0.98);
          z-index: 10;
        }

        .settings-header h3 {
          font-size: 1.1rem;
        }

        .settings-close-btn {
          width: 40px;
          height: 40px;
          min-width: 40px;
          min-height: 40px;
          border-radius: 50%;
        }

        .settings-close-btn::before,
        .settings-close-btn::after {
          width: 16px;
          height: 2.5px;
        }

        .settings-body {
          padding: 1rem;
          padding-bottom: max(1rem, env(safe-area-inset-bottom));
          flex: 1;
          overflow-y: auto;
          max-height: none !important;
          height: auto;
        }

        .settings-main-title {
          font-size: 1.1rem;
          margin-bottom: 1rem;
          padding-bottom: 0.5rem;
        }

        .setting-group {
          margin-bottom: 1.5rem;
          padding: 1rem;
          border-radius: 12px;
        }

        .setting-group-title {
          font-size: 0.95rem;
          margin-bottom: 1rem;
          padding-bottom: 0.5rem;
        }

        .setting-subgroup {
          margin: 1rem 0;
          padding: 0.75rem;
          border-radius: 8px;
          background: rgba(255, 255, 255, 0.01);
        }

        .setting-subgroup-title {
          font-size: 0.85rem;
          margin-bottom: 0.75rem;
          padding-bottom: 0.25rem;
        }

        .setting-item {
          margin-bottom: 0.75rem;
          padding: 0.5rem 0;
          border-radius: 0;
          background: transparent;
          border: none;
        }

        .setting-label {
          gap: 0.75rem;
          margin-bottom: 0;
          min-height: 44px;
          align-items: center;
          padding: 0;
        }

        .setting-label input[type='checkbox'] {
          width: 20px;
          height: 20px;
          min-width: 20px;
          min-height: 20px;
        }

        .setting-title {
          font-size: 1rem;
          line-height: 1.4;
        }

        .setting-description {
          font-size: 0.9rem;
          line-height: 1.4;
          margin-left: 3rem;
        }

        .volume-slider {
          margin: 0 1rem;
          min-height: 44px;
        }

        .btn {
          min-height: 44px;
          padding: 0.75rem 1rem;
          font-size: 0.95rem;
          border-radius: 12px;
        }

        .status-info {
          padding: 0.75rem;
        }

        .status-row {
          margin-bottom: 0.75rem;
          min-height: 44px;
          align-items: center;
        }

        .status-row span {
          font-size: 0.95rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>
          <div class="header-icon">
            <svg width="32" height="32" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="masterBg" x1="50%" y1="0%" x2="50%" y2="100%">
                  <stop offset="0%" class="svg-stop-1" />
                  <stop offset="100%" class="svg-stop-2" />
                </linearGradient>
                <radialGradient id="aiFluidCore" cx="50%" cy="50%" r="70%" fx="52%" fy="48%">
                  <stop offset="0%" class="svg-stop-3" />
                  <stop offset="30%" class="svg-stop-4" />
                  <stop offset="60%" class="svg-stop-5" />
                  <stop offset="100%" class="svg-stop-6" />
                </radialGradient>
                <linearGradient id="interventionControl" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" class="svg-stop-7" />
                  <stop offset="30%" class="svg-stop-8" />
                  <stop offset="70%" class="svg-stop-9" />
                  <stop offset="100%" class="svg-stop-10" />
                </linearGradient>
              </defs>
              <g>
                <rect
                  x="10"
                  y="10"
                  width="100"
                  height="100"
                  rx="22.5"
                  ry="22.5"
                  fill="url(#masterBg)"
                />
              </g>
              <g transform="translate(60,60) scale(0.95)">
                <g>
                  <path
                    id="aiShape"
                    d="M 0 -35
                           Q 30 -35, 30 0
                           Q 30 35, 0 35
                           Q -30 35, -30 0
                           Q -30 -35, 0 -35 Z
                           M 0 -25
                           Q 20 -25, 20 0
                           Q 20 25, 0 25
                           Q -20 25, -20 0
                           Q -20 -25, 0 -25 Z"
                    fill-rule="evenodd"
                    fill="url(#aiFluidCore)"
                    transform="rotate(15)"
                  />
                </g>
                <g transform="translate(0, -1)">
                  <path
                    d="M -15 -22
                           L -7 -22
                           C -5.5 -22, -4.5 -21, -4.5 -19.5
                           L -4.5 19.5
                           C -4.5 21, -5.5 22, -7 22
                           L -15 22
                           C -16.5 22, -17.5 21, -17.5 19.5
                           L -17.5 -19.5
                           C -17.5 -21, -16.5 -22, -15 -22 Z"
                    fill="url(#interventionControl)"
                  />
                  <path
                    d="M 4.5 -22
                           L 12.5 -22
                           C 14 -22, 15 -21, 15 -19.5
                           L 15 19.5
                           C 15 21, 14 22, 12.5 22
                           L 4.5 22
                           C 3 22, 2 21, 2 19.5
                           L 2 -19.5
                           C 2 -21, 3 -22, 4.5 -22 Z"
                    fill="url(#interventionControl)"
                  />
                </g>
              </g>
            </svg>
          </div>
          AI Intervention Agent
        </h1>
        <button class="settings-btn" id="settings-btn" title="é€šçŸ¥è®¾ç½®">âš™ï¸</button>
      </div>

      <!-- ä»»åŠ¡æ ‡ç­¾é¡µ -->
      <div class="task-tabs-container hidden" id="task-tabs-container">
        <div class="task-tabs" id="task-tabs">
          <!-- æ ‡ç­¾é¡µå°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>

      <!-- æ— æœ‰æ•ˆå†…å®¹é¡µé¢ -->
      <div id="no-content-container" class="no-content-container">
        <div class="no-content-icon">â³</div>
        <h2 class="no-content-title">æ— æœ‰æ•ˆå†…å®¹</h2>
        <p class="no-content-description">ç­‰å¾…æ–°çš„åé¦ˆè¯·æ±‚...</p>
        <div class="no-content-progress">
          <div class="no-content-progress-bar"></div>
        </div>
        <div class="button-container no-content-buttons" id="no-content-buttons">
          <button class="btn btn-secondary" id="close-btn">âŒ å…³é—­æœåŠ¡</button>
        </div>
        <!-- æ— å†…å®¹é¡µé¢çš„çŠ¶æ€æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="status-message no-content-status" id="no-content-status-message"></div>
      </div>

      <!-- æ­£å¸¸å†…å®¹é¡µé¢ -->
      <div id="content-container" class="content">
        <div class="feedback-group">
          <!-- Task ID å’Œå€’è®¡æ—¶æ˜¾ç¤ºåŒºåŸŸ -->
          <div class="header-info-container">
            <div class="task-id-container hidden" id="task-id-container">
              <span class="task-id-label">ğŸ“‹ ä»»åŠ¡:</span>
              <span class="task-id-text" id="task-id-text"></span>
            </div>

            <div class="countdown-container hidden" id="countdown-container">
              <span class="countdown-label">â°</span>
              <span class="countdown-text" id="countdown-text">0ç§’åè‡ªåŠ¨é‡æ–°è¯¢é—®</span>
            </div>
          </div>

          <div class="description markdown-content" id="description">åŠ è½½ä¸­...</div>

          <div class="options-container hidden" id="options-container">
            <!-- é¢„å®šä¹‰é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
          </div>

          <div class="separator hidden" id="separator"></div>

          <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
          <div class="image-preview-container hidden" id="image-preview-container">
            <div class="image-preview-header">
              <span class="image-count-text">å·²é€‰æ‹© <span id="image-count">0</span> å¼ å›¾ç‰‡</span>
              <button class="clear-all-images-btn" id="clear-all-images-btn" title="æ¸…é™¤æ‰€æœ‰å›¾ç‰‡">
                ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨
              </button>
            </div>
            <div class="image-previews" id="image-previews">
              <!-- å›¾ç‰‡é¢„è§ˆç¼©ç•¥å›¾å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
            </div>
          </div>

          <!-- æ‹–æ‹½æç¤ºè¦†ç›–å±‚ -->
          <div class="drag-overlay hidden" id="drag-overlay">
            <div class="drag-overlay-content">
              <div class="drag-icon">ğŸ“</div>
              <div class="drag-text">æ‹–æ”¾å›¾ç‰‡åˆ°è¿™é‡Œ</div>
              <div class="drag-subtext">æ”¯æŒ JPGã€PNGã€GIFã€WEBP æ ¼å¼</div>
            </div>
          </div>

          <!-- å›¾ç‰‡æ”¾å¤§é¢„è§ˆæ¨¡æ€æ¡† -->
          <div class="image-modal" id="image-modal">
            <div class="image-modal-content">
              <img id="modal-image" src="" alt="" />
              <button class="image-modal-close" onclick="closeImageModal()">Ã—</button>
              <div class="image-modal-info" id="modal-info"></div>
            </div>
          </div>

          <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ input -->
          <input type="file" id="file-upload-input" multiple accept="image/*" class="hidden" />

          <div class="textarea-container">
            <textarea
              class="feedback-textarea"
              id="feedback-text"
              placeholder="è¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„åé¦ˆå†…å®¹â€¦â€¦"
            ></textarea>
          </div>

          <div class="button-container">
            <button class="btn btn-secondary" id="insert-code-btn">ğŸ“‹ æ’å…¥ä»£ç </button>
            <button class="btn btn-secondary" id="upload-image-btn">ğŸ“· ä¸Šä¼ å›¾ç‰‡</button>
            <button class="btn btn-primary" id="submit-btn">ğŸš€ å‘é€è¯·æ±‚</button>
          </div>

          <div class="status-message" id="status-message"></div>
        </div>
      </div>

      <!-- è®¾ç½®é¢æ¿ -->
      <div class="settings-panel hidden" id="settings-panel">
        <div class="settings-content">
          <div class="settings-header">
            <h3>âš™ï¸ è®¾ç½®</h3>
            <button
              class="settings-close-btn"
              id="settings-close-btn"
              aria-label="å…³é—­è®¾ç½®"
            ></button>
          </div>

          <div class="settings-body">
            <!-- é€šçŸ¥æ ‡é¢˜ -->
            <h4 class="settings-main-title">ğŸ”” é€šçŸ¥</h4>

            <!-- é€šçŸ¥è®¾ç½® -->
            <div class="setting-group">
              <!-- é€šçŸ¥æ€»å¼€å…³ -->
              <div class="setting-item">
                <label class="setting-label">
                  <input type="checkbox" id="notification-enabled" checked />
                  <span class="setting-title">å¯ç”¨é€šçŸ¥åŠŸèƒ½</span>
                </label>
              </div>

              <!-- æ¡Œé¢é€šçŸ¥è®¾ç½® -->
              <div class="setting-subgroup">
                <h5 class="setting-subgroup-title">ğŸŒ æ¡Œé¢é€šçŸ¥</h5>
                <div class="setting-item">
                  <label class="setting-label">
                    <input type="checkbox" id="web-notification-enabled" checked />
                    <span class="setting-title">æ¡Œé¢é€šçŸ¥</span>
                  </label>
                </div>
                <div class="setting-item">
                  <label class="setting-label">
                    <input type="checkbox" id="auto-request-permission" checked />
                    <span class="setting-title">è‡ªåŠ¨è¯·æ±‚é€šçŸ¥æƒé™</span>
                  </label>
                </div>
              </div>

              <!-- å£°éŸ³é€šçŸ¥è®¾ç½® -->
              <div class="setting-subgroup">
                <h5 class="setting-subgroup-title">ğŸ”Š å£°éŸ³é€šçŸ¥</h5>
                <div class="setting-item">
                  <label class="setting-label">
                    <input type="checkbox" id="sound-notification-enabled" checked />
                    <span class="setting-title">å£°éŸ³é€šçŸ¥</span>
                  </label>
                </div>
                <div class="setting-item">
                  <label class="setting-label">
                    <input type="checkbox" id="sound-mute" />
                    <span class="setting-title">é™éŸ³æ¨¡å¼</span>
                  </label>
                </div>
                <div class="setting-item">
                  <label class="setting-label">
                    <span class="setting-title">éŸ³é‡è°ƒèŠ‚</span>
                    <input
                      type="range"
                      id="sound-volume"
                      min="0"
                      max="100"
                      value="80"
                      class="volume-slider"
                    />
                    <span class="volume-value">80%</span>
                  </label>
                </div>
              </div>

              <!-- ç§»åŠ¨è®¾å¤‡é€šçŸ¥è®¾ç½® -->
              <div class="setting-subgroup">
                <h5 class="setting-subgroup-title">ğŸ“± ç§»åŠ¨è®¾å¤‡</h5>
                <div class="setting-item">
                  <label class="setting-label">
                    <input type="checkbox" id="mobile-optimized" checked />
                    <span class="setting-title">ç§»åŠ¨è®¾å¤‡ä¼˜åŒ–</span>
                  </label>
                </div>
                <div class="setting-item">
                  <label class="setting-label">
                    <input type="checkbox" id="mobile-vibrate" checked />
                    <span class="setting-title">éœ‡åŠ¨æé†’</span>
                  </label>
                </div>
              </div>

              <!-- Bark é€šçŸ¥è®¾ç½® -->
              <div class="setting-subgroup">
                <h5 class="setting-subgroup-title">ğŸ Bark é€šçŸ¥ (iOS)</h5>
                <div class="setting-item">
                  <label class="setting-label">
                    <input type="checkbox" id="bark-notification-enabled" />
                    <span class="setting-title">å¯ç”¨ Bark é€šçŸ¥</span>
                  </label>
                </div>
                <div class="setting-item">
                  <label class="setting-label has-input">
                    <span class="setting-title">Bark URL</span>
                    <input
                      type="url"
                      id="bark-url"
                      class="setting-input"
                      placeholder="https://api.day.app/push"
                      value=""
                    />
                  </label>
                </div>
                <div class="setting-item">
                  <label class="setting-label has-input">
                    <span class="setting-title">Device Key</span>
                    <input
                      type="text"
                      id="bark-device-key"
                      class="setting-input"
                      placeholder="è¯·è¾“å…¥æ‚¨çš„ Bark Device Key"
                      value=""
                    />
                  </label>
                </div>
                <div class="setting-item">
                  <label class="setting-label has-input">
                    <span class="setting-title">å›¾æ ‡ URL (å¯é€‰)</span>
                    <input
                      type="url"
                      id="bark-icon"
                      class="setting-input"
                      placeholder="https://example.com/icon.png"
                      value=""
                    />
                  </label>
                </div>
                <div class="setting-item">
                  <label class="setting-label has-input">
                    <span class="setting-title">ç‚¹å‡»è¡Œä¸º</span>
                    <select id="bark-action" class="setting-select">
                      <option value="none">æ— æ“ä½œ</option>
                      <option value="url">æ‰“å¼€é“¾æ¥</option>
                      <option value="copy">å¤åˆ¶å†…å®¹</option>
                    </select>
                  </label>
                </div>
                <div class="setting-item">
                  <button class="btn btn-secondary" id="test-bark-notification-btn">
                    ğŸ§ª æµ‹è¯• Bark é€šçŸ¥
                  </button>
                </div>
              </div>

              <!-- é€šçŸ¥çŠ¶æ€ä¿¡æ¯ -->
              <div class="setting-subgroup">
                <h5 class="setting-subgroup-title">â„¹ï¸ çŠ¶æ€ä¿¡æ¯</h5>
                <div class="status-row">
                  <span>æµè§ˆå™¨æ”¯æŒï¼š</span>
                  <span id="browser-support-status">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="status-row">
                  <span>é€šçŸ¥æƒé™ï¼š</span>
                  <span id="notification-permission-status">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="status-row">
                  <span>éŸ³é¢‘çŠ¶æ€ï¼š</span>
                  <span id="audio-status">æ£€æµ‹ä¸­...</span>
                </div>
              </div>

              <!-- æµ‹è¯•åŠŸèƒ½ -->
              <div class="setting-subgroup">
                <h5 class="setting-subgroup-title">ğŸ§ª æµ‹è¯•åŠŸèƒ½</h5>
                <div class="setting-item">
                  <button class="btn btn-secondary" id="test-notification-btn">ğŸ”” æµ‹è¯•é€šçŸ¥</button>
                </div>
                <div class="setting-item">
                  <button class="btn btn-secondary" id="reset-settings-btn">ğŸ”„ é‡ç½®è®¾ç½®</button>
                </div>
              </div>
            </div>

            <!-- å¸¸ç”¨å¿«æ·é”® -->
            <h4 class="settings-main-title shortcuts-section">âŒ¨ï¸ å¸¸ç”¨å¿«æ·é”®</h4>
            <div class="setting-group shortcuts-section">
              <div class="status-row">
                <span>ğŸš€ æäº¤åé¦ˆï¼š</span>
                <span id="shortcut-submit">Ctrl+Enter</span>
              </div>
              <div class="status-row">
                <span>ğŸ’» æ’å…¥ä»£ç ï¼š</span>
                <span id="shortcut-code">Alt+C</span>
              </div>
              <div class="status-row">
                <span>ğŸ“‹ ç²˜è´´å›¾ç‰‡ï¼š</span>
                <span id="shortcut-paste">Ctrl+V</span>
              </div>
              <div class="status-row">
                <span>ğŸ“· ä¸Šä¼ å›¾ç‰‡ï¼š</span>
                <span id="shortcut-upload">Ctrl+U</span>
              </div>
              <div class="status-row">
                <span>ğŸ—‘ï¸ æ¸…é™¤å›¾ç‰‡ï¼š</span>
                <span id="shortcut-delete">Delete</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- DOM å®‰å…¨å·¥å…·ï¼šé˜²æ­¢ XSS æ”»å‡» (defer: æŒ‰é¡ºåºå¼‚æ­¥åŠ è½½) -->
    <script defer src="/static/js/dom-security.js"></script>

    <!-- ğŸ“‹ å¤šä»»åŠ¡ç®¡ç†æ¨¡å— (defer: æŒ‰é¡ºåºå¼‚æ­¥åŠ è½½ï¼Œä¾èµ– main.js) -->
    <script defer src="/static/js/multi_task.js"></script>

    <script>
      let config = null

      // é«˜æ€§èƒ½markdownæ¸²æŸ“å‡½æ•°
      function renderMarkdownContent(element, htmlContent) {
        // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ¸²æŸ“æ—¶æœº
        requestAnimationFrame(() => {
          if (htmlContent) {
            // æ‰¹é‡DOMæ“ä½œä¼˜åŒ–
            const fragment = document.createDocumentFragment()
            const tempDiv = document.createElement('div')
            tempDiv.innerHTML = htmlContent

            // ç§»åŠ¨æ‰€æœ‰å­èŠ‚ç‚¹åˆ°fragment
            while (tempDiv.firstChild) {
              fragment.appendChild(tempDiv.firstChild)
            }

            // ä¸€æ¬¡æ€§æ›´æ–°DOM
            element.innerHTML = ''
            element.appendChild(fragment)

            // å¤„ç†ä»£ç å—ï¼Œæ·»åŠ å¤åˆ¶æŒ‰é’®
            processCodeBlocks(element)

            // å¤„ç†åˆ é™¤çº¿è¯­æ³•
            processStrikethrough(element)

            // é‡æ–°æ¸²æŸ“ MathJax å…¬å¼
            if (window.MathJax && window.MathJax.typesetPromise) {
              window.MathJax.typesetPromise([element]).catch(err => {
                console.warn('MathJax æ¸²æŸ“å¤±è´¥:', err)
              })
            }
          } else {
            element.textContent = 'åŠ è½½ä¸­...'
          }
        })
      }

      // å¤„ç†ä»£ç å—ï¼Œæ·»åŠ å¤åˆ¶æŒ‰é’®å’Œè¯­è¨€æ ‡è¯†
      function processCodeBlocks(container) {
        const codeBlocks = container.querySelectorAll('pre')

        codeBlocks.forEach(pre => {
          // æ£€æŸ¥æ˜¯å¦å·²ç»è¢«å¤„ç†è¿‡
          if (pre.parentElement && pre.parentElement.classList.contains('code-block-container')) {
            return
          }

          // åˆ›å»ºä»£ç å—å®¹å™¨
          const codeContainer = document.createElement('div')
          codeContainer.className = 'code-block-container'

          // å°† pre å…ƒç´ åŒ…è£…åœ¨å®¹å™¨ä¸­
          pre.parentNode.insertBefore(codeContainer, pre)
          codeContainer.appendChild(pre)

          // æ£€æµ‹è¯­è¨€ç±»å‹
          const codeElement = pre.querySelector('code')
          let language = 'text'
          if (codeElement && codeElement.className) {
            const langMatch = codeElement.className.match(/language-(\w+)/)
            if (langMatch) {
              language = langMatch[1]
            }
          }

          // åˆ›å»ºå·¥å…·æ 
          const toolbar = document.createElement('div')
          toolbar.className = 'code-toolbar'

          // æ·»åŠ è¯­è¨€æ ‡è¯†
          if (language !== 'text') {
            const langLabel = document.createElement('span')
            langLabel.className = 'language-label'
            langLabel.textContent = language.toUpperCase()
            toolbar.appendChild(langLabel)
          }

          // ä½¿ç”¨å®‰å…¨çš„å¤åˆ¶æŒ‰é’®åˆ›å»ºæ–¹æ³•
          const copyButton = DOMSecurity.createCopyButton(pre.textContent || '')

          toolbar.appendChild(copyButton)

          // å°†å·¥å…·æ æ·»åŠ åˆ°å®¹å™¨ä¸­
          codeContainer.appendChild(toolbar)
        })
      }

      // å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿
      async function copyCodeToClipboard(preElement, button) {
        try {
          const codeElement = preElement.querySelector('code')
          const textToCopy = codeElement ? codeElement.textContent : preElement.textContent

          await navigator.clipboard.writeText(textToCopy)

          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          const originalText = button.innerHTML
          button.innerHTML = 'âœ… å·²å¤åˆ¶'
          button.classList.add('copied')

          // 2ç§’åæ¢å¤åŸçŠ¶
          setTimeout(() => {
            button.innerHTML = originalText
            button.classList.remove('copied')
          }, 2000)
        } catch (err) {
          console.error('å¤åˆ¶å¤±è´¥:', err)

          // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
          const originalText = button.innerHTML
          button.innerHTML = 'âŒ å¤åˆ¶å¤±è´¥'

          setTimeout(() => {
            button.innerHTML = originalText
          }, 2000)
        }
      }

      // å¤„ç†åˆ é™¤çº¿è¯­æ³• ~~text~~
      function processStrikethrough(container) {
        // è·å–æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹ï¼Œä½†æ’é™¤ä»£ç å—
        const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, {
          acceptNode: function (node) {
            // æ’é™¤ä»£ç å—ã€preã€script ç­‰æ ‡ç­¾å†…çš„æ–‡æœ¬
            const parent = node.parentElement
            if (
              parent &&
              (parent.tagName === 'CODE' ||
                parent.tagName === 'PRE' ||
                parent.tagName === 'SCRIPT' ||
                parent.tagName === 'STYLE' ||
                parent.closest('pre, code, script, style'))
            ) {
              return NodeFilter.FILTER_REJECT
            }
            return NodeFilter.FILTER_ACCEPT
          }
        })

        const textNodes = []
        let node
        while ((node = walker.nextNode())) {
          textNodes.push(node)
        }

        // å¤„ç†æ¯ä¸ªæ–‡æœ¬èŠ‚ç‚¹
        textNodes.forEach(textNode => {
          const text = textNode.textContent
          // åŒ¹é… ~~åˆ é™¤çº¿~~ è¯­æ³•ï¼Œä½†ä¸åŒ¹é…ä»£ç å—ä¸­çš„
          const strikethroughRegex = /~~([^~\n]+?)~~/g

          if (strikethroughRegex.test(text)) {
            const newHTML = text.replace(strikethroughRegex, '<del>$1</del>')

            // åˆ›å»ºä¸´æ—¶å®¹å™¨æ¥è§£æ HTML
            const tempDiv = document.createElement('div')
            tempDiv.innerHTML = newHTML

            // æ›¿æ¢æ–‡æœ¬èŠ‚ç‚¹
            const fragment = document.createDocumentFragment()
            while (tempDiv.firstChild) {
              fragment.appendChild(tempDiv.firstChild)
            }

            textNode.parentNode.replaceChild(fragment, textNode)
          }
        })
      }

      // åŠ è½½é…ç½®
      async function loadConfig() {
        try {
          const response = await fetch('/api/config')
          config = await response.json()

          // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆå†…å®¹
          if (!config.has_content) {
            showNoContentPage()
            // ä¸å†æ˜¾ç¤ºåŠ¨æ€çŠ¶æ€æ¶ˆæ¯ï¼Œåªä¿ç•™HTMLä¸­çš„å›ºå®šæ–‡æœ¬
            return
          }

          // æ˜¾ç¤ºæ­£å¸¸å†…å®¹é¡µé¢
          showContentPage()

          // é¡µé¢é¦–æ¬¡åŠ è½½ä¸å‘é€é€šçŸ¥ï¼Œåªåœ¨å†…å®¹å˜åŒ–æ—¶é€šçŸ¥

          // æ›´æ–°æè¿° - ä½¿ç”¨é«˜æ€§èƒ½æ¸²æŸ“å‡½æ•°
          const descriptionElement = document.getElementById('description')
          renderMarkdownContent(descriptionElement, config.prompt_html || config.prompt)

          // åŠ è½½é¢„å®šä¹‰é€‰é¡¹
          if (config.predefined_options && config.predefined_options.length > 0) {
            const optionsContainer = document.getElementById('options-container')
            const separator = document.getElementById('separator')

            config.predefined_options.forEach((option, index) => {
              const optionDiv = document.createElement('div')
              optionDiv.className = 'option-item'

              const checkbox = document.createElement('input')
              checkbox.type = 'checkbox'
              checkbox.id = `option-${index}`
              checkbox.value = option

              const label = document.createElement('label')
              label.htmlFor = `option-${index}`
              label.textContent = option

              optionDiv.appendChild(checkbox)
              optionDiv.appendChild(label)
              optionsContainer.appendChild(optionDiv)
            })

            optionsContainer.style.display = 'block'
            separator.style.display = 'block'
          }
        } catch (error) {
          console.error('åŠ è½½é…ç½®å¤±è´¥:', error)
          showStatus('åŠ è½½é…ç½®å¤±è´¥', 'error')
          throw error // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨è€…çŸ¥é“åŠ è½½å¤±è´¥
        }
      }

      // æ˜¾ç¤ºæ— å†…å®¹é¡µé¢
      function showNoContentPage() {
        document.getElementById('content-container').style.display = 'none'
        document.getElementById('no-content-container').style.display = 'flex'

        // æ·»åŠ æ— å†…å®¹æ¨¡å¼çš„CSSç±»ï¼Œå¯ç”¨ç‰¹æ®Šå¸ƒå±€
        document.body.classList.add('no-content-mode')

        // æ˜¾ç¤ºå…³é—­æŒ‰é’®ï¼Œè®©ç”¨æˆ·å¯ä»¥å…³é—­æœåŠ¡
        if (config) {
          document.getElementById('no-content-buttons').style.display = 'block'
        }
      }

      // æ˜¾ç¤ºå†…å®¹é¡µé¢
      function showContentPage() {
        document.getElementById('content-container').style.display = 'block'
        document.getElementById('no-content-container').style.display = 'none'

        // ç§»é™¤æ— å†…å®¹æ¨¡å¼çš„CSSç±»ï¼Œæ¢å¤æ­£å¸¸å¸ƒå±€
        document.body.classList.remove('no-content-mode')

        enableSubmitButton()
      }

      // ç¦ç”¨æäº¤æŒ‰é’®
      function disableSubmitButton() {
        const submitBtn = document.getElementById('submit-btn')
        const insertBtn = document.getElementById('insert-code-btn')
        const feedbackText = document.getElementById('feedback-text')

        if (submitBtn) {
          submitBtn.disabled = true
          submitBtn.style.backgroundColor = '#3a3a3c'
          submitBtn.style.color = '#8e8e93'
          submitBtn.style.cursor = 'not-allowed'
        }
        if (insertBtn) {
          insertBtn.disabled = true
          insertBtn.style.backgroundColor = '#3a3a3c'
          insertBtn.style.color = '#8e8e93'
          insertBtn.style.cursor = 'not-allowed'
        }
        if (feedbackText) {
          feedbackText.disabled = true
          feedbackText.style.backgroundColor = '#2c2c2e'
          feedbackText.style.color = '#8e8e93'
          feedbackText.style.cursor = 'not-allowed'
        }
      }

      // å¯ç”¨æäº¤æŒ‰é’®
      function enableSubmitButton() {
        const submitBtn = document.getElementById('submit-btn')
        const insertBtn = document.getElementById('insert-code-btn')
        const feedbackText = document.getElementById('feedback-text')

        if (submitBtn) {
          submitBtn.disabled = false
          submitBtn.style.backgroundColor = '#0a84ff'
          submitBtn.style.color = '#ffffff'
          submitBtn.style.cursor = 'pointer'
        }
        if (insertBtn) {
          insertBtn.disabled = false
          insertBtn.style.backgroundColor = '#48484a'
          insertBtn.style.color = '#ffffff'
          insertBtn.style.cursor = 'pointer'
        }
        if (feedbackText) {
          feedbackText.disabled = false
          feedbackText.style.backgroundColor = 'rgba(255, 255, 255, 0.03)'
          feedbackText.style.color = '#f5f5f7'
          feedbackText.style.cursor = 'text'
        }
      }

      // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
      function showStatus(message, type) {
        // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨æ— å†…å®¹é¡µé¢
        const isNoContentPage =
          document.getElementById('no-content-container').style.display === 'flex'
        const statusElement = isNoContentPage
          ? document.getElementById('no-content-status-message')
          : document.getElementById('status-message')

        statusElement.textContent = message
        statusElement.className = `status-message status-${type}`
        statusElement.style.display = 'block'

        if (type === 'success') {
          setTimeout(() => {
            statusElement.style.display = 'none'
          }, 3000)
        }
      }

      // æ’å…¥ä»£ç åŠŸèƒ½ - ä¸GUIç‰ˆæœ¬é€»è¾‘å®Œå…¨ä¸€è‡´
      async function insertCodeFromClipboard() {
        try {
          const text = await navigator.clipboard.readText()
          if (text) {
            const textarea = document.getElementById('feedback-text')
            const cursorPos = textarea.selectionStart
            const currentText = textarea.value
            const textBefore = currentText.substring(0, cursorPos)
            const textAfter = currentText.substring(cursorPos)

            // æ„å»ºè¦æ’å…¥çš„ä»£ç å—ï¼Œåœ¨```å‰é¢æ€»æ˜¯æ·»åŠ æ¢è¡Œ
            let codeBlock = `\n\`\`\`\n${text}\n\`\`\``

            // å¦‚æœæ˜¯åœ¨æ–‡æœ¬å¼€å¤´æ’å…¥ï¼Œåˆ™ä¸éœ€è¦å‰é¢çš„æ¢è¡Œ
            if (cursorPos === 0) {
              codeBlock = `\`\`\`\n${text}\n\`\`\``
            }

            // æ’å…¥ä»£ç å—
            textarea.value = textBefore + codeBlock + textAfter

            // å°†å…‰æ ‡ç§»åŠ¨åˆ°ä»£ç å—æœ«å°¾ï¼ˆä¸GUIç‰ˆæœ¬ä¸€è‡´ï¼‰
            const newCursorPos = textBefore.length + codeBlock.length
            textarea.setSelectionRange(newCursorPos, newCursorPos)
            textarea.focus()

            showStatus('ä»£ç å·²æ’å…¥', 'success')
          } else {
            showStatus('å‰ªè´´æ¿ä¸ºç©º', 'error')
          }
        } catch (error) {
          console.error('è¯»å–å‰ªè´´æ¿å¤±è´¥:', error)
          showStatus('æ— æ³•è¯»å–å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´ä»£ç ', 'error')
        }
      }

      // æäº¤åé¦ˆ
      async function submitFeedback() {
        const feedbackText = document.getElementById('feedback-text').value.trim()
        const selectedOptions = []

        // è·å–é€‰ä¸­çš„é¢„å®šä¹‰é€‰é¡¹
        if (config && config.predefined_options) {
          config.predefined_options.forEach((option, index) => {
            const checkbox = document.getElementById(`option-${index}`)
            if (checkbox && checkbox.checked) {
              selectedOptions.push(option)
            }
          })
        }

        if (!feedbackText && selectedOptions.length === 0 && selectedImages.length === 0) {
          // å¦‚æœæ²¡æœ‰ä»»ä½•è¾“å…¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          showStatus('è¯·è¾“å…¥åé¦ˆå†…å®¹ã€é€‰æ‹©é¢„å®šä¹‰é€‰é¡¹æˆ–ä¸Šä¼ å›¾ç‰‡', 'error')
          return
        }

        try {
          const submitBtn = document.getElementById('submit-btn')
          submitBtn.disabled = true
          submitBtn.textContent = 'æäº¤ä¸­...'

          // ä½¿ç”¨ FormData ä¸Šä¼ æ–‡ä»¶ï¼Œé¿å… base64 ç¼–ç 
          const formData = new FormData()
          formData.append('feedback_text', feedbackText)
          formData.append('selected_options', JSON.stringify(selectedOptions))

          // æ·»åŠ å›¾ç‰‡æ–‡ä»¶ï¼ˆç›´æ¥ä½¿ç”¨åŸå§‹æ–‡ä»¶ï¼Œä¸éœ€è¦base64ï¼‰
          selectedImages.forEach((img, index) => {
            if (img.file) {
              formData.append(`image_${index}`, img.file)
            }
          })

          const response = await fetch('/api/submit', {
            method: 'POST',
            body: formData // ä¸è®¾ç½® Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½® multipart/form-data
          })

          const result = await response.json()

          if (response.ok) {
            showStatus(result.message, 'success')

            // åé¦ˆæäº¤æˆåŠŸï¼Œä¸éœ€è¦é€šçŸ¥ï¼ˆç”¨æˆ·è¦æ±‚ï¼‰

            // æ¸…ç©ºè¡¨å•
            document.getElementById('feedback-text').value = ''
            // å–æ¶ˆé€‰ä¸­æ‰€æœ‰å¤é€‰æ¡†
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => (cb.checked = false))
            // æ¸…é™¤æ‰€æœ‰å›¾ç‰‡
            clearAllImages()

            // ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œç„¶åéšè—åé¦ˆå†…å®¹
            if (config) {
              config.has_content = false
              console.log('åé¦ˆæäº¤åï¼Œæœ¬åœ°çŠ¶æ€å·²æ›´æ–°ä¸ºæ— å†…å®¹')
            }
            showNoContentPage()
            // ä¸å†æ˜¾ç¤ºåŠ¨æ€çŠ¶æ€æ¶ˆæ¯ï¼Œåªä¿ç•™HTMLä¸­çš„å›ºå®šæ–‡æœ¬
          } else {
            showStatus(result.message || 'æäº¤å¤±è´¥', 'error')
          }
        } catch (error) {
          console.error('æäº¤å¤±è´¥:', error)
          showStatus('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error')
        } finally {
          const submitBtn = document.getElementById('submit-btn')
          submitBtn.disabled = false
          submitBtn.textContent = 'ğŸš€ æäº¤åé¦ˆ'
        }
      }

      // å…³é—­ç•Œé¢ - ç®€åŒ–ç‰ˆæœ¬ï¼Œç»Ÿä¸€åˆ·æ–°é€»è¾‘
      async function closeInterface() {
        try {
          showStatus('æ­£åœ¨å…³é—­æœåŠ¡...', 'info')

          // åœæ­¢è½®è¯¢
          stopContentPolling()

          const response = await fetch('/api/close', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          })

          const result = await response.json()
          if (response.ok) {
            showStatus('æœåŠ¡å·²å…³é—­ï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...', 'success')
          } else {
            showStatus('å…³é—­å¤±è´¥ï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...', 'error')
          }
        } catch (error) {
          console.error('å…³é—­ç•Œé¢å¤±è´¥:', error)
          showStatus('å…³é—­ç•Œé¢å¤±è´¥ï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...', 'error')
        }

        // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½åœ¨2ç§’ååˆ·æ–°é¡µé¢
        setTimeout(() => {
          refreshPageSafely()
        }, 2000)
      }

      // å®‰å…¨åˆ·æ–°é¡µé¢å‡½æ•°
      function refreshPageSafely() {
        console.log('æ­£åœ¨åˆ·æ–°é¡µé¢...')
        try {
          window.location.reload()
        } catch (reloadError) {
          console.error('é¡µé¢åˆ·æ–°å¤±è´¥:', reloadError)
          // å¦‚æœåˆ·æ–°å¤±è´¥ï¼Œå°è¯•è·³è½¬åˆ°æ ¹è·¯å¾„
          try {
            window.location.href = window.location.origin
          } catch (redirectError) {
            console.error('é¡µé¢è·³è½¬å¤±è´¥:', redirectError)
            // æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šè·³è½¬åˆ°ç©ºç™½é¡µ
            try {
              window.location.href = 'about:blank'
            } catch (blankError) {
              console.error('æ‰€æœ‰é¡µé¢æ“ä½œéƒ½å¤±è´¥:', blankError)
            }
          }
        }
      }

      // æ³¨æ„ï¼šåŸæ¥çš„å¤æ‚å…³é—­é€»è¾‘å·²è¢«ç®€åŒ–ä¸ºç»Ÿä¸€çš„åˆ·æ–°é€»è¾‘

      // å†…å®¹è½®è¯¢æ£€æŸ¥ - å¸¦æŒ‡æ•°é€€é¿ç­–ç•¥
      let pollingTimeout = null
      let currentPollingInterval = 2000 // åˆå§‹é—´éš”2ç§’
      const basePollingInterval = 2000 // åŸºç¡€é—´éš”
      const maxPollingInterval = 30000 // æœ€å¤§é—´éš”30ç§’
      let consecutiveErrors = 0

      function startContentPolling() {
        if (pollingTimeout) {
          console.log('è½®è¯¢å·²ç»åœ¨è¿è¡Œï¼Œè·³è¿‡å¯åŠ¨')
          return // é¿å…é‡å¤å¯åŠ¨
        }

        console.log('å¼€å§‹å¯åŠ¨å†…å®¹è½®è¯¢...')
        scheduleNextPoll()
      }

      function scheduleNextPoll() {
        pollingTimeout = setTimeout(async () => {
          try {
            const response = await fetch('/api/config')

            // æ£€æŸ¥æ˜¯å¦é‡åˆ°é€Ÿç‡é™åˆ¶
            if (response.status === 429) {
              console.warn('é‡åˆ°é€Ÿç‡é™åˆ¶ï¼Œå¢åŠ è½®è¯¢é—´éš”')
              handlePollingError(true)
              return
            }

            const newConfig = await response.json()

            // è¯·æ±‚æˆåŠŸï¼Œé‡ç½®é”™è¯¯è®¡æ•°å’Œé—´éš”
            consecutiveErrors = 0
            currentPollingInterval = basePollingInterval

            const currentHasContent = config ? config.has_content : false
            const newHasContent = newConfig.has_content

            console.log('è½®è¯¢æ£€æŸ¥ - å½“å‰çŠ¶æ€:', currentHasContent, 'æ–°çŠ¶æ€:', newHasContent)
            console.log('å½“å‰æç¤º:', config ? config.prompt?.substring(0, 30) : 'null')
            console.log('æ–°æç¤º:', newConfig.prompt?.substring(0, 30))

            // çŠ¶æ€å˜åŒ–æ£€æµ‹
            if (newHasContent && !currentHasContent) {
              // ä»æ— å†…å®¹çŠ¶æ€å˜ä¸ºæœ‰å†…å®¹çŠ¶æ€
              console.log('âœ… æ£€æµ‹åˆ°æ–°å†…å®¹ï¼Œæ›´æ–°é¡µé¢')

              // å‘é€æ–°å†…å®¹é€šçŸ¥ï¼ˆéé˜»å¡ï¼‰
              try {
                notificationManager
                  .sendNotification('AI Intervention Agent', 'æ–°çš„åé¦ˆè¯·æ±‚å·²åˆ°è¾¾ï¼Œè¯·æŸ¥çœ‹å¹¶å›å¤', {
                    tag: 'new-content',
                    requireInteraction: true,
                    onClick: () => {
                      window.focus()
                      const textarea = document.getElementById('feedback-text')
                      if (textarea) {
                        textarea.focus()
                      }
                    }
                  })
                  .catch(error => {
                    console.warn('å‘é€æ–°å†…å®¹é€šçŸ¥å¤±è´¥:', error)
                  })
              } catch (error) {
                console.warn('é€šçŸ¥åŠŸèƒ½ä¸å¯ç”¨:', error)
              }

              const oldConfig = config
              config = newConfig
              showContentPage()
              updatePageContent(oldConfig)
              showStatus('æ”¶åˆ°æ–°çš„åé¦ˆè¯·æ±‚ï¼', 'success')
            } else if (!newHasContent && currentHasContent) {
              // ä»æœ‰å†…å®¹çŠ¶æ€å˜ä¸ºæ— å†…å®¹çŠ¶æ€
              console.log('ğŸ“ å†…å®¹å·²æ¸…ç©ºï¼Œæ˜¾ç¤ºæ— å†…å®¹é¡µé¢')
              config = newConfig
              showNoContentPage()
              disableSubmitButton()
            } else if (newHasContent && currentHasContent) {
              // éƒ½æœ‰å†…å®¹ï¼Œæ£€æŸ¥å†…å®¹æ˜¯å¦æ›´æ–°
              const promptChanged = newConfig.prompt !== (config ? config.prompt : '')
              const optionsChanged =
                JSON.stringify(newConfig.predefined_options) !==
                JSON.stringify(config ? config.predefined_options : [])

              if (promptChanged || optionsChanged) {
                console.log('ğŸ”„ æ£€æµ‹åˆ°å†…å®¹æ›´æ–°ï¼Œåˆ·æ–°é¡µé¢')

                // å‘é€å†…å®¹æ›´æ–°é€šçŸ¥ï¼ˆéé˜»å¡ï¼‰
                try {
                  notificationManager
                    .sendNotification(
                      'AI Intervention Agent',
                      'åé¦ˆè¯·æ±‚å†…å®¹å·²æ›´æ–°ï¼Œè¯·æŸ¥çœ‹æœ€æ–°å†…å®¹',
                      {
                        tag: 'content-updated',
                        requireInteraction: false
                      }
                    )
                    .catch(error => {
                      console.warn('å‘é€å†…å®¹æ›´æ–°é€šçŸ¥å¤±è´¥:', error)
                    })
                } catch (error) {
                  console.warn('é€šçŸ¥åŠŸèƒ½ä¸å¯ç”¨:', error)
                }

                const oldConfig = config
                config = newConfig
                updatePageContent(oldConfig)
                showStatus('å†…å®¹å·²æ›´æ–°ï¼', 'success')
              }
            } else {
              // éƒ½æ²¡æœ‰å†…å®¹ï¼Œæ›´æ–°é…ç½®ä½†ä¸æ”¹å˜æ˜¾ç¤º
              config = newConfig
            }

            // å®‰æ’ä¸‹ä¸€æ¬¡è½®è¯¢
            scheduleNextPoll()
          } catch (error) {
            console.error('è½®è¯¢é”™è¯¯:', error)
            handlePollingError(false)
          }
        }, currentPollingInterval)

        console.log(`å†…å®¹è½®è¯¢å·²å®‰æ’ï¼Œé—´éš”${currentPollingInterval}ms`)
      }

      function handlePollingError(isRateLimit) {
        consecutiveErrors++

        if (isRateLimit || consecutiveErrors > 1) {
          // æŒ‡æ•°é€€é¿ï¼š2s -> 4s -> 8s -> 16s -> 30s (æœ€å¤§)
          currentPollingInterval = Math.min(
            basePollingInterval * Math.pow(2, consecutiveErrors),
            maxPollingInterval
          )
          console.log(`è½®è¯¢é‡åˆ°é”™è¯¯ï¼Œå¢åŠ é—´éš”åˆ°${currentPollingInterval}ms`)
        }

        // ç»§ç»­è½®è¯¢
        scheduleNextPoll()
      }

      function stopContentPolling() {
        if (pollingTimeout) {
          clearTimeout(pollingTimeout)
          pollingTimeout = null
        }
        // é‡ç½®è½®è¯¢çŠ¶æ€
        currentPollingInterval = basePollingInterval
        consecutiveErrors = 0
      }

      // æ›´æ–°é¡µé¢å†…å®¹
      // oldConfig: å¯é€‰å‚æ•°ï¼Œç”¨äºæ­£ç¡®ä¿å­˜é€‰ä¸­çŠ¶æ€ï¼ˆé¿å…é…ç½®æ›´æ–°æ—¶çŠ¶æ€ä¸¢å¤±ï¼‰
      function updatePageContent(oldConfig = null) {
        if (!config) return

        // æ›´æ–°æç¤ºå†…å®¹ - ä½¿ç”¨é«˜æ€§èƒ½æ¸²æŸ“å‡½æ•°
        const descriptionElement = document.getElementById('description')
        if (descriptionElement) {
          renderMarkdownContent(descriptionElement, config.prompt_html || config.prompt)
        }

        // æ›´æ–°é¢„å®šä¹‰é€‰é¡¹
        const optionsContainer = document.getElementById('options-container')
        if (optionsContainer) {
          // ä¿å­˜å½“å‰é€‰ä¸­çŠ¶æ€ - ä½¿ç”¨æ—§é…ç½®çš„é€‰é¡¹åˆ—è¡¨ï¼ˆå¦‚æœæä¾›ï¼‰
          const selectedStates = []
          const configForSaving = oldConfig || config
          if (configForSaving && configForSaving.predefined_options) {
            configForSaving.predefined_options.forEach((option, index) => {
              const checkbox = document.getElementById(`option-${index}`)
              selectedStates[index] = checkbox ? checkbox.checked : false
            })
          }

          // å®‰å…¨æ¸…ç©ºå®¹å™¨å†…å®¹
          DOMSecurity.clearContent(optionsContainer)

          if (config.predefined_options && config.predefined_options.length > 0) {
            config.predefined_options.forEach((option, index) => {
              // ä½¿ç”¨å®‰å…¨çš„ DOM åˆ›å»ºæ–¹æ³•
              const optionDiv = DOMSecurity.createCheckboxOption(`option-${index}`, option, option)
              optionsContainer.appendChild(optionDiv)

              // æ¢å¤é€‰ä¸­çŠ¶æ€
              const checkbox = document.getElementById(`option-${index}`)
              if (checkbox && selectedStates[index]) {
                checkbox.checked = true
              }
            })
            optionsContainer.style.display = 'block'
            document.getElementById('separator').style.display = 'block'
          } else {
            optionsContainer.style.display = 'none'
            document.getElementById('separator').style.display = 'none'
          }
        }
      }

      // ========== å›¾ç‰‡å¤„ç†åŠŸèƒ½ ==========

      // å›¾ç‰‡ç®¡ç†æ•°ç»„
      let selectedImages = []

      // é€šçŸ¥ç®¡ç†ç³»ç»Ÿ
      class NotificationManager {
        constructor() {
          this.isSupported = 'Notification' in window
          this.permission = this.isSupported ? Notification.permission : 'denied'
          this.audioContext = null
          this.audioBuffers = new Map()
          this.config = {
            enabled: true,
            webEnabled: true,
            soundEnabled: true,
            soundVolume: 0.8,
            soundMute: false,
            autoRequestPermission: true,
            timeout: 5000,
            icon: '/icons/icon.svg',
            mobileOptimized: true,
            mobileVibrate: true
          }
          this.init()
        }

        async init() {
          console.log('åˆå§‹åŒ–é€šçŸ¥ç®¡ç†å™¨...')

          // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
          if (!this.isSupported) {
            console.warn('æµè§ˆå™¨ä¸æ”¯æŒWeb Notification API')
            return
          }

          // è‡ªåŠ¨è¯·æ±‚é€šçŸ¥æƒé™
          if (this.config.autoRequestPermission && this.permission === 'default') {
            await this.requestPermission()
          }

          // åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ
          await this.initAudio()

          console.log('é€šçŸ¥ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ')
        }

        async requestPermission() {
          if (!this.isSupported) {
            console.warn('æµè§ˆå™¨ä¸æ”¯æŒWeb Notification API')
            return false
          }

          try {
            // å…¼å®¹æ—§ç‰ˆæœ¬æµè§ˆå™¨çš„æƒé™è¯·æ±‚æ–¹å¼
            if (Notification.requestPermission.length === 0) {
              // æ–°ç‰ˆæœ¬ - è¿”å›Promise
              this.permission = await Notification.requestPermission()
            } else {
              // æ—§ç‰ˆæœ¬ - ä½¿ç”¨å›è°ƒ
              this.permission = await new Promise(resolve => {
                Notification.requestPermission(resolve)
              })
            }

            console.log(`é€šçŸ¥æƒé™çŠ¶æ€: ${this.permission}`)
            return this.permission === 'granted'
          } catch (error) {
            console.error('è¯·æ±‚é€šçŸ¥æƒé™å¤±è´¥:', error)
            return false
          }
        }

        async initAudio() {
          try {
            // æ£€æŸ¥æµè§ˆå™¨éŸ³é¢‘æ”¯æŒ
            const AudioContextClass =
              window.AudioContext || window.webkitAudioContext || window.mozAudioContext
            if (!AudioContextClass) {
              console.warn('æµè§ˆå™¨ä¸æ”¯æŒWeb Audio API')
              return
            }

            // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆéœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½å¯ç”¨ï¼‰
            this.audioContext = new AudioContextClass()

            // é¢„åŠ è½½é»˜è®¤éŸ³é¢‘æ–‡ä»¶
            await this.loadAudioFile('default', '/sounds/deng[å™”].mp3')

            console.log('éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ')
          } catch (error) {
            console.warn('éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error)
            // é™çº§ï¼šç¦ç”¨éŸ³é¢‘åŠŸèƒ½
            this.config.soundEnabled = false
          }
        }

        async loadAudioFile(name, url) {
          if (!this.audioContext) return false

          try {
            const response = await fetch(url)
            const arrayBuffer = await response.arrayBuffer()
            const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer)
            this.audioBuffers.set(name, audioBuffer)
            console.log(`éŸ³é¢‘æ–‡ä»¶åŠ è½½æˆåŠŸ: ${name}`)
            return true
          } catch (error) {
            console.warn(`éŸ³é¢‘æ–‡ä»¶åŠ è½½å¤±è´¥ ${name}:`, error)
            return false
          }
        }

        async showNotification(title, message, options = {}) {
          if (!this.config.enabled || !this.config.webEnabled) {
            console.log('Webé€šçŸ¥å·²ç¦ç”¨')
            return null
          }

          if (!this.isSupported) {
            console.warn('æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ')
            this.showFallbackNotification(title, message)
            return null
          }

          if (this.permission !== 'granted') {
            console.warn('æ²¡æœ‰é€šçŸ¥æƒé™')
            if (this.config.autoRequestPermission) {
              await this.requestPermission()
              if (this.permission !== 'granted') {
                this.showFallbackNotification(title, message)
                return null
              }
            } else {
              this.showFallbackNotification(title, message)
              return null
            }
          }

          try {
            const notificationOptions = {
              body: message,
              icon: options.icon || this.config.icon,
              badge: options.badge || this.config.icon,
              tag: options.tag || 'ai-intervention-agent',
              requireInteraction: options.requireInteraction || false,
              silent: options.silent || false,
              ...options
            }

            const notification = new Notification(title, notificationOptions)

            // è®¾ç½®è¶…æ—¶è‡ªåŠ¨å…³é—­
            if (this.config.timeout > 0) {
              setTimeout(() => {
                notification.close()
              }, this.config.timeout)
            }

            // ç‚¹å‡»äº‹ä»¶å¤„ç†
            notification.onclick = () => {
              window.focus()
              notification.close()
              if (options.onClick) {
                options.onClick()
              }
            }

            // ç§»åŠ¨è®¾å¤‡éœ‡åŠ¨
            if (this.config.mobileVibrate && 'vibrate' in navigator) {
              navigator.vibrate([200, 100, 200])
            }

            console.log('é€šçŸ¥å·²æ˜¾ç¤º:', title)
            return notification
          } catch (error) {
            console.error('æ˜¾ç¤ºé€šçŸ¥å¤±è´¥:', error)
            return null
          }
        }

        async playSound(soundName = 'default', volume = null, retryCount = 0) {
          if (!this.config.enabled || !this.config.soundEnabled || this.config.soundMute) {
            console.log('å£°éŸ³é€šçŸ¥å·²ç¦ç”¨')
            return false
          }

          if (!this.audioContext) {
            console.warn('éŸ³é¢‘ä¸Šä¸‹æ–‡æœªåˆå§‹åŒ–ï¼Œå°è¯•é™çº§æ–¹æ¡ˆ')
            this.recordFallbackEvent('audio', { reason: 'no_audio_context', soundName })
            return this.playSoundFallback(soundName)
          }

          // æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœè¢«æš‚åœï¼‰
          if (this.audioContext.state === 'suspended') {
            try {
              await this.audioContext.resume()
              console.log('éŸ³é¢‘ä¸Šä¸‹æ–‡å·²æ¢å¤')
            } catch (error) {
              console.warn('æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡å¤±è´¥:', error)
              this.recordFallbackEvent('audio', {
                reason: 'resume_failed',
                error: error.message,
                soundName
              })
              return this.playSoundFallback(soundName)
            }
          }

          const audioBuffer = this.audioBuffers.get(soundName)
          if (!audioBuffer) {
            console.warn(`éŸ³é¢‘æ–‡ä»¶æœªæ‰¾åˆ°: ${soundName}`)
            // å°è¯•åŠ è½½é»˜è®¤éŸ³é¢‘æ–‡ä»¶
            if (soundName !== 'default') {
              console.log('å°è¯•ä½¿ç”¨é»˜è®¤éŸ³é¢‘æ–‡ä»¶')
              return this.playSound('default', volume, retryCount)
            }
            this.recordFallbackEvent('audio', { reason: 'buffer_not_found', soundName })
            return this.playSoundFallback(soundName)
          }

          try {
            const source = this.audioContext.createBufferSource()
            const gainNode = this.audioContext.createGain()

            source.buffer = audioBuffer
            source.connect(gainNode)
            gainNode.connect(this.audioContext.destination)

            // è®¾ç½®éŸ³é‡
            const finalVolume = volume !== null ? volume : this.config.soundVolume
            gainNode.gain.value = Math.max(0, Math.min(1, finalVolume))

            // æ·»åŠ é”™è¯¯å¤„ç†
            source.addEventListener('ended', () => {
              console.log(`å£°éŸ³æ’­æ”¾å®Œæˆ: ${soundName}`)
            })

            source.addEventListener('error', error => {
              console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', error)
              this.recordFallbackEvent('audio', {
                reason: 'playback_error',
                error: error.message,
                soundName
              })
            })

            source.start(0)
            console.log(`æ’­æ”¾å£°éŸ³: ${soundName}`)
            return true
          } catch (error) {
            console.error('æ’­æ”¾å£°éŸ³å¤±è´¥:', error)
            this.recordFallbackEvent('audio', {
              reason: 'playback_failed',
              error: error.message,
              soundName
            })

            // é‡è¯•æœºåˆ¶
            if (retryCount < 2) {
              console.log(`é‡è¯•æ’­æ”¾å£°éŸ³ (${retryCount + 1}/2): ${soundName}`)
              await new Promise(resolve => setTimeout(resolve, 500)) // ç­‰å¾…500msåé‡è¯•
              return this.playSound(soundName, volume, retryCount + 1)
            }

            // é‡è¯•å¤±è´¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ
            return this.playSoundFallback(soundName)
          }
        }

        playSoundFallback(soundName) {
          // éŸ³é¢‘æ’­æ”¾é™çº§æ–¹æ¡ˆ
          console.log(`ä½¿ç”¨éŸ³é¢‘é™çº§æ–¹æ¡ˆ: ${soundName}`)

          try {
            // æ–¹æ¡ˆ1: å°è¯•ä½¿ç”¨HTML5 Audioå…ƒç´ 
            const audio = new Audio(
              `/sounds/${soundName === 'default' ? 'deng[å™”].mp3' : soundName + '.mp3'}`
            )
            audio.volume = this.config.soundVolume

            const playPromise = audio.play()
            if (playPromise !== undefined) {
              playPromise
                .then(() => {
                  console.log('HTML5 Audioæ’­æ”¾æˆåŠŸ')
                })
                .catch(error => {
                  console.warn('HTML5 Audioæ’­æ”¾å¤±è´¥:', error)
                  // æ–¹æ¡ˆ2: ä½¿ç”¨æŒ¯åŠ¨APIï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
                  this.vibrateFallback()
                })
            }
            return true
          } catch (error) {
            console.warn('HTML5 Audioé™çº§å¤±è´¥:', error)
            // æ–¹æ¡ˆ2: ä½¿ç”¨æŒ¯åŠ¨APIï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
            return this.vibrateFallback()
          }
        }

        vibrateFallback() {
          // æŒ¯åŠ¨é™çº§æ–¹æ¡ˆï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
          if (this.config.mobileVibrate && 'vibrate' in navigator) {
            try {
              navigator.vibrate([200, 100, 200]) // æŒ¯åŠ¨æ¨¡å¼ï¼š200msæŒ¯åŠ¨ï¼Œ100msåœæ­¢ï¼Œ200msæŒ¯åŠ¨
              console.log('ä½¿ç”¨æŒ¯åŠ¨æé†’')
              return true
            } catch (error) {
              console.warn('æŒ¯åŠ¨æé†’å¤±è´¥:', error)
            }
          }

          console.log('æ‰€æœ‰éŸ³é¢‘é™çº§æ–¹æ¡ˆéƒ½å¤±è´¥äº†')
          return false
        }

        async sendNotification(title, message, options = {}) {
          const results = []

          // åŒæ—¶æ‰§è¡ŒWebé€šçŸ¥å’ŒéŸ³é¢‘æ’­æ”¾ï¼Œç¡®ä¿åŒæ­¥
          const promises = []

          // æ˜¾ç¤ºWebé€šçŸ¥
          if (this.config.webEnabled) {
            promises.push(
              this.showNotification(title, message, options).then(notification => ({
                type: 'web',
                success: notification !== null
              }))
            )
          }

          // æ’­æ”¾å£°éŸ³
          if (this.config.soundEnabled) {
            promises.push(
              this.playSound(options.sound).then(soundSuccess => ({
                type: 'sound',
                success: soundSuccess
              }))
            )
          }

          // ç­‰å¾…æ‰€æœ‰é€šçŸ¥æ–¹å¼å®Œæˆ
          if (promises.length > 0) {
            try {
              const promiseResults = await Promise.all(promises)
              results.push(...promiseResults)
            } catch (error) {
              console.warn('é€šçŸ¥æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error)
            }
          }

          return results
        }

        showFallbackNotification(title, message, options = {}) {
          // å¢å¼ºçš„é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨å¤šç§æ–¹å¼ç¡®ä¿ç”¨æˆ·èƒ½æ”¶åˆ°é€šçŸ¥
          console.log(`é™çº§é€šçŸ¥: ${title} - ${message}`)

          // 1. å°è¯•ä½¿ç”¨é¡µé¢çŠ¶æ€æ¶ˆæ¯
          if (typeof showStatus === 'function') {
            showStatus(`${title}: ${message}`, 'info')
          }

          // 2. å°è¯•ä½¿ç”¨æµè§ˆå™¨æ ‡é¢˜é—ªçƒ
          this.flashTitle(title)

          // 3. å°è¯•ä½¿ç”¨é¡µé¢å†…å¼¹çª—ï¼ˆå¦‚æœæ²¡æœ‰å…¶ä»–æ–¹å¼ï¼‰
          if (!this.isSupported || this.permission === 'denied') {
            this.showInPageNotification(title, message, options)
          }

          // 4. å°è¯•ä½¿ç”¨æ§åˆ¶å°æ ·å¼è¾“å‡º
          console.log(`%cğŸ”” ${title}`, 'color: #0084ff; font-weight: bold; font-size: 14px;')
          console.log(`%c${message}`, 'color: #666; font-size: 12px;')

          // 5. è®°å½•é™çº§äº‹ä»¶ç”¨äºç»Ÿè®¡
          this.recordFallbackEvent('notification', {
            title,
            message,
            reason: options.reason || 'unknown'
          })
        }

        flashTitle(message) {
          // æ ‡é¢˜é—ªçƒæé†’
          const originalTitle = document.title
          let flashCount = 0
          const maxFlashes = 6

          const flashInterval = setInterval(() => {
            document.title = flashCount % 2 === 0 ? `ğŸ”” ${message}` : originalTitle
            flashCount++

            if (flashCount >= maxFlashes) {
              clearInterval(flashInterval)
              document.title = originalTitle
            }
          }, 1000)
        }

        updateConfig(newConfig) {
          this.config = { ...this.config, ...newConfig }
          console.log('é€šçŸ¥é…ç½®å·²æ›´æ–°:', this.config)
        }

        getStatus() {
          return {
            supported: this.isSupported,
            permission: this.permission,
            audioContext: this.audioContext ? this.audioContext.state : 'unavailable',
            config: this.config
          }
        }

        showInPageNotification(title, message, options = {}) {
          // åˆ›å»ºé¡µé¢å†…é€šçŸ¥å…ƒç´ 
          // ä½¿ç”¨å®‰å…¨çš„é€šçŸ¥åˆ›å»ºæ–¹æ³•
          const notification = DOMSecurity.createNotification(title, message)

          // æ·»åŠ æ ·å¼
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(30, 30, 40, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1rem;
            max-width: 300px;
            z-index: 10000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            color: #f5f5f7;
            font-family: inherit;
          `

          // æ·»åŠ å†…å®¹æ ·å¼
          const titleEl = notification.querySelector('.in-page-notification-title')
          const messageEl = notification.querySelector('.in-page-notification-message')
          const closeEl = notification.querySelector('.in-page-notification-close')

          titleEl.style.cssText = 'font-weight: 600; margin-bottom: 0.5rem; font-size: 1rem;'
          messageEl.style.cssText =
            'font-size: 0.9rem; line-height: 1.4; color: rgba(245, 245, 247, 0.8);'
          closeEl.style.cssText = `
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: rgba(245, 245, 247, 0.6);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
          `

          // æ·»åŠ åˆ°é¡µé¢
          document.body.appendChild(notification)

          // å…³é—­æŒ‰é’®äº‹ä»¶
          closeEl.addEventListener('click', () => {
            notification.style.transform = 'translateX(100%)'
            notification.style.opacity = '0'
            setTimeout(() => {
              if (notification.parentNode) {
                notification.parentNode.removeChild(notification)
              }
            }, 300)
          })

          closeEl.addEventListener('mouseenter', () => {
            closeEl.style.background = 'rgba(255, 255, 255, 0.1)'
            closeEl.style.color = '#f5f5f7'
          })

          closeEl.addEventListener('mouseleave', () => {
            closeEl.style.background = 'none'
            closeEl.style.color = 'rgba(245, 245, 247, 0.6)'
          })

          // å…¥åœºåŠ¨ç”»
          notification.style.transform = 'translateX(100%)'
          notification.style.transition = 'all 0.3s ease-out'
          setTimeout(() => {
            notification.style.transform = 'translateX(0)'
          }, 10)

          // è‡ªåŠ¨å…³é—­
          setTimeout(() => {
            if (notification.parentNode) {
              closeEl.click()
            }
          }, options.timeout || 5000)

          return notification
        }

        recordFallbackEvent(type, data) {
          // è®°å½•é™çº§äº‹ä»¶ç”¨äºåˆ†æå’Œæ”¹è¿›
          const event = {
            type,
            data,
            timestamp: Date.now(),
            userAgent: navigator.userAgent,
            url: window.location.href
          }

          // æ€§èƒ½ä¼˜åŒ–ï¼šå­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨
          try {
            const storageKey = 'ai-intervention-fallback-events'
            const events = JSON.parse(localStorage.getItem(storageKey) || '[]')

            // æ€§èƒ½ä¼˜åŒ–ï¼šæ¸…ç†è¿‡æœŸäº‹ä»¶
            const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000
            const validEvents = events.filter(e => e.timestamp > sevenDaysAgo)

            validEvents.push(event)

            // æ€§èƒ½ä¼˜åŒ–ï¼šåªä¿ç•™æœ€è¿‘50ä¸ªäº‹ä»¶
            if (validEvents.length > 50) {
              validEvents.splice(0, validEvents.length - 50)
            }

            localStorage.setItem(storageKey, JSON.stringify(validEvents))

            // æ€§èƒ½ä¼˜åŒ–ï¼šç›‘æ§å­˜å‚¨ç©ºé—´ä½¿ç”¨
            this.monitorLocalStorageUsage(storageKey)
          } catch (error) {
            console.warn('æ— æ³•è®°å½•é™çº§äº‹ä»¶:', error)
            // å¦‚æœå­˜å‚¨å¤±è´¥ï¼Œå°è¯•æ¸…ç†å­˜å‚¨ç©ºé—´
            this.cleanupLocalStorage()
          }

          if (this.config.debug) {
            console.log('é™çº§äº‹ä»¶è®°å½•:', event)
          }
        }

        // æ€§èƒ½ä¼˜åŒ–ï¼šç›‘æ§ localStorage ä½¿ç”¨æƒ…å†µ
        monitorLocalStorageUsage(key) {
          try {
            const data = localStorage.getItem(key)
            if (data) {
              const sizeInBytes = new Blob([data]).size
              const sizeInKB = (sizeInBytes / 1024).toFixed(2)

              if (sizeInBytes > 100 * 1024) {
                // è¶…è¿‡100KBæ—¶è­¦å‘Š
                console.warn(`localStorageäº‹ä»¶è®°å½•è¿‡å¤§: ${sizeInKB}KBï¼Œå»ºè®®æ¸…ç†`)
              }

              if (this.config.debug) {
                console.log(`localStorageäº‹ä»¶è®°å½•å¤§å°: ${sizeInKB}KB`)
              }
            }
          } catch (error) {
            console.warn('æ— æ³•ç›‘æ§localStorageä½¿ç”¨æƒ…å†µ:', error)
          }
        }

        // æ€§èƒ½ä¼˜åŒ–ï¼šæ¸…ç† localStorage
        cleanupLocalStorage() {
          try {
            const storageKey = 'ai-intervention-fallback-events'
            const events = JSON.parse(localStorage.getItem(storageKey) || '[]')

            // åªä¿ç•™æœ€è¿‘24å°æ—¶çš„äº‹ä»¶
            const oneDayAgo = Date.now() - 24 * 60 * 60 * 1000
            const recentEvents = events.filter(e => e.timestamp > oneDayAgo)

            // è¿›ä¸€æ­¥é™åˆ¶åˆ°æœ€å¤š20ä¸ªäº‹ä»¶
            if (recentEvents.length > 20) {
              recentEvents.splice(0, recentEvents.length - 20)
            }

            localStorage.setItem(storageKey, JSON.stringify(recentEvents))
            console.log(`localStorageæ¸…ç†å®Œæˆï¼Œä¿ç•™ ${recentEvents.length} ä¸ªäº‹ä»¶`)
          } catch (error) {
            console.error('localStorageæ¸…ç†å¤±è´¥:', error)
            // æœ€åæ‰‹æ®µï¼šæ¸…ç©ºäº‹ä»¶è®°å½•
            try {
              localStorage.removeItem('ai-intervention-fallback-events')
              console.log('å·²æ¸…ç©ºlocalStorageäº‹ä»¶è®°å½•')
            } catch (clearError) {
              console.error('æ— æ³•æ¸…ç©ºlocalStorage:', clearError)
            }
          }
        }
      }

      // åˆ›å»ºå…¨å±€é€šçŸ¥ç®¡ç†å™¨å®ä¾‹
      const notificationManager = new NotificationManager()

      // è®¾ç½®ç®¡ç†å™¨
      class SettingsManager {
        constructor() {
          this.storageKey = 'ai-intervention-agent-settings'
          this.defaultSettings = {
            enabled: true,
            webEnabled: true,
            autoRequestPermission: true,
            soundEnabled: true,
            soundMute: false,
            soundVolume: 80,
            mobileOptimized: true,
            mobileVibrate: true,
            barkEnabled: false,
            barkUrl: 'https://api.day.app/push',
            barkDeviceKey: '',
            barkIcon: '',
            barkAction: 'none'
          }
          this.init()
        }

        async init() {
          this.settings = await this.loadSettings()
          this.initEventListeners()
        }

        async loadSettings() {
          try {
            // ä¼˜å…ˆä»æœåŠ¡å™¨åŠ è½½é…ç½®
            const response = await fetch('/api/get-notification-config')
            if (response.ok) {
              const result = await response.json()
              if (result.status === 'success') {
                // å°†æœåŠ¡å™¨é…ç½®æ˜ å°„åˆ°å‰ç«¯æ ¼å¼
                const serverConfig = result.config
                const settings = {
                  enabled: serverConfig.enabled ?? this.defaultSettings.enabled,
                  webEnabled: serverConfig.web_enabled ?? this.defaultSettings.webEnabled,
                  autoRequestPermission:
                    serverConfig.auto_request_permission ??
                    this.defaultSettings.autoRequestPermission,
                  soundEnabled: serverConfig.sound_enabled ?? this.defaultSettings.soundEnabled,
                  soundMute: serverConfig.sound_mute ?? this.defaultSettings.soundMute,
                  soundVolume: serverConfig.sound_volume ?? this.defaultSettings.soundVolume,
                  mobileOptimized:
                    serverConfig.mobile_optimized ?? this.defaultSettings.mobileOptimized,
                  mobileVibrate: serverConfig.mobile_vibrate ?? this.defaultSettings.mobileVibrate,
                  barkEnabled: serverConfig.bark_enabled ?? this.defaultSettings.barkEnabled,
                  barkUrl: serverConfig.bark_url ?? this.defaultSettings.barkUrl,
                  barkDeviceKey: serverConfig.bark_device_key ?? this.defaultSettings.barkDeviceKey,
                  barkIcon: serverConfig.bark_icon ?? this.defaultSettings.barkIcon,
                  barkAction: serverConfig.bark_action ?? this.defaultSettings.barkAction
                }
                console.log('ä»æœåŠ¡å™¨åŠ è½½é…ç½®æˆåŠŸ')
                return settings
              }
            }
          } catch (error) {
            console.warn('ä»æœåŠ¡å™¨åŠ è½½é…ç½®å¤±è´¥ï¼Œå°è¯•localStorage:', error)
          }

          // å›é€€åˆ°localStorage
          try {
            const stored = localStorage.getItem(this.storageKey)
            if (stored) {
              const parsed = JSON.parse(stored)
              return { ...this.defaultSettings, ...parsed }
            }
          } catch (error) {
            console.warn('åŠ è½½è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®:', error)
          }
          return { ...this.defaultSettings }
        }

        saveSettings() {
          try {
            localStorage.setItem(this.storageKey, JSON.stringify(this.settings))
            console.log('è®¾ç½®å·²ä¿å­˜')
          } catch (error) {
            console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error)
          }
        }

        updateSetting(key, value) {
          this.settings[key] = value
          this.saveSettings()
          this.applySettings()
          console.log(`è®¾ç½®å·²æ›´æ–°: ${key} = ${value}`)
        }

        applySettings() {
          // æ›´æ–°å‰ç«¯é€šçŸ¥ç®¡ç†å™¨é…ç½®
          if (notificationManager) {
            notificationManager.updateConfig({
              enabled: this.settings.enabled,
              webEnabled: this.settings.webEnabled,
              autoRequestPermission: this.settings.autoRequestPermission,
              soundEnabled: this.settings.soundEnabled,
              soundMute: this.settings.soundMute,
              soundVolume: this.settings.soundVolume / 100,
              mobileOptimized: this.settings.mobileOptimized,
              mobileVibrate: this.settings.mobileVibrate,
              barkEnabled: this.settings.barkEnabled,
              barkUrl: this.settings.barkUrl,
              barkDeviceKey: this.settings.barkDeviceKey,
              barkIcon: this.settings.barkIcon,
              barkAction: this.settings.barkAction
            })
          }

          // åŒæ­¥é…ç½®åˆ°åç«¯
          this.syncConfigToBackend()
        }

        async syncConfigToBackend() {
          try {
            const response = await fetch('/api/update-notification-config', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(this.settings)
            })

            const result = await response.json()
            if (response.ok && result.status === 'success') {
              console.log('åç«¯é€šçŸ¥é…ç½®å·²åŒæ­¥')
            } else {
              console.warn('åŒæ­¥åç«¯é…ç½®å¤±è´¥:', result.message)
            }
          } catch (error) {
            console.error('åŒæ­¥åç«¯é…ç½®å¤±è´¥:', error)
          }
        }

        resetSettings() {
          this.settings = { ...this.defaultSettings }
          this.saveSettings()
          this.updateUI()
          this.applySettings()
          console.log('è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼')
        }

        updateUI() {
          // æ›´æ–°è®¾ç½®é¢æ¿ä¸­çš„æ§ä»¶çŠ¶æ€
          document.getElementById('notification-enabled').checked = this.settings.enabled
          document.getElementById('web-notification-enabled').checked = this.settings.webEnabled
          document.getElementById('auto-request-permission').checked =
            this.settings.autoRequestPermission
          document.getElementById('sound-notification-enabled').checked = this.settings.soundEnabled
          document.getElementById('sound-mute').checked = this.settings.soundMute
          document.getElementById('sound-volume').value = this.settings.soundVolume
          document.querySelector('.volume-value').textContent = `${this.settings.soundVolume}%`
          document.getElementById('mobile-optimized').checked = this.settings.mobileOptimized
          document.getElementById('mobile-vibrate').checked = this.settings.mobileVibrate

          // æ›´æ–° Bark è®¾ç½®
          document.getElementById('bark-notification-enabled').checked = this.settings.barkEnabled
          document.getElementById('bark-url').value = this.settings.barkUrl
          document.getElementById('bark-device-key').value = this.settings.barkDeviceKey
          document.getElementById('bark-icon').value = this.settings.barkIcon
          document.getElementById('bark-action').value = this.settings.barkAction
        }

        updateStatus() {
          // æ›´æ–°çŠ¶æ€ä¿¡æ¯
          const browserSupport = notificationManager.isSupported ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'
          const permission =
            notificationManager.permission === 'granted'
              ? 'âœ… å·²æˆæƒ'
              : notificationManager.permission === 'denied'
              ? 'âŒ å·²æ‹’ç»'
              : 'âš ï¸ æœªè¯·æ±‚'

          // éŸ³é¢‘çŠ¶æ€ä¸­æ–‡åŒ–
          let audioState = 'âŒ ä¸å¯ç”¨'
          if (notificationManager.audioContext) {
            const state = notificationManager.audioContext.state
            switch (state) {
              case 'running':
                audioState = 'âœ… è¿è¡Œä¸­'
                break
              case 'suspended':
                audioState = 'â¸ï¸ å·²æš‚åœ'
                break
              case 'closed':
                audioState = 'âŒ å·²å…³é—­'
                break
              default:
                audioState = `âš ï¸ ${state}`
            }
          }

          document.getElementById('browser-support-status').textContent = browserSupport
          document.getElementById('notification-permission-status').textContent = permission
          document.getElementById('audio-status').textContent = audioState
        }

        initEventListeners() {
          // è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
          document.addEventListener('click', e => {
            if (e.target.id === 'settings-btn') {
              this.showSettings()
            } else if (e.target.id === 'settings-close-btn') {
              this.hideSettings()
            } else if (e.target.id === 'test-notification-btn') {
              this.testNotification()
            } else if (e.target.id === 'test-bark-notification-btn') {
              this.testBarkNotification()
            } else if (e.target.id === 'reset-settings-btn') {
              this.resetSettings()
            }
          })

          // è®¾ç½®é¢æ¿èƒŒæ™¯ç‚¹å‡»å…³é—­
          document.addEventListener('click', e => {
            if (e.target.id === 'settings-panel') {
              this.hideSettings()
            }
          })

          // è®¾ç½®é¡¹å˜æ›´äº‹ä»¶
          document.addEventListener('change', e => {
            const settingMap = {
              'notification-enabled': 'enabled',
              'web-notification-enabled': 'webEnabled',
              'auto-request-permission': 'autoRequestPermission',
              'sound-notification-enabled': 'soundEnabled',
              'sound-mute': 'soundMute',
              'mobile-optimized': 'mobileOptimized',
              'mobile-vibrate': 'mobileVibrate',
              'bark-notification-enabled': 'barkEnabled'
            }

            if (settingMap[e.target.id]) {
              this.updateSetting(settingMap[e.target.id], e.target.checked)
            } else if (e.target.id === 'sound-volume') {
              this.updateSetting('soundVolume', parseInt(e.target.value))
              document.querySelector('.volume-value').textContent = `${e.target.value}%`
            } else if (e.target.id === 'bark-url') {
              this.updateSetting('barkUrl', e.target.value)
            } else if (e.target.id === 'bark-device-key') {
              this.updateSetting('barkDeviceKey', e.target.value)
            } else if (e.target.id === 'bark-icon') {
              this.updateSetting('barkIcon', e.target.value)
            } else if (e.target.id === 'bark-action') {
              this.updateSetting('barkAction', e.target.value)
            }
          })
        }

        showSettings() {
          this.updateUI()
          this.updateStatus()
          // åŒæ­¥å½“å‰è®¾ç½®åˆ°åç«¯
          this.syncConfigToBackend()
          document.getElementById('settings-panel').style.display = 'flex'
        }

        hideSettings() {
          document.getElementById('settings-panel').style.display = 'none'
        }

        async testNotification() {
          try {
            await notificationManager.sendNotification(
              'è®¾ç½®æµ‹è¯•',
              'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯å½“å‰è®¾ç½®æ˜¯å¦æ­£å¸¸å·¥ä½œ',
              {
                tag: 'settings-test',
                requireInteraction: false
              }
            )
            showStatus('æµ‹è¯•é€šçŸ¥å·²å‘é€', 'success')
          } catch (error) {
            console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:', error)
            showStatus('æµ‹è¯•é€šçŸ¥å¤±è´¥: ' + error.message, 'error')
          }
        }

        async testBarkNotification() {
          try {
            if (!this.settings.barkEnabled) {
              showStatus('è¯·å…ˆå¯ç”¨ Bark é€šçŸ¥', 'warning')
              return
            }

            if (!this.settings.barkUrl || !this.settings.barkDeviceKey) {
              showStatus('è¯·å…ˆé…ç½® Bark URL å’Œ Device Key', 'warning')
              return
            }

            // æ˜¾ç¤ºå‘é€ä¸­çŠ¶æ€
            showStatus('æ­£åœ¨å‘é€ Bark æµ‹è¯•é€šçŸ¥...', 'info')

            // é€šè¿‡åç«¯APIå‘é€Barké€šçŸ¥ï¼Œé¿å…CORSé—®é¢˜
            const response = await fetch('/api/test-bark', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                bark_url: this.settings.barkUrl,
                bark_device_key: this.settings.barkDeviceKey,
                bark_icon: this.settings.barkIcon,
                bark_action: this.settings.barkAction
              })
            })

            const result = await response.json()

            if (response.ok && result.status === 'success') {
              showStatus(result.message, 'success')
              console.log('Bark é€šçŸ¥å‘é€æˆåŠŸ:', result)
            } else {
              showStatus(result.message || 'Bark é€šçŸ¥å‘é€å¤±è´¥', 'error')
              console.error('Bark é€šçŸ¥å‘é€å¤±è´¥:', result)
            }
          } catch (error) {
            console.error('Bark æµ‹è¯•é€šçŸ¥å¤±è´¥:', error)
            showStatus('Bark æµ‹è¯•é€šçŸ¥å¤±è´¥: ' + error.message, 'error')
          }
        }
      }

      // åˆ›å»ºå…¨å±€è®¾ç½®ç®¡ç†å™¨å®ä¾‹
      const settingsManager = new SettingsManager()

      // æ€§èƒ½ä¼˜åŒ–å·¥å…·å‡½æ•°

      // é˜²æŠ–å‡½æ•°
      function debounce(func, wait) {
        let timeout
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout)
            func(...args)
          }
          clearTimeout(timeout)
          timeout = setTimeout(later, wait)
        }
      }

      // èŠ‚æµå‡½æ•°
      function throttle(func, limit) {
        let inThrottle
        return function (...args) {
          if (!inThrottle) {
            func.apply(this, args)
            inThrottle = true
            setTimeout(() => (inThrottle = false), limit)
          }
        }
      }

      // RAFä¼˜åŒ–çš„æ›´æ–°å‡½æ•°
      function rafUpdate(callback) {
        if (window.requestAnimationFrame) {
          requestAnimationFrame(callback)
        } else {
          setTimeout(callback, 16) // é™çº§ä¸º60fps
        }
      }

      // æ”¯æŒçš„å›¾ç‰‡æ ¼å¼
      const SUPPORTED_IMAGE_TYPES = [
        'image/jpeg',
        'image/jpg',
        'image/png',
        'image/gif',
        'image/webp',
        'image/bmp',
        'image/svg+xml'
      ]
      const MAX_IMAGE_SIZE = 10 * 1024 * 1024 // 10MB
      const MAX_IMAGE_COUNT = 10
      const MAX_IMAGE_DIMENSION = 1920 // æœ€å¤§å®½åº¦æˆ–é«˜åº¦
      const COMPRESS_QUALITY = 0.8 // å‹ç¼©è´¨é‡ (0.1-1.0)

      // éªŒè¯å›¾ç‰‡æ–‡ä»¶
      function validateImageFile(file) {
        const errors = []

        // åŸºç¡€æ–‡ä»¶æ£€æŸ¥
        if (!file || !file.type) {
          errors.push('æ— æ•ˆçš„æ–‡ä»¶å¯¹è±¡')
          return errors
        }

        // æ–‡ä»¶ç±»å‹éªŒè¯
        if (!SUPPORTED_IMAGE_TYPES.includes(file.type)) {
          errors.push(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${file.type}`)
        }

        // æ–‡ä»¶å¤§å°éªŒè¯
        if (file.size > MAX_IMAGE_SIZE) {
          errors.push(`æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶: ${(file.size / 1024 / 1024).toFixed(2)}MB > 10MB`)
        }

        // æ–‡ä»¶åéªŒè¯ï¼ˆé˜²æ­¢XSSï¼‰
        if (file.name && file.name.length > 255) {
          errors.push('æ–‡ä»¶åè¿‡é•¿')
        }

        // åŸºæœ¬å®‰å…¨æ£€æŸ¥
        const suspiciousExtensions = [
          '.exe',
          '.bat',
          '.cmd',
          '.scr',
          '.com',
          '.pif',
          '.vbs',
          '.js',
          '.jar'
        ]
        if (suspiciousExtensions.some(ext => file.name.toLowerCase().endsWith(ext))) {
          errors.push('æ£€æµ‹åˆ°å¯ç–‘æ–‡ä»¶ç±»å‹')
        }

        return errors
      }

      // å®‰å…¨çš„æ–‡ä»¶åæ¸…ç†
      function sanitizeFileName(fileName) {
        return fileName
          .replace(/[<>:"/\\|?*]/g, '') // ç§»é™¤ç‰¹æ®Šå­—ç¬¦
          .replace(/\s+/g, '_') // ç©ºæ ¼æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
          .trim()
          .substring(0, 100) // é™åˆ¶é•¿åº¦
      }

      // æ³¨æ„ï¼šå·²ç§»é™¤ fileToBase64 å‡½æ•°ï¼Œç°åœ¨ç›´æ¥ä½¿ç”¨æ–‡ä»¶å¯¹è±¡ä¸Šä¼ 

      // æ”¹è¿›çš„å†…å­˜ç®¡ç†è·Ÿè¸ªï¼šé˜²æ­¢å†…å­˜æ³„æ¼
      let objectURLs = new Set()
      let urlToFileMap = new WeakMap() // ä½¿ç”¨WeakMapè·Ÿè¸ªURLä¸æ–‡ä»¶çš„å…³è”
      let urlCreationTime = new Map() // è·Ÿè¸ªURLåˆ›å»ºæ—¶é—´ï¼Œç”¨äºè‡ªåŠ¨æ¸…ç†

      // åˆ›å»ºå®‰å…¨çš„Object URL
      function createObjectURL(file) {
        try {
          const url = URL.createObjectURL(file)
          objectURLs.add(url)
          urlToFileMap.set(file, url)
          urlCreationTime.set(url, Date.now())

          // è®¾ç½®è‡ªåŠ¨æ¸…ç†å®šæ—¶å™¨ï¼ˆ30åˆ†é’Ÿåè‡ªåŠ¨æ¸…ç†ï¼‰
          setTimeout(() => {
            if (objectURLs.has(url)) {
              console.warn(`è‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„URLå¯¹è±¡: ${url}`)
              revokeObjectURL(url)
            }
          }, 30 * 60 * 1000) // 30åˆ†é’Ÿ

          return url
        } catch (error) {
          console.error('åˆ›å»ºObject URLå¤±è´¥:', error)
          return null
        }
      }

      // æ¸…ç†Object URL
      function revokeObjectURL(url) {
        if (!url) return

        try {
          if (objectURLs.has(url)) {
            URL.revokeObjectURL(url)
            objectURLs.delete(url)
            urlCreationTime.delete(url)
            console.debug(`å·²æ¸…ç†URLå¯¹è±¡: ${url}`)
          }
        } catch (error) {
          console.error('æ¸…ç†URLå¯¹è±¡å¤±è´¥:', error)
        }
      }

      // æ¸…ç†æ‰€æœ‰Object URLs
      function cleanupAllObjectURLs() {
        console.log(`å¼€å§‹æ¸…ç† ${objectURLs.size} ä¸ªURLå¯¹è±¡`)
        const startTime = performance.now()

        objectURLs.forEach(url => {
          try {
            URL.revokeObjectURL(url)
          } catch (error) {
            console.error(`æ¸…ç†URLå¤±è´¥: ${url}`, error)
          }
        })

        objectURLs.clear()
        urlCreationTime.clear()

        const endTime = performance.now()
        console.log(`URLå¯¹è±¡æ¸…ç†å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`)
      }

      // å®šæœŸæ¸…ç†è¿‡æœŸçš„URLå¯¹è±¡ï¼ˆæ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
      function startPeriodicCleanup() {
        setInterval(() => {
          const now = Date.now()
          const expiredUrls = []

          urlCreationTime.forEach((creationTime, url) => {
            // æ¸…ç†è¶…è¿‡20åˆ†é’Ÿçš„URLå¯¹è±¡
            if (now - creationTime > 20 * 60 * 1000) {
              expiredUrls.push(url)
            }
          })

          if (expiredUrls.length > 0) {
            console.log(`å®šæœŸæ¸…ç† ${expiredUrls.length} ä¸ªè¿‡æœŸURLå¯¹è±¡`)
            expiredUrls.forEach(url => revokeObjectURL(url))
          }
        }, 5 * 60 * 1000) // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
      }

      // ä¼˜åŒ–çš„å›¾ç‰‡å‹ç¼©å‡½æ•°
      function compressImage(file) {
        return new Promise(resolve => {
          // SVG å›¾ç‰‡å’Œ GIF ä¸è¿›è¡Œå‹ç¼©
          if (file.type === 'image/svg+xml' || file.type === 'image/gif') {
            resolve(file)
            return
          }

          // å¤§æ–‡ä»¶ä½¿ç”¨åˆ†æ­¥å‹ç¼©
          const isLargeFile = file.size > 5 * 1024 * 1024 // 5MB

          const canvas = document.createElement('canvas')
          const ctx = canvas.getContext('2d', {
            alpha: file.type === 'image/png',
            willReadFrequently: false
          })
          const img = new Image()

          const objectURL = createObjectURL(file)

          img.onload = () => {
            // è®¡ç®—å‹ç¼©åçš„å°ºå¯¸
            let { width, height } = img
            const originalArea = width * height

            // å¤§å›¾ç‰‡ä½¿ç”¨æ›´æ¿€è¿›çš„å‹ç¼©
            let maxDimension = MAX_IMAGE_DIMENSION
            if (isLargeFile || originalArea > 4000000) {
              // 4MP
              maxDimension = Math.min(MAX_IMAGE_DIMENSION, 1200)
            }

            if (width > maxDimension || height > maxDimension) {
              const ratio = Math.min(maxDimension / width, maxDimension / height)
              width = Math.floor(width * ratio)
              height = Math.floor(height * ratio)
            }

            canvas.width = width
            canvas.height = height

            // ä¼˜åŒ–çš„ç»˜åˆ¶è®¾ç½®
            ctx.imageSmoothingEnabled = true
            ctx.imageSmoothingQuality = 'high'

            // ä½¿ç”¨RAFè¿›è¡Œéé˜»å¡ç»˜åˆ¶
            rafUpdate(() => {
              ctx.drawImage(img, 0, 0, width, height)

              // æ ¹æ®æ–‡ä»¶å¤§å°è°ƒæ•´å‹ç¼©è´¨é‡
              let quality = COMPRESS_QUALITY
              if (isLargeFile) {
                quality = Math.max(0.6, COMPRESS_QUALITY - 0.2)
              }

              // è½¬æ¢ä¸º Blob
              canvas.toBlob(
                blob => {
                  // æ¸…ç†èµ„æº
                  revokeObjectURL(objectURL)

                  if (blob && blob.size < file.size) {
                    const compressedFile = new File([blob], file.name, {
                      type: file.type,
                      lastModified: file.lastModified
                    })
                    console.log(
                      `å›¾ç‰‡å‹ç¼©: ${file.name} ${(file.size / 1024).toFixed(2)}KB â†’ ${(
                        blob.size / 1024
                      ).toFixed(2)}KB (å‹ç¼©ç‡: ${((1 - blob.size / file.size) * 100).toFixed(1)}%)`
                    )
                    resolve(compressedFile)
                  } else {
                    resolve(file)
                  }
                },
                file.type === 'image/png' ? 'image/png' : 'image/jpeg',
                quality
              )
            })
          }

          img.onerror = () => {
            revokeObjectURL(objectURL)
            resolve(file)
          }

          img.src = objectURL
        })
      }

      // æ·»åŠ å›¾ç‰‡åˆ°åˆ—è¡¨
      async function addImageToList(file) {
        // éªŒè¯å›¾ç‰‡æ•°é‡
        if (selectedImages.length >= MAX_IMAGE_COUNT) {
          showStatus(`æœ€å¤šåªèƒ½ä¸Šä¼  ${MAX_IMAGE_COUNT} å¼ å›¾ç‰‡`, 'error')
          return false
        }

        // éªŒè¯æ–‡ä»¶
        const errors = validateImageFile(file)
        if (errors.length > 0) {
          showStatus(errors.join('; '), 'error')
          return false
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡ç›¸åŒæ–‡ä»¶
        const isDuplicate = selectedImages.some(
          img =>
            img.name === file.name &&
            img.size === file.size &&
            img.lastModified === file.lastModified
        )
        if (isDuplicate) {
          showStatus('è¯¥å›¾ç‰‡å·²ç»æ·»åŠ è¿‡äº†', 'error')
          return false
        }

        try {
          // åˆ›å»ºåŠ è½½å ä½ç¬¦
          const imageId = Date.now() + Math.random()
          const timestamp = Date.now()
          const imageItem = {
            id: imageId,
            file: file,
            name: file.name,
            size: file.size,
            base64: null,
            timestamp: timestamp,
            lastModified: file.lastModified
          }

          selectedImages.push(imageItem)
          renderImagePreview(imageItem, true) // trueè¡¨ç¤ºæ˜¾ç¤ºåŠ è½½çŠ¶æ€
          updateImageCounter()

          // å‹ç¼©å›¾ç‰‡ï¼ˆå¦‚æœéœ€è¦ï¼‰
          const processedFile = await compressImage(file)

          // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
          imageItem.file = processedFile
          imageItem.size = processedFile.size

          // åˆ›å»ºå®‰å…¨çš„é¢„è§ˆ URL
          const previewUrl = createObjectURL(processedFile)
          if (previewUrl) {
            imageItem.previewUrl = previewUrl
          } else {
            throw new Error('åˆ›å»ºé¢„è§ˆURLå¤±è´¥')
          }

          // æ›´æ–°é¢„è§ˆ
          renderImagePreview(imageItem, false)

          console.log('å›¾ç‰‡æ·»åŠ æˆåŠŸ:', file.name, `(${(imageItem.size / 1024).toFixed(2)}KB)`)
          return true
        } catch (error) {
          console.error('å›¾ç‰‡å¤„ç†å¤±è´¥:', error)
          showStatus('å›¾ç‰‡å¤„ç†å¤±è´¥: ' + error.message, 'error')
          // ä»åˆ—è¡¨ä¸­ç§»é™¤å¤±è´¥çš„å›¾ç‰‡
          selectedImages = selectedImages.filter(img => img.id !== imageId)
          updateImageCounter()
          return false
        }
      }

      // æ‰¹é‡DOMæ›´æ–°é˜Ÿåˆ—
      let domUpdateQueue = []
      let domUpdateScheduled = false

      // æ‰¹é‡å¤„ç†DOMæ›´æ–°
      function scheduleDOMUpdate(callback) {
        domUpdateQueue.push(callback)
        if (!domUpdateScheduled) {
          domUpdateScheduled = true
          rafUpdate(() => {
            const fragment = document.createDocumentFragment()
            domUpdateQueue.forEach(callback => callback(fragment))
            domUpdateQueue = []
            domUpdateScheduled = false
          })
        }
      }

      // ä¼˜åŒ–çš„å›¾ç‰‡é¢„è§ˆæ¸²æŸ“
      function renderImagePreview(imageItem, isLoading = false) {
        rafUpdate(() => {
          const previewContainer = document.getElementById('image-previews')
          let previewElement = document.getElementById(`preview-${imageItem.id}`)

          if (!previewElement) {
            previewElement = document.createElement('div')
            previewElement.id = `preview-${imageItem.id}`
            previewElement.className = 'image-preview-item'
            previewContainer.appendChild(previewElement)
          }

          // ä½¿ç”¨å®‰å…¨çš„å›¾ç‰‡é¢„è§ˆåˆ›å»ºæ–¹æ³•
          const newPreviewElement = DOMSecurity.createImagePreview(imageItem, isLoading)
          DOMSecurity.replaceContent(
            previewElement,
            newPreviewElement.firstChild || newPreviewElement
          )

          if (!isLoading && imageItem.previewUrl) {
            // å»¶è¿ŸåŠ è½½å›¾ç‰‡ä»¥ä¼˜åŒ–æ€§èƒ½
            const img = new Image()
            img.onload = () => {
              rafUpdate(() => {
                const updatedPreviewElement = DOMSecurity.createImagePreview(imageItem, false)
                DOMSecurity.replaceContent(
                  previewElement,
                  updatedPreviewElement.firstChild || updatedPreviewElement
                )
              })
            }
            img.src = imageItem.previewUrl
          }
        })
      }

      // æ–‡æœ¬å®‰å…¨åŒ–å‡½æ•°ï¼Œé˜²æ­¢XSS
      function sanitizeText(text) {
        const div = document.createElement('div')
        div.textContent = text
        return div.innerHTML
      }

      // åˆ é™¤å›¾ç‰‡
      function removeImage(imageId) {
        // æ‰¾åˆ°è¦åˆ é™¤çš„å›¾ç‰‡å¹¶å®‰å…¨é‡Šæ”¾ URL
        const imageToRemove = selectedImages.find(img => img.id == imageId)
        if (
          imageToRemove &&
          imageToRemove.previewUrl &&
          imageToRemove.previewUrl.startsWith('blob:')
        ) {
          revokeObjectURL(imageToRemove.previewUrl)
        }

        selectedImages = selectedImages.filter(img => img.id != imageId)
        const previewElement = document.getElementById(`preview-${imageId}`)
        if (previewElement) {
          previewElement.remove()
        }
        updateImageCounter()
        updateImagePreviewVisibility()
      }

      // æ¸…é™¤æ‰€æœ‰å›¾ç‰‡
      function clearAllImages() {
        // æ¸…ç†å†…å­˜ä¸­çš„ Object URLs
        selectedImages.forEach(img => {
          if (img.previewUrl && img.previewUrl.startsWith('blob:')) {
            revokeObjectURL(img.previewUrl)
          }
        })

        selectedImages = []
        const previewContainer = document.getElementById('image-previews')
        // å®‰å…¨æ¸…ç©ºå®¹å™¨å†…å®¹
        DOMSecurity.clearContent(previewContainer)
        updateImageCounter()
        updateImagePreviewVisibility()

        // å¼ºåˆ¶åƒåœ¾å›æ”¶æç¤ºï¼ˆä»…åœ¨å¼€å‘ç¯å¢ƒï¼‰
        if (window.gc && typeof window.gc === 'function') {
          setTimeout(() => window.gc(), 1000)
        }

        console.log('æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤ï¼Œå†…å­˜å·²é‡Šæ”¾')
      }

      // é¡µé¢å¸è½½æ—¶çš„æ¸…ç†
      function cleanupOnUnload() {
        cleanupAllObjectURLs()
        clearAllImages()
      }

      // ç›‘å¬é¡µé¢å¸è½½äº‹ä»¶
      window.addEventListener('beforeunload', cleanupOnUnload)
      window.addEventListener('pagehide', cleanupOnUnload)

      // æ›´æ–°å›¾ç‰‡è®¡æ•°
      function updateImageCounter() {
        const countElement = document.getElementById('image-count')
        if (countElement) {
          countElement.textContent = selectedImages.length
        }
      }

      // æ›´æ–°å›¾ç‰‡é¢„è§ˆåŒºåŸŸå¯è§æ€§
      function updateImagePreviewVisibility() {
        const container = document.getElementById('image-preview-container')
        if (selectedImages.length > 0) {
          container.style.display = 'block'
        } else {
          container.style.display = 'none'
        }
      }

      // ä¼˜åŒ–çš„æ‰¹é‡æ–‡ä»¶å¤„ç†
      async function handleFileUpload(files) {
        const fileArray = Array.from(files)
        const maxConcurrent = 3 // é™åˆ¶å¹¶å‘å¤„ç†æ•°é‡
        let processed = 0
        let successful = 0

        // æ˜¾ç¤ºæ‰¹é‡å¤„ç†è¿›åº¦
        if (fileArray.length > 1) {
          showStatus(`æ­£åœ¨å¤„ç† ${fileArray.length} ä¸ªæ–‡ä»¶...`, 'info')
        }

        // åˆ†æ‰¹å¤„ç†æ–‡ä»¶ï¼Œé¿å…å†…å­˜æº¢å‡º
        for (let i = 0; i < fileArray.length; i += maxConcurrent) {
          const batch = fileArray.slice(i, i + maxConcurrent)

          const batchPromises = batch.map(async file => {
            try {
              const success = await addImageToList(file)
              if (success) successful++
              processed++

              // æ›´æ–°è¿›åº¦
              if (fileArray.length > 1) {
                showStatus(`å¤„ç†è¿›åº¦: ${processed}/${fileArray.length}`, 'info')
              }

              return success
            } catch (error) {
              console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:', file.name, error)
              processed++
              return false
            }
          })

          // ç­‰å¾…å½“å‰æ‰¹æ¬¡å®Œæˆ
          await Promise.all(batchPromises)

          // æ‰¹æ¬¡é—´æ·»åŠ å°å»¶è¿Ÿï¼Œé¿å…é˜»å¡UI
          if (i + maxConcurrent < fileArray.length) {
            await new Promise(resolve => setTimeout(resolve, 50))
          }
        }

        updateImagePreviewVisibility()

        // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
        if (fileArray.length > 1) {
          showStatus(
            `å®Œæˆå¤„ç†: ${successful}/${fileArray.length} ä¸ªæ–‡ä»¶æˆåŠŸ`,
            successful > 0 ? 'success' : 'error'
          )
        } else if (fileArray.length === 1) {
          showStatus(
            successful > 0 ? 'æ–‡ä»¶å¤„ç†æˆåŠŸ' : 'æ–‡ä»¶å¤„ç†å¤±è´¥',
            successful > 0 ? 'success' : 'error'
          )
        }
      }

      // ä¼˜åŒ–çš„æ‹–æ”¾åŠŸèƒ½å®ç°
      function initializeDragAndDrop() {
        const textarea = document.getElementById('feedback-text')
        const dragOverlay = document.getElementById('drag-overlay')
        let dragCounter = 0
        let dragTimer = null

        // é˜»æ­¢é»˜è®¤çš„æ‹–æ”¾è¡Œä¸º
        ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          document.addEventListener(eventName, preventDefaults, { passive: false })
        })

        function preventDefaults(e) {
          e.preventDefault()
          e.stopPropagation()
        }

        // èŠ‚æµçš„æ‹–æ‹½å¤„ç†å‡½æ•°
        const throttledDragEnter = throttle(e => {
          dragCounter++
          if (e.dataTransfer.types.includes('Files')) {
            rafUpdate(() => {
              dragOverlay.style.display = 'flex'
              textarea.classList.add('textarea-drag-over')
            })
          }
        }, 100)

        const throttledDragLeave = throttle(e => {
          dragCounter--
          if (dragCounter <= 0) {
            dragCounter = 0
            clearTimeout(dragTimer)
            dragTimer = setTimeout(() => {
              rafUpdate(() => {
                dragOverlay.style.display = 'none'
                textarea.classList.remove('textarea-drag-over')
              })
            }, 100)
          }
        }, 50)

        const throttledDragOver = throttle(e => {
          if (e.dataTransfer.types.includes('Files')) {
            e.dataTransfer.dropEffect = 'copy'
          }
        }, 50)

        // æ‹–æ‹½äº‹ä»¶ç›‘å¬
        document.addEventListener('dragenter', throttledDragEnter)
        document.addEventListener('dragleave', throttledDragLeave)
        document.addEventListener('dragover', throttledDragOver)

        // æ‹–æ‹½æ”¾ä¸‹
        document.addEventListener('drop', function (e) {
          dragCounter = 0
          clearTimeout(dragTimer)

          rafUpdate(() => {
            dragOverlay.style.display = 'none'
            textarea.classList.remove('textarea-drag-over')
          })

          if (e.dataTransfer.files.length > 0) {
            // éªŒè¯æ–‡ä»¶æ•°é‡é™åˆ¶
            const totalFiles = selectedImages.length + e.dataTransfer.files.length
            if (totalFiles > MAX_IMAGE_COUNT) {
              showStatus(`æœ€å¤šåªèƒ½ä¸Šä¼  ${MAX_IMAGE_COUNT} å¼ å›¾ç‰‡`, 'error')
              return
            }

            handleFileUpload(e.dataTransfer.files)
          }
        })
      }

      // ç²˜è´´åŠŸèƒ½å®ç°
      function initializePasteFunction() {
        document.addEventListener('paste', async function (e) {
          const clipboardData = e.clipboardData
          if (!clipboardData) return

          const items = Array.from(clipboardData.items)
          const imageItems = items.filter(item => item.type.startsWith('image/'))

          if (imageItems.length > 0) {
            e.preventDefault() // é˜»æ­¢é»˜è®¤ç²˜è´´è¡Œä¸º

            for (const item of imageItems) {
              const file = item.getAsFile()
              if (file) {
                await addImageToList(file)
              }
            }

            updateImagePreviewVisibility()
            showStatus(`ä»å‰ªè´´æ¿æ·»åŠ äº† ${imageItems.length} å¼ å›¾ç‰‡`, 'success')
          }
        })
      }

      // æ–‡ä»¶é€‰æ‹©åŠŸèƒ½
      function initializeFileSelection() {
        const fileInput = document.getElementById('file-upload-input')
        const uploadBtn = document.getElementById('upload-image-btn')

        uploadBtn.addEventListener('click', () => {
          fileInput.click()
        })

        fileInput.addEventListener('change', e => {
          if (e.target.files.length > 0) {
            handleFileUpload(e.target.files)
            // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤é€‰æ‹©ç›¸åŒæ–‡ä»¶
            e.target.value = ''
          }
        })
      }

      // å›¾ç‰‡æ¨¡æ€æ¡†åŠŸèƒ½
      function openImageModal(base64, name, size) {
        const modal = document.getElementById('image-modal')
        const modalImage = document.getElementById('modal-image')
        const modalInfo = document.getElementById('modal-info')

        modalImage.src = base64
        modalImage.alt = name
        modalInfo.textContent = `${name} (${(size / 1024).toFixed(2)}KB)`

        modal.classList.add('show')

        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
        document.addEventListener('keydown', handleModalKeydown)

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        modal.addEventListener('click', function (e) {
          if (e.target === modal) {
            closeImageModal()
          }
        })
      }

      function closeImageModal() {
        const modal = document.getElementById('image-modal')
        modal.classList.remove('show')

        // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬
        document.removeEventListener('keydown', handleModalKeydown)
      }

      function handleModalKeydown(event) {
        if (event.key === 'Escape') {
          closeImageModal()
        }
      }

      // ç§»åŠ¨è®¾å¤‡æ£€æµ‹
      function isMobileDevice() {
        return (
          /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
            navigator.userAgent
          ) ||
          (navigator.maxTouchPoints &&
            navigator.maxTouchPoints > 2 &&
            /MacIntel/.test(navigator.platform))
        )
      }

      // å¹³å°æ£€æµ‹å’Œå¿«æ·é”®è®¾ç½®
      function detectPlatform() {
        const platform = navigator.platform.toLowerCase()
        const userAgent = navigator.userAgent.toLowerCase()

        if (platform.includes('mac') || userAgent.includes('mac')) {
          return 'mac'
        } else if (platform.includes('win') || userAgent.includes('win')) {
          return 'windows'
        } else if (platform.includes('linux') || userAgent.includes('linux')) {
          return 'linux'
        }
        return 'windows' // é»˜è®¤ä¸ºWindows
      }

      function getShortcutText(platform) {
        const shortcuts = {
          mac: [
            'ğŸš€ âŒ˜+Enter  æäº¤åé¦ˆ',
            'ğŸ’» âŒ¥+C      æ’å…¥ä»£ç ',
            'ğŸ“‹ âŒ˜+V      ç²˜è´´å›¾ç‰‡',
            'ğŸ“· âŒ˜+U      ä¸Šä¼ å›¾ç‰‡',
            'ğŸ—‘ï¸ Delete   æ¸…é™¤å›¾ç‰‡'
          ],
          windows: [
            'ğŸš€ Ctrl+Enter æäº¤åé¦ˆ',
            'ğŸ’» Alt+C      æ’å…¥ä»£ç ',
            'ğŸ“‹ Ctrl+V     ç²˜è´´å›¾ç‰‡',
            'ğŸ“· Ctrl+U     ä¸Šä¼ å›¾ç‰‡',
            'ğŸ—‘ï¸ Delete     æ¸…é™¤å›¾ç‰‡'
          ],
          linux: [
            'ğŸš€ Ctrl+Enter æäº¤åé¦ˆ',
            'ğŸ’» Alt+C      æ’å…¥ä»£ç ',
            'ğŸ“‹ Ctrl+V     ç²˜è´´å›¾ç‰‡',
            'ğŸ“· Ctrl+U     ä¸Šä¼ å›¾ç‰‡',
            'ğŸ—‘ï¸ Delete     æ¸…é™¤å›¾ç‰‡'
          ]
        }

        const lines = shortcuts[platform] || shortcuts.windows
        return lines.join('\n')
      }

      function initializeShortcutTooltip() {
        // æ¡Œé¢è®¾å¤‡æ˜¾ç¤ºå¿«æ·é”®ä¿¡æ¯
        if (!isMobileDevice()) {
          const platform = detectPlatform()
          updateShortcutDisplay(platform)
          console.log(`æ£€æµ‹åˆ°æ¡Œé¢å¹³å°: ${platform}ï¼Œå·²è®¾ç½®å¯¹åº”å¿«æ·é”®`)
        } else {
          console.log('æ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡ï¼Œå·²éšè—å¿«æ·é”®éƒ¨åˆ†')
        }
      }

      function updateShortcutDisplay(platform) {
        const isMac = platform === 'mac'
        const ctrlOrCmd = isMac ? 'Cmd' : 'Ctrl'
        const altOrOption = isMac ? 'Option' : 'Alt'

        // æ›´æ–°å„ä¸ªå¿«æ·é”®æ˜¾ç¤º
        const shortcuts = {
          'shortcut-submit': `${ctrlOrCmd}+Enter`,
          'shortcut-code': `${altOrOption}+C`,
          'shortcut-paste': `${ctrlOrCmd}+V`,
          'shortcut-upload': `${ctrlOrCmd}+U`,
          'shortcut-delete': 'Delete'
        }

        Object.entries(shortcuts).forEach(([id, shortcut]) => {
          const element = document.getElementById(id)
          if (element) {
            element.textContent = shortcut
          }
        })
      }

      // æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹
      function checkBrowserCompatibility() {
        const features = {
          fileAPI: !!(window.File && window.FileReader && window.FileList && window.Blob),
          dragDrop: 'ondragstart' in document.createElement('div'),
          canvas: !!document.createElement('canvas').getContext,
          webWorker: !!window.Worker,
          requestAnimationFrame: !!(
            window.requestAnimationFrame || window.webkitRequestAnimationFrame
          ),
          objectURL: !!(window.URL && window.URL.createObjectURL),
          clipboard: !!(navigator.clipboard && navigator.clipboard.read)
        }

        console.log('æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹:', features)

        // å…³é”®åŠŸèƒ½æ£€æŸ¥
        if (!features.fileAPI) {
          showStatus('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶APIï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨', 'warning')
          return false
        }

        if (!features.canvas) {
          showStatus('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒCanvasï¼Œå›¾ç‰‡å‹ç¼©åŠŸèƒ½å°†è¢«ç¦ç”¨', 'warning')
        }

        return true
      }

      // ç‰¹æ€§é™çº§å¤„ç†
      function setupFeatureFallbacks() {
        // RAFé™çº§
        if (!window.requestAnimationFrame) {
          window.requestAnimationFrame =
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame ||
            window.oRequestAnimationFrame ||
            window.msRequestAnimationFrame ||
            function (callback) {
              return setTimeout(callback, 16)
            }
        }

        // å¤åˆ¶APIé™çº§
        if (!navigator.clipboard) {
          console.warn('å‰ªè´´æ¿APIä¸å¯ç”¨ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ')
        }

        // Object.assigné™çº§
        if (!Object.assign) {
          Object.assign = function (target, ...sources) {
            sources.forEach(source => {
              if (source) {
                Object.keys(source).forEach(key => {
                  target[key] = source[key]
                })
              }
            })
            return target
          }
        }
      }

      // åˆå§‹åŒ–å›¾ç‰‡åŠŸèƒ½
      function initializeImageFeatures() {
        // å…¼å®¹æ€§æ£€æŸ¥
        if (!checkBrowserCompatibility()) {
          console.error('æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥å¤±è´¥')
          return
        }

        // è®¾ç½®é™çº§å¤„ç†
        setupFeatureFallbacks()

        try {
          initializeDragAndDrop()
          initializePasteFunction()
          initializeFileSelection()

          // æ¸…é™¤æ‰€æœ‰å›¾ç‰‡æŒ‰é’®äº‹ä»¶
          const clearBtn = document.getElementById('clear-all-images-btn')
          if (clearBtn) {
            clearBtn.addEventListener('click', clearAllImages)
          }

          console.log('å›¾ç‰‡åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ')
        } catch (error) {
          console.error('å›¾ç‰‡åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥:', error)
          showStatus('å›¾ç‰‡åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error')
        }
      }

      // äº‹ä»¶ç›‘å¬å™¨
      document.addEventListener('DOMContentLoaded', () => {
        loadConfig()
          .then(() => {
            // åœ¨é…ç½®åŠ è½½å®Œæˆåå¯åŠ¨è½®è¯¢
            console.log('âœ… é…ç½®åŠ è½½å®Œæˆï¼Œå¯åŠ¨å†…å®¹è½®è¯¢æ£€æŸ¥...')
            console.log('å½“å‰é…ç½®:', {
              has_content: config.has_content,
              persistent: config.persistent,
              prompt_length: config.prompt ? config.prompt.length : 0
            })
            startContentPolling()

            // åˆå§‹åŒ–å¤šä»»åŠ¡æ”¯æŒ
            if (typeof initMultiTaskSupport === 'function') {
              initMultiTaskSupport()
            }
          })
          .catch(error => {
            console.error('âŒ é…ç½®åŠ è½½å¤±è´¥:', error)
            // å³ä½¿é…ç½®åŠ è½½å¤±è´¥ï¼Œä¹Ÿå°è¯•å¯åŠ¨è½®è¯¢ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼‰
            setTimeout(() => {
              console.log('ğŸ”„ é…ç½®åŠ è½½å¤±è´¥ï¼Œå»¶è¿Ÿå¯åŠ¨è½®è¯¢...')
              startContentPolling()

              // åˆå§‹åŒ–å¤šä»»åŠ¡æ”¯æŒ
              if (typeof initMultiTaskSupport === 'function') {
                initMultiTaskSupport()
              }
            }, 3000)
          })

        // åˆå§‹åŒ–å›¾ç‰‡åŠŸèƒ½
        initializeImageFeatures()

        // å¯åŠ¨ URL å¯¹è±¡å®šæœŸæ¸…ç†
        startPeriodicCleanup()

        // åˆå§‹åŒ–å¿«æ·é”®æç¤º
        initializeShortcutTooltip()

        // åˆå§‹åŒ–é€šçŸ¥ç®¡ç†å™¨
        notificationManager
          .init()
          .then(() => {
            console.log('é€šçŸ¥ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ')
            // åº”ç”¨è®¾ç½®ç®¡ç†å™¨çš„é…ç½®
            settingsManager.applySettings()
          })
          .catch(error => {
            console.warn('é€šçŸ¥ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:', error)
          })

        // æŒ‰é’®äº‹ä»¶
        document
          .getElementById('insert-code-btn')
          .addEventListener('click', insertCodeFromClipboard)
        document.getElementById('submit-btn').addEventListener('click', submitFeedback)
        document.getElementById('close-btn').addEventListener('click', closeInterface)

        // é”®ç›˜å¿«æ·é”® - æ”¯æŒè·¨å¹³å°
        document.addEventListener('keydown', event => {
          const isMac = detectPlatform() === 'mac'
          const ctrlOrCmd = isMac ? event.metaKey : event.ctrlKey
          const altOrOption = isMac ? event.altKey : event.altKey

          if (ctrlOrCmd && event.key === 'Enter') {
            event.preventDefault()
            submitFeedback()
          } else if (altOrOption && event.key === 'c') {
            event.preventDefault()
            insertCodeFromClipboard()
          } else if (ctrlOrCmd && event.key === 'v') {
            // Ctrl/Cmd+V ç²˜è´´å›¾ç‰‡ - æµè§ˆå™¨é»˜è®¤å¤„ç†ï¼Œæˆ‘ä»¬åªåœ¨pasteäº‹ä»¶ä¸­å¤„ç†
            console.log(`å¿«æ·é”®: ${isMac ? 'Cmd' : 'Ctrl'}+V ç²˜è´´`)
          } else if (ctrlOrCmd && event.key === 'u') {
            event.preventDefault()
            document.getElementById('upload-image-btn').click()
            console.log(`å¿«æ·é”®: ${isMac ? 'Cmd' : 'Ctrl'}+U ä¸Šä¼ å›¾ç‰‡`)
          } else if (event.key === 'Delete' && selectedImages.length > 0) {
            event.preventDefault()
            clearAllImages()
            console.log('å¿«æ·é”®: Delete æ¸…é™¤æ‰€æœ‰å›¾ç‰‡')
          } else if (ctrlOrCmd && event.shiftKey && event.key === 'N') {
            // Ctrl+Shift+N æµ‹è¯•é€šçŸ¥
            event.preventDefault()
            testNotification()
            console.log(`å¿«æ·é”®: ${isMac ? 'Cmd' : 'Ctrl'}+Shift+N æµ‹è¯•é€šçŸ¥`)
          }
        })

        // ç”¨æˆ·é¦–æ¬¡äº¤äº’æ—¶å¯ç”¨éŸ³é¢‘ä¸Šä¸‹æ–‡
        function enableAudioOnFirstInteraction() {
          if (
            notificationManager.audioContext &&
            notificationManager.audioContext.state === 'suspended'
          ) {
            notificationManager.audioContext
              .resume()
              .then(() => {
                console.log('éŸ³é¢‘ä¸Šä¸‹æ–‡å·²å¯ç”¨')
              })
              .catch(error => {
                console.warn('å¯ç”¨éŸ³é¢‘ä¸Šä¸‹æ–‡å¤±è´¥:', error)
              })
          }
        }

        // æ·»åŠ é¦–æ¬¡äº¤äº’ç›‘å¬å™¨
        document.addEventListener('click', enableAudioOnFirstInteraction, { once: true })
        document.addEventListener('keydown', enableAudioOnFirstInteraction, { once: true })
        document.addEventListener('touchstart', enableAudioOnFirstInteraction, { once: true })

        // æµ‹è¯•é€šçŸ¥åŠŸèƒ½
        async function testNotification() {
          try {
            await notificationManager.sendNotification(
              'é€šçŸ¥æµ‹è¯•',
              'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯é€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ',
              {
                tag: 'test-notification',
                requireInteraction: false
              }
            )
            showStatus('æµ‹è¯•é€šçŸ¥å·²å‘é€', 'success')
          } catch (error) {
            console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:', error)
            showStatus('æµ‹è¯•é€šçŸ¥å¤±è´¥', 'error')
          }
        }
      })
    </script>
  </body>
</html>
